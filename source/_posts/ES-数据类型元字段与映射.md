---
title: ES 数据类型、元字段与映射
date: 2018-11-03 16:29:00
tags:
  - ElasticSearch
categories: ElasticSearch
comments: true
---

在 ES 中所有的字段都是由映射规则所控制，这将输入的数据信息转化成对应的数据格式来进行索引或保存。配置合理的映射规则有助于维护文档，增加操作效率。在了解映射相关配置之前需要了解一下 ES 的数据类型和元字段的意义。

### 字段类型 ###
- ***text***  
文本类型，十分常用的类型，通常作用于需要被全文检索的字段上。这样的字段内容会被分词器拆成词项后生成倒排索引，它不用于排序，也很少用于聚合。
- ***keyword***  
关键字类型，通常用于索引结构化的字段（通常意义明确，用于过滤），这样的字段只能被精确搜索。
- ***number***  
数字类型，这是一个概括。其中包含了 `byte`，`short`，`integer`，`long`，`float`，`double`，`half_float`，`scaled_float`。除了和 Java 类似的数字类型以外，还有相对于 `float` 精度折半的 `half_float`，以及将浮点数进行缩放后存储的 `scaled_float`。**字段长度越短，空间分配越合理，搜索效率越高**。注意在浮点数中 `+0.0` 与 `-0.0` 是**不同**的存在。
```
# 设置某字段为 scaling_float，缩放因子 100
# 适合存储精确至小数点后两位的数字，底层对数字扩大 100 做整形存储
# 而对 API 为 float 型
PUT /<索引>
{
  "mappings": {
    "<类型>": {
      "properties": {
        "<字段名称A>": {
          "type": "scaled_float",
          "scaling_factor": 100
        }
      } 
    }
  }
}
```
- ***date***  
日期类型，ES 支持日期格式化后的字符串、从 epoch 开始的毫秒数（长整型）、从 epoch 开始的秒数（整形），在 ES 内部，**日期都会转化为 UTC 时间并存储为从 epoch 开始的毫秒数**。在开启动态映射的时候如果有新的字段被添加，默认会自动进行日期检测以判断是否该字段为日期类型（可以被关闭，将某类型的 `date_detection` 选项设置为 *false*）。同时日期格式也支持自定义（通过制定字段的 `format` 选项，默认为 *strict\_date\_optional\_time || epoch\_millis*），除了 *yyyy-MM-dd HH:mm:ss* 这样的个性格式，其他预置的格式枚举很多，详情查看官方文档。
- ***boolean***  
布尔类型，只接受 `true` 和 `false`。
- ***binary***  
二进制类型，该类型字段仅接受 **Base64** 编码后的字符串，字段默认不存储（store=false）也不搜索。
- ***array***  
数组类型，其本身是其他类型。数组中的所有值**必须为统一类型**（可以包含 null），而空数组由于无法确定类型会被作为 missing field 对待。在动态映射时，第一个加入数组的元素会决定整个数组的数据类型。
- ***object***  
对象类型。在 JSON 中，对象是可以包含层级关系的，但是在 ES 中复合的对象会被**扁平化处理**，成为简单的 k-v 键值对。如果需要在建立索引时进行静态映射，mappings 支持 object 的显示映射。
- ***nested***  
嵌套对象，这是 object 类型的特例，支持 object 对象数据的独立索引和查询（ES 在使用对象类型的数组时由于扁平化处理会导致一些索引问题）。当指定了 nested 类型进行索引某个字段时，该字段会内容会作为**独立的隐藏文档**存在。这样支持了嵌套对象的索引，但是由于类似结构化数据的关联查询一般，**nested 字段越多，搜索越复杂**，所以每个索引可以使用嵌套对象被限制在 50。
- ***geo\_point***  
地理坐标，用来精确存储地理经纬信息的类型，支持 4 中写入方式：
    - 经纬坐标字符串，如：`"40.3,116.17"`
    - 经纬坐标键值对，如：`{"lat": 40.3, "lon": 116.17}`
    - 地理位置哈希值，如：`"drm3btev3e86"`
    - 经纬坐标数组，如：`[40.3, 116.17]`
- ***geo\_shape***  
地理区块，使用 GeoJSON 对区块进行编码，描述一块地理区域，支持点线面等多种特征。一下列举集中典型表达，更多使用方案参数 GeoJSON 相关文档：  
  
GeoJSON 类型 | ES 类型 | 说明 
:----------:|:-----------:|:-----------:
Point|point|精确坐标点
LineString|linestring|线条，多个点组成
Polygon|polygon|封闭多边形，多个点组成
MultiPoint|multipoint|多个不连续但可能关联的点
MultiLineString|multilinestring|多条不关联的线
MultiPolygon|MultiPolygon|多个不关联的多边形
GeometryCollection|geometrycollection|集合对象集合，可以包括点线面
N/A|envelope|由左上右下坐标确定的封闭矩形
N/A|circle|圆心和半径确定的圆，单位米  
在使用 geo\_shape 类型之后，插入文档时指定字段必须明确 Geo 类型和数据，如：
```
PUT /<索引>/<类型>/<编号>
{
  "<geo_shape字段>"：{
    "type": "linestring",
    "coordinates": [[40.3, 116.17], [31.3, 116.17]]
  }
}
```
- ***ip***  
ip 类型，可以保存 ip 地址，支持 IPv4 及 IPv6，以及无类型域间选路格式
- ***range***  
范围类型，支持 `integer_range`，`long_range`，`float_range`，`double_range`，`date_rage`。其中日期区间以毫秒计时。在某字段使用 rage 类型之后，插入数据需要**指定对应的范围**，可以使用 `gt`、`lte` 等关键字描述。
- ***token_count***  
词项统计类型，其本身是一个整形。一般用来给某个属性增加附加字段并指定 token_count 来统计词项长度。词项长度取决于具体内容和指定的分词器。

### 元字段 ###

元字段描述了文件本身的属性，是 ES 内置的。总的来看元字段描述了从文档属性、源文档、索引、路由等相关信息，同时也支持自定义元字段。这些元字段支持部分的查询方式和脚本。  

|元字段|元字段分类|意义|
|:-----:|:-----:|:-----:|
|\_index|文档属性|描述文档所属的索引|
|\_type|文档属性|描述文档的类型|
|\_id|文档属性|描述文档的编号|
|\_uid|文档属性|包含\_type及\_id|
|\_source|源文档属性|文档原始的JSON资料|
|\_size|源文档属性|描述源文档的大小，需要插件 mapper-size|
|\_all|索引属性|包含索引中全部的字段的内容，用来泛检索|
|\_field_names|索引属性|包含所有不存在空值的字段名|
|\_parent|路由属性|指定文档间的父子关系|
|\_routing|路由属性|用来设定文档进行路由的自定义值|
|\_meta|自定义|自定义的元数据|

### 映射参数 ###
// todo




