<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[RocketMQ æœåŠ¡ç«¯æ¶ˆæ¯è¿‡æ»¤]]></title>
    <url>%2F2018%2F08%2FRocketMQ-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B6%88%E6%81%AF%E8%BF%87%E6%BB%A4%2F</url>
    <content type="text"><![CDATA[åœ¨æœåŠ¡ç«¯è¿›è¡Œæ¶ˆæ¯è¿‡æ»¤ï¼Œå¯ä»¥å‡å°‘ä¸å¿…è¦çš„æµé‡ï¼Œæé«˜å¸¦å®½åˆ©ç”¨åº¦å’Œåžåé‡ã€‚RocketMQ æ”¯æŒå¤šç§æ–¹å¼æ¥è¿›è¡ŒæœåŠ¡ç«¯çš„æ¶ˆæ¯è¿‡æ»¤ æ¶ˆæ¯ä½¿ç”¨ Tag æ ‡ç­¾ä½œä¸ºä¸€æ¡ Messageï¼Œå®ƒæœ‰ç€ç‰¹å®šçš„ Topicï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥æŒ‡å®šå”¯ä¸€çš„ Tag æ ‡è®°å­åˆ†ç±»ã€‚æ¶ˆè´¹æ–¹åœ¨è®¢é˜…æ¶ˆæ¯æ—¶å€™ï¼ŒBroker å¯ä»¥åœ¨æŒ‡å®š Topic çš„ ConsumeQueue ä¸‹æŒ‰ Tag è¿›è¡Œè¿‡æ»¤ï¼Œåªä»Ž CommitLog ä¸­å–å‡º Tag å‘½ä¸­çš„æ¶ˆæ¯ã€‚ä½¿ç”¨ Tag è¿›è¡Œè¿‡æ»¤æ˜¯é«˜æ•ˆçš„ï¼Œå› ä¸ºæ¶ˆæ¯åœ¨ MessageQueue çš„å­˜å‚¨æ ¼å¼å¦‚ä¸‹ï¼š CommitLog Offsetï¼šé¡¾åæ€ä¹‰ï¼Œä¿å­˜ç€åœ¨ CommitLog ä¸­çš„åç§»é‡ï¼Œå ç”¨ 8 ä¸ªå­—èŠ‚ Sizeï¼šä½¿ç”¨ 4 ä¸ªå­—èŠ‚æ¥è®°å½•æ¶ˆæ¯çš„å¤§å° Message Tag HashCodeï¼šè®°å½•å¯¹åº”æ¶ˆæ¯çš„ Tag çš„å“ˆå¸Œ åœ¨èŽ·å–æ¶ˆæ¯æ—¶å€™ï¼Œé€šè¿‡ Tag HashCode çš„å¯¹æ¯”ï¼Œä»Ž CommitLog è¯»å–å¯¹åº”æ¶ˆæ¯ã€‚ç”±äºŽå“ˆå¸Œå†²çªå®žé™…ä¸Šæ˜¯ä¸å¯é¿å…çš„ï¼Œæ¶ˆæ¯åœ¨ä»Ž CommitLog ä¸­æ‹‰å–ä¹‹åŽè¢«æ¶ˆè´¹ä¹‹å‰ï¼Œä»ç„¶ä¼šè¿›è¡Œ Tag çš„å®Œæ•´å¯¹æ¯”ï¼Œä»¥æ¶ˆé™¤æ½œåœ¨å“ˆå¸Œå†²çªé—®é¢˜ æºå¸¦ MessageKey æ¥å‘é€å’ŒæŸ¥è¯¢å…¶å®žè¿™éƒ¨åˆ†å†…å®¹å¹¶ä¸å±žäºŽæœåŠ¡ç«¯æ¶ˆæ¯è¿‡æ»¤çš„åŠŸèƒ½ï¼Œä½†æ˜¯ä¹Ÿä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç§è¾ƒç²¾ç¡®çš„æŸ¥è¯¢æŒ‡å®šæ¶ˆæ¯çš„åŠŸèƒ½ã€‚åœ¨å‘é€æ¶ˆæ¯ä¹‹å‰å¯ä»¥ä¸ºæ¶ˆæ¯è®¾å®šæŒ‡å®šçš„ Keyï¼Œé€šå¸¸è¿™ä¸ª Key æ˜¯åœ¨ä¸šåŠ¡å±‚é¢æ˜¯å”¯ä¸€çš„ï¼š12Message msg = new Message("Topic", "Tag", "Content".getBytes());msg.setKey(uniqueKey); å°½ç®¡ Broker ä¸ä¼šå¯¹æ¶ˆæ¯è¿›è¡Œ Key ç›¸å…³çš„è¿‡æ»¤ï¼Œä½†æ˜¯ä¼šä¸ºæ¶ˆæ¯å®šåˆ¶ç›¸åº”çš„ç´¢å¼•ã€‚çœ‹ä¸€ä¸‹ç´¢å¼•æ ¼å¼ï¼š Key HashCodeï¼š4 ä¸ªå­—èŠ‚çš„ Key çš„å“ˆå¸Œï¼Œç”¨æ¥å¿«é€Ÿæ£€ç´¢ CommitLog Offsetï¼š8 ä¸ªå­—èŠ‚æ¥ä¿å­˜ CommitLog ä¸­çš„åç§»é‡ Timestampï¼šä½¿ç”¨ 4 ä¸ªå­—èŠ‚è®°å½•æ¶ˆæ¯å­˜å‚¨æ—¶é—´å’Œäº§ç”Ÿæ—¶é—´çš„æ—¶é—´å·® Next Index Offsetï¼šä½¿ç”¨ 4 ä¸ªå­—èŠ‚æ¥è®°å½•ä¸‹ä¸€ç´¢å¼•çš„åç§»é‡åœ¨å­˜å‚¨ Key ç›¸åº”çš„ç´¢å¼•æ—¶å€™ï¼Œå…¶å®žåˆ†äº†å¤šä¸ªå“ˆå¸Œæ¡¶æ¥ï¼ˆSlotï¼‰å­˜å‚¨ï¼Œä¹Ÿå°±æ˜¯ç›¸å¯¹ Key è¿›è¡Œäº†ä¸¤æ¬¡æ•£åˆ—ã€‚æ€Žä¹ˆè§£å†³å“ˆå¸Œå†²çªï¼Ÿå› ä¸ºç´¢å¼•ç»“æž„ä¸­ä¿å­˜äº† Key çš„å“ˆå¸Œï¼Œæ‰€ä»¥å¯¹äºŽå“ˆå¸Œå€¼ä¸åŒè€Œæ¨¡æ•°ç›¸åŒçš„ Key åœ¨æŸ¥è¯¢æ—¶å€™å¯ä»¥ç›´æŽ¥åŒºåˆ†å¼€æ¥ã€‚å¯¹äºŽå“ˆå¸Œå€¼ç›¸ç­‰ä½†æ˜¯ Key æœ¬èº«ä¸ç›¸ç­‰çš„æƒ…å†µï¼Œå®¢æˆ·ç«¯ç»§ç»­åšä¸€æ¬¡ Key æ¯”è¾ƒæ¥è¿›è¡Œç­›é€‰ã€‚ä¸€èˆ¬åº”ç”¨ä¸­è¿›è¡Œæ¶ˆæ¯è¿‡æ»¤ä½¿ç”¨ Tagï¼Œè€Œä½¿ç”¨å‘½ä»¤è¡Œå·¥å…· mqadmin åšè¿ç»´æ—¶æŸ¥è¯¢ç‰¹å®š Key çš„æ¶ˆæ¯ï¼Œç”¨æ³•ï¼š1mqadmin queryMsgByKey -k &lt;Key&gt; -n &lt;NamesrvAddr&gt; -t &lt;Topic&gt; -f &lt;endTime&gt; ä½¿ç”¨ MessageId æ¥æŸ¥è¯¢æ¶ˆæ¯æ¯æ¬¡æ¶ˆæ¯æˆåŠŸå‘é€åŽï¼Œéƒ½ä¼šç”Ÿäº§ä¸€ä¸ª MsgId å’Œ OffsetMsgIdï¼Œæ¥æ ‡è¯†è¿™æ¡æ¶ˆæ¯ï¼š123456Message msg = new Message("Topic", "Tag", "Content".getBytes());SendResult result = producer.send(msg);// producer äº§ç”Ÿçš„ idString msgId = result.getMsgId();// broker äº§ç”Ÿçš„ idString offsetMsgId = result.getOffsetMsgId(); å¯¹äºŽ MsgIdï¼Œç”± producer ip + pid + MessageClientIDSetter.class.getClassLoader().hashCode() + time + counter ç»„æˆ è€Œå¯¹äºŽ OffsetMsgIdï¼Œç”± broker ip + CommitLog Offset ç»„æˆï¼Œå¯ä»¥ç²¾ç¡®åœ°å®šä½æ¶ˆæ¯å­˜å‚¨çš„ä½ç½® åŒæ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿ç»´å·¥å…· mqadmin é’ˆå¯¹ OffsetMsgId è¿›è¡Œæ£€ç´¢1mqadmin queryMsgById -n &lt;NamesrvAddr&gt; -I &lt;OffsetMsgId&gt; ä½¿ç”¨è‡ªå®šä¹‰å±žæ€§å’Œç±» SQL è¿‡æ»¤åœ¨å‘é€æ¶ˆæ¯å‰ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæ¶ˆæ¯è®¾ç½®è‡ªå®šä¹‰çš„å±žæ€§ï¼š123Message msg = new Message("Topic", "Tag", "Content".getBytes());msg.putUserProperty("p1", "v1");msg.putUserProperty("p2", "v2"); åœ¨æœåŠ¡ç«¯è¿›è¡Œæ¶ˆè´¹æ—¶å€™ï¼Œå¯ä»¥é’ˆå¯¹è‡ªå®šä¹‰å±žæ€§ï¼Œåˆ©ç”¨ç±» SQL çš„è¡¨è¾¾å¼æ¥è¿›è¡Œæ¶ˆæ¯çš„è¿›ä¸€æ­¥ç­›é€‰ï¼š1consumer.subscribe("Topic", MessageSelector.bySql("p1 = v1"); ä½¿ç”¨è¿™æ ·çš„æ–¹å¼è¿›è¡Œè¿‡æ»¤ï¼Œéœ€è¦ Broker å…ˆä»Ž CommitLog ä¸­å–å‡ºæ¶ˆæ¯ï¼Œå¾—åˆ°æ¶ˆæ¯ä¸­çš„è‡ªå®šä¹‰å±žæ€§è¿›è¡Œå¯¹åº”çš„è®¡ç®—ã€‚ç†æ‰€å½“ç„¶çš„ï¼ŒåŠŸèƒ½å¾ˆå¼ºå¤§ï¼Œä½†æ˜¯æ•ˆçŽ‡æ²¡æœ‰ä½¿ç”¨ Tag çš„è¿‡æ»¤æ–¹å¼é«˜ã€‚ å¯¹äºŽè¡¨è¾¾å¼çš„è¯­æ³•æ”¯æŒå¦‚ä¸‹ï¼š å¯¹æ¯”æ“ä½œï¼š æ•°å­—ï¼š&gt;, &lt;, &lt;=, &gt;=, =, BETWEEN å­—ç¬¦ä¸²ï¼š=, &lt;&gt;, IN ç©ºå€¼åˆ¤æ–­ï¼šIS NULL, IS NOT NULL é€»è¾‘åˆ¤æ–­ï¼šAND, OR, NOT æ•°æ®ç±»åž‹ï¼š æ•°å­—ï¼š123ï¼Œ456 å­—ç¬¦ä¸²ï¼šâ€™abcâ€™, â€˜defâ€™, å¿…é¡»ä½¿ç”¨å•å¼•å· ç©ºå€¼ï¼šNULL å¸ƒå°”ï¼šTRUEï¼ŒFALSE ä½¿ç”¨è‡ªå®šä¹‰ä»£ç å’Œ Filter Serverå¯¹äºŽ Filter Serverï¼Œäº‹å®žä¸Šå®žåœ¨ Broker æ‰€åœ¨æœåŠ¡å™¨å¯åŠ¨äº†å¤šä¸ªç±»ä¼¼ä¸­è½¬ä»£ç†çš„è¿›ç¨‹ï¼Œè¿™å‡ ä¸ªè¿›ç¨‹è´Ÿè´£å……å½“ Consumer ä»Ž Broker ä¸Šæ‹‰å–ä»£ç ï¼Œä½¿ç”¨ç”¨æˆ·ä¸Šä¼ çš„ Java ä»£ç è¿›è¡Œè¿‡æ»¤ï¼Œæœ€åŽä¼ é€ç»™æ¶ˆè´¹è€…ã€‚è¿™ä¸ªä¸­è½¬ä»£ç†ä¼šå’Œ Broker æœ¬èº«äº‰æŠ¢ CPU èµ„æºï¼Œéœ€è¦æŒ‰éœ€æ±‚è°¨æ…Žä½¿ç”¨ï¼›åŒæ—¶ç”¨äºŽè¿‡æ»¤çš„ä»£ç éœ€è¦ä¸¥æ ¼çš„å®¡æŸ¥ï¼Œé¿å…å¯èƒ½å½±å“ Broker å®•æœºçš„é£Žé™©æ“ä½œã€‚è¿™ä¸ªè¿‡æ»¤æ“ä½œåªæ”¯æŒ PushConsumerä½¿ç”¨æµç¨‹ï¼š å¯åŠ¨ Broker æ—¶æŒ‡å®š filterServerNums=&lt;n&gt;ï¼Œå½“ç„¶ä½¿ç”¨é…ç½®æ–‡ä»¶ä¹Ÿå¯ä»¥ã€‚n çš„æ•°é‡å°±æ˜¯ä¸­è½¬ä»£ç† FilterServer çš„è¿›ç¨‹æ•° å®žçŽ° org.apache.rocketmq.common.filter.MessageFilter æŽ¥å£ï¼Œå®šåˆ¶è¿‡æ»¤é€»è¾‘ æŽ¥æ”¶æ¶ˆæ¯ï¼šPushConsumer.subscribe(final String topic, final String fullClassName, final String filterClassSource) filterClassSource æ˜¯å‰ä¸€æ­¥ MessageFilter æŽ¥å£å®žçŽ°çš„æºç ï¼Œå¿…é¡»ä½¿ç”¨ utf-8 ç¼–ç ã€‚è¿™ä¼šåœ¨ Consumer å¯åŠ¨æ—¶å°†è¿‡æ»¤é€»è¾‘ä¸Šä¼ è‡³ Broker å‚è€ƒï¼š MessageId ç”Ÿæˆè§£è¯» https://www.cnblogs.com/linlinismine/p/9184917.html]]></content>
      <categories>
        <category>RocketMQ</category>
      </categories>
      <tags>
        <tag>MQ</tag>
        <tag>RocketMQ</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[RocketMQ æ—¥å¿—è®¾ç½®]]></title>
    <url>%2F2018%2F08%2FRocketMQ-%E6%97%A5%E5%BF%97%E8%AE%BE%E7%BD%AE%2F</url>
    <content type="text"><![CDATA[æ—¥å¿—é…ç½®æ–‡ä»¶ä½ç½®RocketMQ æ—¥å¿—åŸºäºŽ slf4j å®žçŽ°ï¼Œæ”¯æŒ Logbackã€Log4jã€‚å¦‚æžœéœ€è¦æŒ‡å®šæ—¥å¿—çš„é…ç½®æ–‡ä»¶çš„ä½ç½®æœ‰ä¸‰ç§æ–¹å¼ï¼š çŽ¯å¢ƒå˜é‡ï¼šROCKETMQ_CLIENT_LOG_CONFIGFILE=&lt;custom-file&gt; å¯åŠ¨å‚æ•°ï¼šrocketmq.client.log.configFile=&lt;customer-file&gt;ï¼Œä½œä¸º JVM å˜é‡ï¼Œå¯åŠ¨æ—¶æ—¶éœ€è¦å¢žåŠ  -D æ ‡è¯†ï¼Œä¼˜å…ˆçº§ä¹Ÿæ¯”çŽ¯å¢ƒå˜é‡æ›´é«˜ ä½œä¸º Java å®žçŽ°ï¼Œæ—¥å¿—ä½ç½®ä¿¡æ¯æ˜¯é€šè¿‡ System.getProperty() æˆ–è€… System,getenv() å¾—åˆ°çš„ï¼Œæ‰€ä»¥å¯ä»¥åœ¨ç¨‹åºå…¥å£ System.setProperty(â€œrocketmq.client.log.configFileâ€, customer_file) æ¥é…ç½® æ—¥å¿—ç›¸å…³ç³»ç»Ÿå˜é‡ rocketmq.client.log.loadconfigé»˜è®¤ trueï¼Œæ˜¯å¦åŠ è½½æŒ‡å®šé…ç½®æ–‡ä»¶ï¼Œå½“è®¾ç½®ä¸º false æ—¶ï¼ŒRocketMQ å®¢æˆ·ç«¯ä¼šä¼šä½¿ç”¨åº”ç”¨æœ¬èº«çš„æ—¥å¿—é…ç½®ã€‚è¿™å¯èƒ½åè€Œæ˜¯æœ€ç®€å•çš„æ—¥å¿—é…ç½®æ–¹å¼ rocketmq.client.log4j.resource.fileNameã€rocketmq.client.logback.resource.fileNameã€ rocketmq.client.log4j2.resource.fileNameä¸‰ç§æ—¥å¿—æ¡†æž¶çš„çš„é…ç½®æ–‡ä»¶åï¼Œé»˜è®¤å€¼åˆ†åˆ«ä¸º log4j_rocketmq_client.xmlã€logback_rocketmq_client.xmlã€log4j2_rocketmq_client.xml rocketmq.client.log.configFileæ—¥å¿—é…ç½®æ–‡ä»¶è·¯å¾„ï¼Œä¸Šè¿°ã€‚å¦‚æžœä½¿ç”¨äº†è‡ªå®šä¹‰çš„æ—¥å¿—é…ç½®æ–‡ä»¶ï¼Œé€šå¸¸ä½ ä¸å†éœ€è¦è®¾ç½®ä»¥ä¸‹çš„å˜é‡äº† rocketmq.client.logRootRocketMQ æ—¥å¿—ä¿¡æ¯é»˜è®¤å­˜æ”¾æ—¥å¿—ä¸ºï¼š$USER_HOME/Logs/rocketmqLogsï¼Œé€šè¿‡æ”¹å˜æ­¤å˜é‡å¯ä»¥å˜æ›´æ—¥å¿—è·¯å¾„ rocketmq.client.logLevelæ—¥å¿—è¾“å‡ºçº§åˆ«ï¼Œé»˜è®¤ INFO rocketmq.client.logFileMaxIndexæ»šåŠ¨çª—å£çš„ç´¢å¼•æœ€å¤§å€¼ï¼Œé»˜è®¤ 10]]></content>
      <categories>
        <category>RocketMQ</category>
      </categories>
      <tags>
        <tag>MQ</tag>
        <tag>RocketMQ</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[RocketMQ Producer æ‘˜è¦]]></title>
    <url>%2F2018%2F08%2FRocketMQ-Producer-%E6%91%98%E8%A6%81%2F</url>
    <content type="text"><![CDATA[ä¸Šä¸€ç¯‡ä»‹ç»å®Œäº† RocketMQ æ¶ˆè´¹è€…çš„é»˜è®¤å®žçŽ°ï¼ŒçŽ°åœ¨æ¥çž…ä¸€çž…ç”Ÿäº§è€…çš„ç”¨æ³•ã€‚ è®¾ç½®å¿…è¦çš„å±žæ€§åŒæ ·çš„ï¼Œæ˜¯ DefaultMQProducerï¼Œæ–°å»ºå®žä¾‹ä¹‹åŽï¼Œåœ¨ä½¿ç”¨ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ä¹‹å‰ï¼Œéœ€è¦åˆå§‹åŒ–å‡ ä¸ªå±žæ€§ï¼š InstanceName å®žä¾‹åç§°è¿™æ˜¯ä¸ºäº†å½“ä¸€ä¸ª JVM ä¸Šå¯åŠ¨äº†å¤šä¸ªç”Ÿäº§è€…æ—¶ï¼ŒåŒºåˆ†ä¸åŒçš„ç”Ÿäº§è€…å®žä¾‹ï¼Œç³»ç»Ÿé»˜è®¤åç§°ä¸º DEFAULT RetryTimesWhenSendFailed é‡è¯•æ¬¡æ•°å½“æ¶ˆæ¯æŠ•é€’å¤±è´¥æ—¶ï¼Œæœ‰å¯èƒ½æ˜¯å› ä¸ºç½‘ç»œåŽŸå› ï¼Œå¯ä»¥è®¾ç½®å¤šæŠ•é€’å‡ æ¬¡å‡å°‘ä¸¢æ¶ˆæ¯çš„æƒ…å†µã€‚å¾ˆå¤šå®žç”¨è€…åœ¨ä½¿ç”¨æ—¶ï¼Œä¸ºäº†é¿å…é‡å¤çš„æ¶ˆæ¯è®¾ç½®ä¸é‡è¯•æ˜¯ä¸æ­£ç¡®çš„åšæ³•ï¼šå› ä¸º RocketMQ æœ¬èº«å¹¶ä¸ä¿è¯æ¶ˆæ¯çš„ä¸é‡å¤ï¼Œä½œä¸ºå®¢æˆ·ç«¯å¯¹æ¶ˆæ¯è¿›è¡Œå¹‚ç­‰å¤„ç†æ˜¯å¿…è¦çš„ã€‚è€Œåœ¨æ¬¡å‰æä¸‹ï¼Œå¯¹å‘é€å¤±è´¥çš„åœºæ™¯æ‹’ç»é‡å‘ï¼Œä¸ä»…å¯¹é¿å…é‡å¤æ¶ˆæ¯æ²¡æœ‰ä»»ä½•æ„ä¹‰ï¼ŒåŒæ—¶ä¹Ÿå¢žåŠ äº†æ¶ˆæ¯çš„ä¸¢å¤±çš„å¯èƒ½ã€‚ NamesrvAddréœ€è¦ NameServer çš„åœ°å€ï¼Œå†™æ³•å’Œ Consumer ä¸€è‡´ æ¶ˆæ¯å‘é€æ–¹å¼å’ŒæŠ•é€’ç»“æžœå‘é€æ–¹å¼ åŒæ­¥å‘é€ï¼šProducer.send(Message message) å¼‚æ­¥å‘é€ï¼šProducer.send(Message message, SendCallback callback) å‘é€ç»“æžœå¯¹äºŽæ¶ˆæ¯å‘é€çš„ç»“æžœï¼Œå­˜åœ¨å››ä¸­å¯èƒ½è¿”å›žçš„çŠ¶æ€ã€‚è€Œä¸”åœ¨ä¸åŒçš„é…ç½®æ–¹å¼ä¸‹ï¼Œæ„ä¹‰å¯èƒ½æœ‰æ‰€ä¸åŒ SEND_OKå‘é€æˆåŠŸï¼Œæ ‡å¿—ç€æ¶ˆæ¯å·²ç»æˆåŠŸè¢«å‘é€åˆ° Brokerã€‚ï¼ˆè¿™æ—¶å€™ä¸ä¸€å®šæ„å‘³ç€ä¸»ä»Žå¤åˆ¶å®Œæˆæˆ–è€…åˆ·ç›˜å®Œæˆï¼‰ FLUSH_DISK_TIMEOUTåˆ·ç›˜æ—¶é—´è¶…æ—¶ï¼Œåªæœ‰åœ¨åˆ·ç›˜ç­–ç•¥ä¸º SYNC_FLUSH æ—¶æ‰å¯èƒ½å‡ºçŽ° FLUSH_SLAVE_TIMEOUTä¸»ä»ŽåŒæ­¥æ—¶é—´è¶…æ—¶ï¼Œåªæœ‰åœ¨ä¸»å¤‡å½¢å¼ä¸‹ä½¿ç”¨ SYNC_MASTER æ‰å¯èƒ½å‡ºçŽ° SLAVE_NOT_AVAILABLEä»Žæœºç¼ºå¤±ï¼Œåªæœ‰åœ¨ä¸»å¤‡å½¢å¼ä¸‹ä½¿ç”¨ SYNC_MASTER æ‰å¯èƒ½å‡ºçŽ°ï¼Œç±»ä¼¼äºŽ FLUSH_SLAVE_TIMEOUTå¯¹äºŽä¸åŒçš„ä¸šåŠ¡åœºæ™¯å…·ä½“éœ€æ±‚ï¼Œå¦‚ä½•å¤„ç†æ¶ˆæ¯å‘é€çš„ç»“æžœæ˜¯ç¨‹åºè´¨é‡çš„ä¸€ä¸ªé‡è¦è€ƒé‡ç‚¹ ç‰¹æ®Šçš„æ¶ˆæ¯å»¶è¿Ÿæ¶ˆæ¯RocketMQ æ”¯æŒå»¶è¿Ÿæ¶ˆæ¯ï¼ŒBroker æ”¶åˆ°æ¶ˆæ¯åŽå¹¶ä¸ä¼šç«‹å³æŠ•é€’ï¼Œè€Œæ˜¯ç­‰å¾…ä¸€æ®µæ—¶é—´åŽå†è®²æ¶ˆæ¯é€å‡ºåŽ»ã€‚ ä½¿ç”¨æ–¹å¼ï¼šåœ¨æ¶ˆæ¯å‘é€å‰æ‰§è¡Œ Message.setDelayTimeLevel(int level) å»¶è¿Ÿç­‰çº§ï¼šé»˜è®¤ 1s/5s/10s/30s/1m/2m/3m/4m/5m/6m/7m/8m/9m/10m/20m/30m/1h/2hï¼Œç´¢å¼• 1 å¼€å§‹å°½ç®¡ RocketMQ çš„å»¶è¿Ÿæ¶ˆæ¯ä¸æ”¯æŒä»»æ„ç²¾åº¦ï¼Œä½†æ˜¯å„ç­‰çº§çš„å»¶è¿Ÿæ˜¯å¯ä»¥é¢„è®¾çš„ï¼Œæ›´æ”¹é…ç½®æ–‡ä»¶å³å¯ é˜Ÿåˆ—é€‰æ‹©å¯¹äºŽä¸€ä¸ª Topic é€šå¸¸æœ‰å¤šä¸ª MessageQueue æ¥æŽ¥æ”¶æ¶ˆæ¯ï¼Œé»˜è®¤æƒ…å†µä¸‹ Producer è½®æµå‘å„ä¸ª MessageQueue å‘é€æ¶ˆæ¯ï¼Œè€Œ Consumer æ ¹æ®é»˜è®¤çš„è´Ÿè½½ç­–ç•¥è¿›è¡Œæ¶ˆè´¹ï¼Œæ‰€ä»¥æ— æ³•æ˜Žç¡®å¯¹åº” Producer çš„æ¶ˆæ¯æ˜¯å“ªä¸ª Consumer æ¶ˆè´¹ã€‚åœ¨éœ€è¦æŒ‡å®šç‰¹å®š MessageQueue æ¥æŠ•é€’æ¶ˆæ¯æ—¶ï¼Œå¯ä»¥å®žçŽ° MessageQueueSelector æŽ¥å£ï¼Œå®šåˆ¶é€‰æ‹©é€»è¾‘ï¼›å‘é€æ—¶é€‰æ‹©å¸¦æœ‰é€‰æ‹©å™¨çš„é‡è½½æ–¹æ³•å³å¯ äº‹åŠ¡æ¶ˆæ¯ä»‹ç»äº‹åŠ¡æ¶ˆæ¯æ˜¯å¿…è¦çš„ï¼Œä½†æ˜¯å¹¶ä¸æŽ¨èä½¿ç”¨ã€‚å› ä¸ºäº‹åŠ¡æ¶ˆæ¯ä¼šé€ æˆç£ç›˜è„é¡µï¼Œå½±å“ç£ç›˜æ€§èƒ½ï¼Œåœ¨ 4.x ç‰ˆæœ¬ä¸­å·²ç»ç§»é™¤ï¼Œéœ€è¦ä½¿ç”¨æ—¶éœ€è¦æ‰‹åŠ¨æ ¹æ®é¡¶å±‚æŽ¥å£å®žçŽ°ã€‚ç®€å•çš„è¯´ï¼ŒRocketMQ çš„äº‹åŠ¡æ¶ˆæ¯æµç¨‹å¦‚ä¸‹ï¼š å‘ Broker å‘é€æ¶ˆæ¯ï¼ˆæ¶ˆæ¯çŠ¶æ€ä¸ºæœªç¡®è®¤çŠ¶æ€ï¼‰ Broker å¯¹æ”¶åˆ°çš„æ¶ˆæ¯å®ŒæˆæŒä¹…åŒ–ï¼Œè¿”å›žæˆåŠŸçŠ¶æ€ã€‚å‘é€çš„ç¬¬ä¸€é˜¶æ®µç»“æŸ æ‰§è¡Œæœ¬åœ°é€»è¾‘ äº‹åŠ¡æ¶ˆæ¯çš„ç»“æŸ æœ¬åœ°é€»è¾‘ç»“æŸï¼Œå®¢æˆ·ç«¯å‘ Broker ç¡®è®¤æ¶ˆæ¯ commitï¼šæäº¤ï¼Œè¯¥æ¶ˆæ¯å°†ä¼šè¢« Broker è¿›è¡ŒæŠ•é€’ rollbackï¼šå›žæ»šï¼ŒBroker ä¼šåˆ é™¤ä¹‹å‰æŽ¥æ”¶åˆ°çš„æ¶ˆæ¯ è¶…è¿‡ä¸€å®šæ—¶é—´ï¼ŒæœåŠ¡ç«¯å¯¹å®¢æˆ·ç«¯å‘èµ·å›žæŸ¥è¯·æ±‚Producer å¯¹å›žæŸ¥è¯·æ±‚è¿”å›ž commit æˆ–è€… rollback çš„å“åº”ã€‚å¦‚æžœæ­¤æ—¶å‘é€æ¶ˆæ¯çš„ Producer æ— æ³•è®¿é—®ï¼Œå›žæŸ¥è¯·æ±‚ä¼šå‘é€ç»™åŒä¸€ ProducerGroup å†…çš„å…¶ä»– Producer å‚è€ƒ RocketMQ on GitHub ã€ŠRocketMQ å®žæˆ˜ä¸ŽåŽŸç†è§£æžã€‹æœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾ æ¨å¼€å…ƒ]]></content>
      <categories>
        <category>RocketMQ</category>
      </categories>
      <tags>
        <tag>MQ</tag>
        <tag>RocketMQ</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[RocketMQ Consumer æ‘˜è¦]]></title>
    <url>%2F2018%2F08%2FRocketMQ-Consumer-%E6%91%98%E8%A6%81%2F</url>
    <content type="text"><![CDATA[ç»“æŸäº†å¯¹ RocketMQ ç»„ä»¶çš„åˆæ­¥ç†è§£ä»¥åŠé…ç½®çš„ç®€å•è®¾å®šï¼Œå¯ä»¥å¯¹ RocketMQ ä»”ç»†ç ”ç©¶ä¸€ç•ªäº†ã€‚å…ˆæ¥çœ‹çœ‹ RocketMQ çš„æ¶ˆè´¹è€…å®žçŽ°ï¼Œä»¥åŠæœåŠ¡ç«¯æ˜¯å¦‚ä½•å¤„ç†æ¶ˆè´¹è€…å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼ŒæŠŠæ¶ˆæ¯é€å‡ºåŽ»çš„ã€‚ RocketMQ å¯¹äºŽæ¶ˆè´¹è€…å®¢æˆ·ç«¯ï¼Œæ”¯æŒæŽ¨æ¨¡åž‹å’Œæ‹‰æ¨¡åž‹ã€‚å¯¹äºŽæŽ¨æ¨¡åž‹ï¼Œç”±æ¶ˆæ¯æœåŠ¡ç«¯ä½œä¸ºä¸»åŠ¨æ–¹ï¼Œå‘å®¢æˆ·ç«¯æŽ¨é€æ¶ˆæ¯ï¼ˆå°½ç®¡å…¶æœ¬è´¨æ˜¯ä¸€ä¸ªé•¿è½®è¯¢å¼çš„æ‹‰æ¨¡åž‹å®žçŽ°ï¼‰ï¼›è€Œæ‹‰æ¨¡åž‹ç”±å®¢æˆ·ç«¯ä¸»åŠ¨æ‹‰å–æ¶ˆæ¯ã€‚ PushConsumerå®¢æˆ·ç«¯çš„å®žçŽ°ï¼šDefaultMQPushConsumerImpl æ˜¯å®¢æˆ·ç«¯çš„ä¸€ä¸ªé»˜è®¤å®žçŽ°ï¼Œå¯ä»¥ä»Ž pullMessage() æ–¹æ³•åˆ‡å…¥ï¼Œè§‚å¯Ÿå®ƒçš„å®žçŽ°ã€‚ åŸºæœ¬è¦ç´ ï¼šä»¥ä¸‹å‡ ä¸ªå±žæ€§ï¼Œä¸ä»…ä»…æ˜¯æŽ¨æ¨¡åž‹çš„é‡è¦é…ç½®ï¼ŒåŒæ—¶ä¹Ÿç§°å¾—ä¸Šæ˜¯æ¯ä¸ªå®¢æˆ·ç«¯çš„æ ‡é…ã€‚ NameServerAddræŒ‡å®š NameServer åœ°å€æ˜¯å¿…è¦çš„ï¼Œå¯ä»¥é€šè¿‡å®¢æˆ·ç«¯ API è®¾ç½®ï¼ˆä½¿ç”¨ ; åˆ†å‰²å¤šä¸ªåœ°å€ï¼‰ï¼Œæˆ–è€…ä½¿ç”¨çŽ¯å¢ƒå˜é‡ NAMESRV_ADDR ConsumerGroupå°†å¤šä¸ªæ¶ˆè´¹è€…ç»„ç»‡ä¸€èµ·ï¼Œæé«˜å¹¶å‘ï¼Œéœ€è¦é…åˆ MessageModel å±žæ€§ä¸€èµ·ä½¿ç”¨ MessageModelæ¶ˆæ¯æ¨¡å¼åˆ†ä¸ºä¸¤ç§ï¼Œé›†ç¾¤æ¨¡å¼ï¼šClusteringï¼›å¹¿æ’­æ¨¡å¼ï¼šBroadcasting Clusteringï¼šé›†ç¾¤æ¨¡å¼ï¼Œæ‰€è®¢é˜… Topic ä¸‹çš„æ¶ˆæ¯ï¼Œæ¯ä¸€æ¡åªä¼šè¢«åŒä¸€ ConsumerGroup ä¸‹çš„ä¸€ä¸ªæ¶ˆè´¹è€…æ‰€æ¶ˆè´¹ï¼Œè¾¾åˆ°è´Ÿè½½å‡è¡¡çš„ç›®çš„ Broadcastingï¼šå¹¿æ’­æ¨¡å¼ï¼ŒåŒä¸€ ConsumerGroup ä¸‹çš„æ¯ä¸€ä¸ª Consumer éƒ½ä¼šæ¶ˆè´¹åˆ°æ‰€è®¢é˜… Topic ä¸‹çš„å…¨éƒ¨æ¶ˆæ¯ã€‚ Topicæ¶ˆæ¯ç±»åž‹ä¸»é¢˜ï¼Œä½œä¸ºä¸åŒæ¶ˆæ¯çš„æ ‡è¯†ï¼Œå†³å®šäº†æ¶ˆè´¹è€…è®¢é˜…å“ªäº›æ¶ˆæ¯ã€‚Topic é»˜è®¤æ˜¯å¯ä»¥ç”±å®¢æˆ·ç«¯åˆ›å»ºçš„ï¼Œç”Ÿäº§çŽ¯å¢ƒä¸‹é€šå¸¸æ”¹æƒé™è¢«å…³é—­ï¼Œéœ€è¦ä½¿ç”¨ mqadmin å·¥å…·æ¥åˆå§‹åŒ–å¯ç”¨çš„ Topic TagTag å¯ä»¥è¿›ä¸€æ­¥è¿‡æ»¤æ¶ˆè´¹éœ€è¦è®¢é˜…çš„æ¶ˆæ¯ï¼Œåœ¨ Java å®¢æˆ·ç«¯ API ä¸‹ï¼Œä½¿ç”¨ null æˆ–è€… * æ¥æ¶ˆè´¹æ‰€æœ‰ Tag ç±»åž‹ï¼Œéœ€è¦å…·ä½“æŒ‡å®šæ—¶å¯ä»¥ä½¿ç”¨ || æ¥åˆ†å‰²å¤šä¸ª Tag æœåŠ¡ç«¯æŽ¨é€æ–¹å¼ï¼šæ¶ˆè´¹è€…çš„æŽ¨æ¨¡åž‹æ˜¯é€šè¿‡é•¿è½®è¯¢å®žçŽ°çš„ï¼Œå› ä¸ºå®Œå…¨çš„æŽ¨æ¨¡åž‹æ–¹å¼ä¼šä½¿å¾—æœåŠ¡ç«¯å¢žåŠ è®¸å¤šåŽ‹åŠ›ï¼Œæ˜Žæ˜¾çš„é™ä½Žæ•ˆçŽ‡ï¼ŒåŒæ—¶ä¹Ÿä¼šå› ä¸ºå„å®¢æˆ·ç«¯æ¶ˆè´¹èƒ½åŠ›ä¸è¶³çš„é—®é¢˜é€ æˆéšæ‚£ã€‚Broker æœåŠ¡ç«¯åœ¨å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚æ—¶å¦‚æžœå‘çŽ°æ²¡æœ‰æ¶ˆæ¯ï¼Œä¼šä¼‘çœ ä¸€å°ä¼š-çŸ­è½®è¯¢é—´éš”ï¼ˆshortPollingTimeMillsï¼‰ï¼Œé‡å¤å¾ªçŽ¯ï¼Œç›´åˆ°è¶…è¿‡æœ€å¤§ç­‰å¾…æ—¶é—´ï¼ˆbrokerSuspendMaxTimeMillsï¼‰ï¼Œåœ¨æ­¤æœŸé—´å†…çš„æ”¶åˆ°æ¶ˆæ¯ä¼šç«‹å³å‘é€ç»™å®¢æˆ·ç«¯ï¼Œè¾¾åˆ°â€œæŽ¨â€çš„æ•ˆæžœ å®¢æˆ·ç«¯æµé‡æŽ§åˆ¶ï¼šå®¢æˆ·ç«¯ç»´æŠ¤äº†ä¸€ä¸ªçº¿ç¨‹æ± æ¥æŽ¥å—æœåŠ¡ç«¯â€œæŽ¨â€æ¥çš„æ¶ˆæ¯ï¼Œé’ˆå¯¹æ¯ä¸ª MessageQueue éƒ½æœ‰ä½¿ç”¨ä¸€ä¸ª ProcessQueue æ¥ä¿å­˜å¿«ç…§çŠ¶æ€å’Œå¤„ç†é€»è¾‘ã€‚ProcessQueue ä¸»è¦ç”±ä¸€ä¸ª TreeMap å’Œè¯»å†™é”ç»„æˆ ProcessQueue.lockTreeMap ä¿å­˜äº†æ‰€æœ‰èŽ·å–åŽè¿˜æ²¡æœ‰è¢«æ¶ˆè´¹çš„æ¶ˆæ¯ Keyï¼šMessageQueueâ€˜s offset Valueï¼šæ¶ˆæ¯å†…å®¹å¼•ç”¨ DefaultMQPushConsumerImpl.pullMessage() ä¼šæ£€æŸ¥ä»¥ä¸‹æ¯ä¸ªå±žæ€§ï¼Œä»»æ„å±žæ€§è¶…è¿‡é˜ˆå€¼ä¼šæš‚ç¼“æ‹‰å–åŠ¨ä½œã€‚ç”±äºŽé€šè¿‡ ProcessQueue çš„ä¿¡æ¯æ¥æ¯”è¾ƒï¼Œæ£€æŸ¥åŸŸæ˜¯æ¯ä¸ª Queue cachedMessageCountæ£€æŸ¥å½“å‰ç¼“å­˜çš„ä½†æ˜¯æœªæ¶ˆè´¹çš„æ¶ˆæ¯æ•°é‡æ˜¯å¦å¤§äºŽè®¾å®šå€¼ï¼ˆpullThresholdForQueueï¼Œé»˜è®¤ 1000ï¼‰ cachedMessageSizeInMiBåŒä¸Šï¼Œæ£€æŸ¥é˜Ÿåˆ—ä¸­æ¶ˆæ¯ç¼“å­˜çš„å¤§å°ï¼ˆpullThresholdSizeForQueueï¼Œé»˜è®¤ 100MiBï¼‰ maxSpanæ£€æŸ¥ ProcessQueue ä¸­æœªæ¶ˆè´¹æ¶ˆæ¯çš„ offset è·¨åº¦ï¼ˆconsumeConcurrentlyMaxSpanï¼Œé»˜è®¤ 200ï¼‰ï¼Œåœ¨é¡ºåºæ¶ˆè´¹æ—¶ä¸æ£€æŸ¥ PullConsumerå®¢æˆ·ç«¯çš„å®žçŽ°ï¼šåˆæ¬¡æŽ¥è§¦ï¼Œå¯ä»¥ä»Žè¿™å‡ ä¸ªæ–¹æ³•äº†è§£ PullConsumer çš„æ¶ˆæ¯æ‹‰å–æ€è·¯ï¼Œå¹¶ä»Žå®˜æ–¹çš„å‡ ä¸ªä¾‹å­ä¸­äº†è§£ä¸€äº›å¸¸ç”¨çš„å¤„ç†æ–¹å¼ã€‚ å‰ç½®æ“ä½œ DefaultMQPullConsumerImpl.fetchSubscribeMessageQueues() DefaultMQPullConsumerImpl.fetchConsumerOffset() DefaultMQPullConsumerImpl.fetchMessageQueuesInBalance() æ‹‰å–åŠ¨ä½œ DefaultMQPullConsumerImpl.pull() DefaultMQPullConsumerImpl.pullBlockIfNotFound() å®¢æˆ·ç«¯é¢å¤–æ“ä½œï¼šåœ¨ä½¿ç”¨ PullConsumer æ—¶å€™ï¼Œé€šå¸¸ä½¿ç”¨éœ€è¦é¢å¤–å…³å¿ƒ MessageQueue å’Œ offset ç­‰ä¸€äº›è¦ç´ ï¼Œçµæ´»çš„å°è£…å¯ä»¥å¸¦æ¥æ›´å¤šçš„è‡ªä¸»æ€§ã€‚ä»¥ fetchSubscribeMessageQueues() å’Œ pull() æ–¹æ³•è¯´æ˜Žå‡ ä¸ªè¦ç´ ï¼š MessageQueueä¸€ä¸ª Topic ä¸‹é€šå¸¸ä¼šä½¿ç”¨å¤šä¸ª MessageQueueï¼Œå¦‚æžœéœ€è¦èŽ·å–å…¨éƒ¨æ¶ˆæ¯ï¼Œéœ€è¦éåŽ†è¿”å›žçš„æ‰€æœ‰é˜Ÿåˆ—ã€‚ç‰¹æ®Šæƒ…å†µä¸‹å¯ä»¥é’ˆå¯¹ç‰¹å®šé˜Ÿåˆ—æ¶ˆè´¹ Offsetstoreä½¿ç”¨è€…éœ€è¦æ‰‹åŠ¨è®°å½•å’Œæ“ä½œæ¶ˆæ¯åç§»é‡ï¼Œéšç€æ¶ˆæ¯æ¶ˆè´¹è€Œæ”¹å˜å®ƒï¼Œéœ€è¦é¢å¤–æ³¨æ„ä»–çš„æŒä¹…åŒ–ï¼Œæ­£ç¡®çš„åç§»é‡æ˜¯å‡†ç¡®æ¶ˆè´¹çš„å‰æ PullStatusé’ˆå¯¹æŸé˜Ÿåˆ—çš„æ‹‰å–åŠ¨ä½œç»“æŸï¼Œä¼šè¿”å›žç›¸åº”çŠ¶æ€ï¼Œä½¿ç”¨è€…éœ€è¦é’ˆå¯¹ä¸åŒçŠ¶æ€é‡‡å–ä¸åŒçš„åŠ¨ä½œ FOUND NO_MATCHED_MSG NO_NEW_MSG OFFSET_ILLEGAL shutDown()å…³é—­æ“ä½œä¼šè¿›è¡Œä¿å­˜ offset çš„æ“ä½œï¼Œåœ¨ NameServer æ³¨é”€å®¢æˆ·ç«¯çš„æ“ä½œç­‰ã€‚å¯¹äºŽä¿å­˜çš„ offset å¯ä»¥é€šè¿‡ OffsetStore å¯¹è±¡èŽ·å–ï¼Œå¯åŠ¨æ—¶åŠ è½½ã€‚ å‚è€ƒ RocketMQ on GitHub ã€ŠRocketMQ å®žæˆ˜ä¸ŽåŽŸç†è§£æžã€‹æœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾ æ¨å¼€å…ƒ]]></content>
      <categories>
        <category>RocketMQ</category>
      </categories>
      <tags>
        <tag>MQ</tag>
        <tag>RocketMQ</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[RokcetMQ é…ç½®é¡¹]]></title>
    <url>%2F2018%2F08%2FRocketMQ-%E9%85%8D%E7%BD%AE%E9%A1%B9%2F</url>
    <content type="text"><![CDATA[RocketMQ çš„é…ç½®åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€è€…æ˜¯ JVM çš„é…åˆï¼Œå¦ä¸€è€…åˆ™æ˜¯å¯¹ Broker åº”ç”¨æœ¬èº«çš„å‚æ•°é…ç½®ã€‚åœ¨åˆæ¬¡æŽ¥è§¦æ—¶å€™ï¼Œé™¤äº† RocketMQ æœ¬èº«çš„ä¸€äº›ç‰¹æ€§ï¼ŒåŒæ—¶ä¹Ÿéš¾å…ä¼šè¢«ä¸€äº›é…ç½®ç»™è¿·æƒ‘æˆ–è€…è¸©å‘ï¼Œè¿™é‡Œæ¥çœ‹ä¸€ä¸‹é€šå¸¸çš„é…ç½®ç‚¹ã€‚ Broker JVM é…ç½®JVM çš„é…ç½®é»˜è®¤ä¸éœ€è¦ä¿®æ”¹ï¼Œåªéœ€è¦æ ¹æ®ç¡¬ä»¶æƒ…å†µè°ƒæ•´ç›¸åº”çš„å †æ ˆå†…å­˜å’Œå¯¹å¤–å†…å­˜çš„å ç”¨é‡å³å¯ã€‚é™„ä¸Šå¯åŠ¨æ—¶çš„ JVM é…ç½®è„šæœ¬ç‰‡æ®µï¼š123456789101112JAVA_OPT="$&#123;JAVA_OPT&#125; -server -Xms8g -Xmx8g -Xmn4g"JAVA_OPT="$&#123;JAVA_OPT&#125; -XX:+UseG1GC -XX:G1HeapRegionSize=16m -XX:G1ReservePercent=25 -XX:InitiatingHeapOccupancyPercent=30 -XX:SoftRefLRUPolicyMSPerMB=0 -XX:SurvivorRatio=8 -XX:+DisableExplicitGC"JAVA_OPT="$&#123;JAVA_OPT&#125; -verbose:gc -Xloggc:/dev/shm/mq_gc_%p.log -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintGCApplicationStoppedTime -XX:+PrintAdaptiveSizePolicy"JAVA_OPT="$&#123;JAVA_OPT&#125; -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=30m"JAVA_OPT="$&#123;JAVA_OPT&#125; -XX:-OmitStackTraceInFastThrow"JAVA_OPT="$&#123;JAVA_OPT&#125; -XX:+AlwaysPreTouch"JAVA_OPT="$&#123;JAVA_OPT&#125; -XX:MaxDirectMemorySize=15g"JAVA_OPT="$&#123;JAVA_OPT&#125; -XX:-UseLargePages -XX:-UseBiasedLocking"JAVA_OPT="$&#123;JAVA_OPT&#125; -Djava.ext.dirs=$&#123;BASE_DIR&#125;/lib"#JAVA_OPT="$&#123;JAVA_OPT&#125; -Xdebug -Xrunjdwp:transport=dt_socket,address=9555,server=y,suspend=n"JAVA_OPT="$&#123;JAVA_OPT&#125; $&#123;JAVA_OPT_EXT&#125;"JAVA_OPT="$&#123;JAVA_OPT&#125; -cp $&#123;CLASSPATH&#125;" éœ€è¦é¢å¤–å…³æ³¨çš„ç‚¹åœ¨äºŽï¼š -Xms8g -Xmx8g -Xmn4g é»˜è®¤ Broker éœ€è¦ 8g çš„å †å†…å­˜ï¼Œä¸è¦è½»æ˜“åœ¨è‡ªå·±çš„ç¬”è®°æœ¬ä¸Šè¿è¡Œå“¦ ðŸ˜‚ -XX:MaxDirectMemorySize=15g é»˜è®¤çš„æœ€å¤§å †å¤–å†…å­˜ä¸º 15gï¼Œnio é€šè¿‡å†…å­˜æ˜ å°„æ–‡ä»¶æ‰€æé«˜ IO æ•ˆçŽ‡è€Œç”¨ã€‚ JAVA_OPT_EXT è¯¥çŽ¯å¢ƒå˜é‡å¯ä»¥è¿½åŠ å’Œæ›¿æ¢åŽŸæœ‰çš„é…ç½® Broker åº”ç”¨é…ç½®è‡ªå®šä¹‰é…ç½®å¯åŠ¨å¯åŠ¨ Broker æ—¶å¯ä»¥è‡ªå®šä¹‰é…ç½®ï¼šsh bin/mqbroker -c CONFIG.properties é…ç½®å¯é€‰é¡¹ èŽ·å–å¯é…ç½®é¡¹çš„åˆ—è¡¨ï¼šsh bin/mqbroker -m èŽ·å–é…ç½®é¡¹ä»¥åŠé»˜è®¤å€¼ï¼šsh bin/mqbroker -p æºç ä¸­é…ç½®ç±»ï¼šBrokerConfig / NettyServerConfig / NettyClientConfig / MessageStoreConfig é…ç½®å‚æ•°ä»‹ç»ä»‹ç»å‡ ä¸ªå¸¸ç”¨çš„ï¼Œæˆ–è€…è¯´é€šå¸¸éœ€è¦é…ç½®çš„é€‰é¡¹ã€‚ namesrvAddr=IP:PORT;IP:PORTé…ç½® NameServer çš„åœ°å€ï¼Œå¤šä¸ªåœ°å€é—´ä½¿ç”¨ ; éš”å¼€ï¼Œè¯¥é€‰é¡¹æ²¡æœ‰é»˜è®¤å€¼ï¼Œå¯ä»¥å¯åŠ¨æ—¶é€šè¿‡ -n å‚æ•°è®¾ç½® brokerClusterName=DefaultClusteré…ç½® RocketMQ é›†ç¾¤çš„åç§°ï¼Œé»˜è®¤ä¸º DefaultCluster brokerName=broker-aBroker çš„åç§°ï¼Œåœ¨åŒä¸€ NameServer ç¾¤ä¸‹ï¼Œåªæœ‰ä½¿ç”¨ç›¸åŒçš„ brokerName çš„ Broker å®žä¾‹æ‰å¯ä»¥ç»„æˆä¸»ä»Žå…³ç³» brokerId=0åœ¨ä¸€ä¸ª Broker ç¾¤ä¸‹ï¼ˆéƒ½ä½¿ç”¨äº†åŒæ ·çš„ brokerNameï¼‰ï¼Œæ‰€æœ‰å®žä¾‹é€šè¿‡ brokerId æ¥åŒºåˆ†ä¸»ä»Žï¼Œä¸»æœºåªæœ‰ä¸€ä¸ªï¼šbrokerId=0ï¼ˆé»˜è®¤ï¼‰ fileReservedTime=48æ¶ˆæ¯æ•°æ®åœ¨ç£ç›˜ä¸Šä¿å­˜çš„æ—¶é—´ï¼Œå•ä½ï¼šå°æ—¶ï¼Œé»˜è®¤ï¼š48 deleteWhen=04åœ¨æŒ‡å®šçš„æ—¶é—´åˆ é™¤é‚£äº›è¶…è¿‡äº†ä¿å­˜æœŸé™çš„æ¶ˆæ¯ï¼Œæ ‡è¯†å°æ—¶æ•°ï¼Œé»˜è®¤ï¼šå‡Œæ™¨ 4 æ—¶ brokerRole=SYNC_MASTERæœ‰ä¸‰ç§é€‰é¡¹ï¼Œå‰ä¸¤è€…ä¸»è¦æè¿° Broker å®žä¾‹é—´çš„åŒæ­¥æœºåˆ¶ SYNC_MASTERBroker Master çš„é€‰é¡¹ï¼Œæ¶ˆæ¯åŒæ­¥ç»™ Slave ä¹‹åŽæ‰è¿”å›žå‘é€æˆåŠŸçŠ¶æ€ ASYNC_MASTERBroker Master çš„é€‰é¡¹ï¼Œä¸»ä»Žé—´æ¶ˆæ¯åŒæ­¥å¼‚æ­¥å¤„ç† SLAVEBroker Slave çš„é€‰é¡¹ï¼ˆæ²¡å¾—é€‰ï¼‰ flushDiskType=ASYNC_FLUSHæœ‰ä¸¤ç§é€‰é¡¹ï¼Œåˆ†åˆ«åŒæ­¥æˆ–å¼‚æ­¥çš„åˆ·ç›˜ç­–ç•¥ SYNC_FLUSHæ¶ˆæ¯åªæœ‰åœ¨çœŸæ­£å†™å…¥ç£ç›˜ä¹‹åŽæ‰ä¼šè¿”å›žæˆåŠŸçŠ¶æ€ï¼Œç‰ºç‰²æ€§èƒ½ï¼Œä½†å¯ä»¥ç¡®ä¿ä¸ä¸¢å¤±æ¶ˆæ¯ ASYNC_FLUSHå¼‚æ­¥åˆ·ç›˜ï¼Œæ¶ˆæ¯å†™å…¥ page_cache åŽå³è¿”å›žæˆåŠŸ brokerIP1=127.0.0.1è®¾ç½® Broker å¯¹å¤–æš´éœ²çš„ IPï¼Œé€šå¸¸ Broker å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨æŽ¢æµ‹ï¼Œä½†æ˜¯ç”±äºŽå®¹å™¨çŽ¯å¢ƒæˆ–è€…å¤šç½‘å¡çš„å½±å“ï¼Œé€šå¸¸éœ€è¦æ‰‹åŠ¨è®¾ç½®ã€‚éœ€è¦å¤šä¸ªæš´éœ² IP æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ brokerIP2/3/4/... çš„æ–¹å¼é…ç½® listenPort=10911Broker å®žä¾‹ç›‘å¬çš„ç«¯å£å· storePathRootDir=/home/rocketmq/store-aå­˜å‚¨æ¶ˆæ¯å’Œä¸€äº›é…ç½®çš„æ ¹ç›®å½• å‚è€ƒ RocketMQ on GitHub ã€ŠRocketMQ å®žæˆ˜ä¸ŽåŽŸç†è§£æžã€‹æœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾ æ¨å¼€å…ƒ]]></content>
      <categories>
        <category>RocketMQ</category>
      </categories>
      <tags>
        <tag>MQ</tag>
        <tag>RocketMQ</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[RocketMQ é…ç½®æŽ¢ç´¢]]></title>
    <url>%2F2018%2F07%2FRocketMQ-%E9%85%8D%E7%BD%AE%E6%8E%A2%E7%B4%A2%2F</url>
    <content type="text"><![CDATA[ç›®å‰è¢«å¹¿æ³›ä½¿ç”¨çš„ MQ æœ‰å¾ˆå¤šï¼ŒåŒ…æ‹¬ ActiveMQï¼ŒKafkaï¼ŒRabbitMQï¼ŒRocketMQ ç­‰ç­‰ï¼Œå®ƒä»¬å„æœ‰é•¿çŸ­ã€‚è€Œè¿‘æœŸæ‰€åœ¨é¡¹ç›®é€‰æ‹©äº† RocketMQ ä½œä¸ºæ¶ˆæ¯ä¸­é—´ä»¶ï¼Œæ­¤å‰å¹¶æœªç³»ç»Ÿåœ°äº†è§£ç ”ç©¶ï¼Œæ‰€ä»¥è¶æ­¤æœºä¼šæ•´ç†äº†ä¸€äº›ç¬”è®°å’Œæƒ³æ³•ã€‚ ä¼˜åŠ¿ç®€å•åœ°è¯´ä¸€ä¸‹åœ¨è¿™ä¹ˆå¤šæ¶ˆæ¯ä¸­é—´ä»¶ä¸­çš„é€‰åž‹ä¼˜åŠ¿ã€‚ä½œä¸ºé˜¿é‡Œçš„å¼€æºé¡¹ç›®ï¼Œæƒ³å¿…è¿˜æ˜¯å¯é çš„ï¼Œå°¤å…¶æ˜¯ç»å—è¿‡åŒåä¸€çš„è€ƒéªŒä»¤äººä¿¡æœã€‚ æ”¯æŒä¸¥æ ¼çš„æ¶ˆæ¯é¡ºåºï¼› æ”¯æŒ Topic ä¸Ž Queue ä¸¤ç§æ¨¡å¼ï¼› äº¿çº§æ¶ˆæ¯å †ç§¯èƒ½åŠ›ï¼› æ¯”è¾ƒå‹å¥½çš„åˆ†å¸ƒå¼ç‰¹æ€§ï¼› åŒæ—¶æ”¯æŒ Push ä¸Ž Pull æ–¹å¼æ¶ˆè´¹æ¶ˆæ¯ï¼› åŸºæœ¬æ¦‚å¿µ Producerï¼šæ¶ˆæ¯ç”Ÿäº§è€…ï¼Œç”Ÿäº§æ¶ˆæ¯ã€‚ Consumerï¼šæ¶ˆæ¯æ¶ˆè´¹è€…ï¼Œæ¶ˆè´¹æ¶ˆæ¯ã€‚ Pull Consumerï¼šæ¶ˆè´¹è€…æ‹‰æ¨¡åž‹çš„å®žçŽ°ã€‚é€šè¿‡ä¸Ž Broker å»ºç«‹é•¿è¿žæŽ¥ï¼Œä»Žä¸­ä¸»åŠ¨æ‹‰å–æ¶ˆæ¯ã€‚ Push Consumerï¼šæ¶ˆè´¹è€…æŽ¨æ¨¡åž‹çš„å®žçŽ°ã€‚æœ¬è´¨ä»ç„¶æ˜¯å»ºç«‹é•¿è¿žæŽ¥ï¼Œä½†æ˜¯é€šè¿‡æ³¨å†Œç›‘å¬å™¨ï¼Œåœ¨æ”¶åˆ°æ¶ˆæ¯æ—¶å›žè°ƒç›‘å¬æ–¹æ³•ã€‚ Producer Groupï¼šç”Ÿäº§è€…é›†åˆï¼Œé€šå¸¸åŒ…å«å‘é€é€»è¾‘ä¸€è‡´çš„æ¶ˆè´¹è€…ï¼Œå½±å“äº‹åŠ¡æ¶ˆæ¯çš„æµç¨‹ã€‚ Consumer Groupï¼šæ¶ˆè´¹è€…é›†åˆï¼Œé€šå¸¸åŒ…å«æ¶ˆè´¹é€»è¾‘ä¸€è‡´çš„æ¶ˆè´¹è€…ï¼Œå½±å“ç€è´Ÿè½½å‡è¡¡å’Œé›†ç¾¤æ¶ˆæ¯ã€‚ Name Serverï¼šæ³¨å†ŒæœåŠ¡å™¨ï¼Œå¯ä»¥ç”±ä¸€åˆ°å¤šä¸ªè¿‘ä¹Žæ— çŠ¶æ€çš„èŠ‚ç‚¹æž„æˆï¼Œæ‰®æ¼”è€…ç±»ä¼¼ Zookeeper çš„è§’è‰²ã€‚Broker å‘å…¶ä¸­æ³¨å†Œï¼Œè€Œ Producer å’Œ Consumer å‘å…¶ä¸­æ‹‰å– Broker åœ°å€ã€‚ Brokerï¼šæ ¸å¿ƒç»„ä»¶ï¼Œä¿å­˜å’Œè½¬å‘æ¶ˆæ¯ã€‚ æ‹“æ‰‘ç»“æž„å¦‚ä¸‹ï¼š åˆæ¬¡ä½¿ç”¨ä¸‹è½½RocketMQ æ˜¯çº¯ Java è¯­è¨€çš„å®žçŽ°ï¼Œä½ å¯ä»¥ä»Ž Github ä¸Šä¸‹è½½æºç å¹¶ä½¿ç”¨ Maven è¿›è¡Œç¼–è¯‘ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä»Žå®˜ç½‘å…¥å£ä¸‹è½½ã€‚ å¯åŠ¨ç¬¬ä¸€æ¬¡å¯åŠ¨ï¼Œç®€å•åœ°æµ‹è¯•ä¸€ä¸‹æ•ˆæžœï¼Œè¿›å…¥ bin ç›®å½•ï¼Œä½¿ç”¨ nohup å¯åŠ¨ä¸€ä¸‹ NameServiceï¼š nohup ./mqnamesrv -n 127.0.0.1:9876 &amp; ç„¶åŽå¯åŠ¨ä¸€ä¸‹ Brokerï¼š nohup ./mqbroker -n 127.0.0.1:9876 &amp; è¿˜æœ‰ä¸€ä¸ª mqadmin ä¹Ÿæ˜¯å¸¸ç”¨çš„å·¥å…·ï¼ŒåŒ…å«çš„ç®¡ç†å‘˜å¸¸ç”¨çš„åŠŸèƒ½ï¼ŒåŒ…å«æŸ¥çœ‹é›†ç¾¤åˆ—è¡¨ï¼ŒæŸ¥çœ‹ã€åˆ é™¤ä¸»é¢˜ç­‰ï¼Œå¯ä»¥ç›´æŽ¥é€šè¿‡ ./mqadmin èŽ·å¾—å¸®åŠ©ã€‚ æµ‹è¯•åœ¨ RocketMQ é¡ºåˆ©å¯åŠ¨ä¹‹åŽï¼Œè¿›è¡Œä¸€ä¸‹æµ‹è¯•å§ï¼Œå¿«é€Ÿçš„ä½“éªŒä¸€æŠŠã€‚ä»Ž MavenRepository æ‰¾åˆ°å¯¹åº”çš„ RocketMQ å®¢æˆ·ç«¯ï¼š123456&lt;!-- https://mvnrepository.com/artifact/org.apache.rocketmq/rocketmq-client --&gt;&lt;dependency&gt; &lt;groupId&gt;org.apache.rocketmq&lt;/groupId&gt; &lt;artifactId&gt;rocketmq-client&lt;/artifactId&gt; &lt;version&gt;4.2.0&lt;/version&gt;&lt;/dependency&gt; æˆ–è€…æ‰“å¼€åˆšæ‰ä»Ž Github ä¸Šä¸‹è½½çš„æºç ï¼Œexample æ¨¡å—ä¸‹æä¾›äº†è®¸å¤šæµ‹è¯•ç”¨ä¾‹ï¼Œé™„ä¸Šç•¥å¾®æ”¹åŠ¨çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä»£ç ï¼š ç”Ÿäº§è€… 123456789101112131415161718192021222324252627282930public static void main(String[] args) throws MQClientException, InterruptedException &#123; DefaultMQProducer producer = new DefaultMQProducer("ProducerGroupName"); producer.setNamesrvAddr("127.0.0.1:9876"); producer.setInstanceName("p001"); // å¯ä»¥è®¾å®šå¤±è´¥é‡è¯•æ¬¡æ•° producer.setRetryTimesWhenSendFailed(3); producer.start(); for (int i = 0; i &lt; 1; i++) &#123; try &#123; Message msg = new Message( "TopicTest1", "TagA", "key113", "Hello world".getBytes(RemotingHelper.DEFAULT_CHARSET)); SendResult sendResult = producer.send(msg); System.out.printf("%s%n", sendResult); QueryResult queryMessage = producer.queryMessage("TopicTest1", "key113", 10, 0, System.currentTimeMillis()); for (MessageExt m : queryMessage.getMessageList()) &#123; System.out.printf("%s%n", m); &#125; &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125; producer.shutdown();&#125; æ¶ˆè´¹è€… 1234567891011121314151617181920212223242526public static void main(String[] args) throws InterruptedException, MQClientException &#123; DefaultMQPushConsumer consumer = new DefaultMQPushConsumer("ConsumerGroupName"); // æŒ‡å®š NameServer çš„åœ°å€ï¼Œå¤šä¸ª NameServer ä½¿ç”¨ ; éš”å¼€ consumer.setNamesrvAddr("127.0.0.1:9876"); consumer.setInstanceName("c001"); // æŒ‡å®šè®¢é˜…çš„ Topic ä»¥åŠ Tagï¼Œå¤šä¸ª Tag ä½¿ç”¨ || åˆ†å¼€ï¼Œ* ä»£è¡¨å…¨éƒ¨ Tag consumer.subscribe("TopicATest1", "TagA"); // å¯ä»¥è®¾å®šå¼€å§‹æ¶ˆè´¹çš„ä½ç½®ï¼Œä»…é’ˆå¯¹ Push Consumer consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_FIRST_OFFSET); // å¯ä»¥è®¾å®šæ‰¹é‡æ¶ˆè´¹æ•°é‡ï¼Œé»˜è®¤ 1ï¼Œä¸ä¿è¯æ¯æ¬¡çš„æ•°é‡ï¼Œè¿‘é’ˆå¯¹ Push Consumer consumer.setConsumeMessageBatchMaxSize(1); consumer.registerMessageListener(new MessageListenerConcurrently() &#123; @Override public ConsumeConcurrentlyStatus consumeMessage( List&lt;MessageExt&gt; msgs, ConsumeConcurrentlyContext context) &#123; for (MessageExt msg : msgs) &#123; System.out.println(new String(msg.getBody())); &#125; return ConsumeConcurrentlyStatus.CONSUME_SUCCESS; &#125; &#125;); consumer.start(); System.out.println("Consumer Started.");&#125; åŠ¨æ‰‹è¿è¡Œä¸€ä¸‹å§ã€‚ å…³äºŽé…ç½®äº‹å®žä¸Šï¼Œå¤§å¤šæ•°å°ä¼™ä¼´åœ¨ RocketMQ å¯åŠ¨æ—¶éƒ½æ˜Žæ˜¾èƒ½æ„Ÿè§‰ç”µè„‘å¡å¡çš„ï¼Œæ˜¯å› ä¸º RocketMQ é»˜è®¤éœ€æ±‚çš„å†…å­˜å¤ªå¤§äº†ã€‚é‚£ä¹ˆï¼Œå¦‚ä½•æŸ¥çœ‹å’Œä¿®è®¢æ‰€éœ€è¦çš„é…ç½®å‘¢ï¼Ÿä¹‹å‰æˆ‘ä»¬é€šè¿‡ ./mqbroker å¯åŠ¨äº† Brokerï¼Œé‚£ä¹ˆæ¥çœ‹ä¸€ä¸‹ mqbroker çš„è„šæœ¬ï¼Œæ³¨æ„è„šæœ¬æœ«å°¾çš„å‘½ä»¤ï¼š12# çœç•¥ ROCKETMQ_HOME çš„é…ç½®sh $&#123;ROCKETMQ_HOME&#125;/bin/runbroker.sh org.apache.rocketmq.broker.BrokerStartup $@ è¿™é‡Œå°†å¯åŠ¨å‘½ä»¤è½¬ç§»ç»™äº† runbroker.sh è¿›è¡Œæ‰§è¡Œã€‚ JVM å‚æ•°é…ç½®æ—¢ç„¶å¦‚æ­¤ï¼Œç»§ç»­æŸ¥çœ‹ä¸€ä¸‹ runbroker.shï¼š12345678910111213141516171819202122232425262728293031323334353637383940414243444546#!/bin/sh#===========================================================================================# Java Environment Setting#===========================================================================================error_exit ()&#123; echo "ERROR: $1 !!" exit 1&#125;[ ! -e "$JAVA_HOME/bin/java" ] &amp;&amp; JAVA_HOME=$HOME/jdk/java[ ! -e "$JAVA_HOME/bin/java" ] &amp;&amp; JAVA_HOME=/usr/java[ ! -e "$JAVA_HOME/bin/java" ] &amp;&amp; error_exit "Please set the JAVA_HOME variable in your environment, We need java(x64)!"export JAVA_HOMEexport JAVA="$JAVA_HOME/bin/java"export BASE_DIR=$(dirname $0)/..export CLASSPATH=.:$&#123;BASE_DIR&#125;/conf:$&#123;CLASSPATH&#125;#===========================================================================================# JVM Configuration#===========================================================================================JAVA_OPT="$&#123;JAVA_OPT&#125; -server -Xms8g -Xmx8g -Xmn4g"JAVA_OPT="$&#123;JAVA_OPT&#125; -XX:+UseG1GC -XX:G1HeapRegionSize=16m -XX:G1ReservePercent=25 -XX:InitiatingHeapOccupancyPercent=30 -XX:SoftRefLRUPolicyMSPerMB=0 -XX:SurvivorRatio=8 -XX:+DisableExplicitGC"JAVA_OPT="$&#123;JAVA_OPT&#125; -verbose:gc -Xloggc:/dev/shm/mq_gc_%p.log -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintGCApplicationStoppedTime -XX:+PrintAdaptiveSizePolicy"JAVA_OPT="$&#123;JAVA_OPT&#125; -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=30m"JAVA_OPT="$&#123;JAVA_OPT&#125; -XX:-OmitStackTraceInFastThrow"JAVA_OPT="$&#123;JAVA_OPT&#125; -XX:+AlwaysPreTouch"JAVA_OPT="$&#123;JAVA_OPT&#125; -XX:MaxDirectMemorySize=15g"JAVA_OPT="$&#123;JAVA_OPT&#125; -XX:-UseLargePages -XX:-UseBiasedLocking"JAVA_OPT="$&#123;JAVA_OPT&#125; -Djava.ext.dirs=$&#123;BASE_DIR&#125;/lib"#JAVA_OPT="$&#123;JAVA_OPT&#125; -Xdebug -Xrunjdwp:transport=dt_socket,address=9555,server=y,suspend=n"JAVA_OPT="$&#123;JAVA_OPT&#125; $&#123;JAVA_OPT_EXT&#125;"JAVA_OPT="$&#123;JAVA_OPT&#125; -cp $&#123;CLASSPATH&#125;"numactl --interleave=all pwd &gt; /dev/null 2&gt;&amp;1if [ $? -eq 0 ]then if [ -z "$RMQ_NUMA_NODE" ] ; then numactl --interleave=all $JAVA $&#123;JAVA_OPT&#125; $@ else numactl --cpunodebind=$RMQ_NUMA_NODE --membind=$RMQ_NUMA_NODE $JAVA $&#123;JAVA_OPT&#125; $@ fielse $JAVA $&#123;JAVA_OPT&#125; $@fi é€šè¿‡è¿™ä¸ªæ–‡ä»¶å¯ä»¥èŽ·å¾—å¾ˆå¤šä¿¡æ¯ï¼š RocketMQ çš„ JVM é…ç½®ä¿¡æ¯ éœ€æ±‚çš„å†…å­˜ç©ºé—´è¾¾åˆ°äº† 8gï¼Œå£°æ˜Žçš„æœ€å¤§å †å¤–å†…å­˜è¾¾åˆ°äº† 15gï¼Œè¿™å°±æ˜¯ç”µè„‘å˜å¾—å¡å¡çš„çš„åŽŸå› äº†ã€‚ å¯ä»¥åœ¨å¯åŠ¨æ—¶é…ç½® JAVA_OPT_EXT å˜é‡æ¥é…ç½®é¢å¤–çš„å‚æ•°æˆ–è€…è¦†ç›–é»˜è®¤é…ç½®ã€‚ ç»“åˆ mqbroker.sh å¯ä»¥å‘çŽ°ï¼Œæœ€ç»ˆä½¿ç”¨äº† BrokerStartup æ¥å¯åŠ¨ RocketMQï¼Œå‘½ä»¤è¡Œä¸­çš„å‚æ•°åŒæ—¶ä¼šè¢«ä¼ é€’ã€‚ Broker å®žä¾‹é…ç½®é‚£ä¹ˆæŽ¥ä¸‹æ¥å°±åŽ» BrokerStartup æŸ¥çœ‹ä¸€ä¸‹ RocketMQ çš„å¯åŠ¨è¿‡ç¨‹ã€‚ç”±äºŽè¿™ä¸ªæ–‡ä»¶å®žåœ¨æ˜¯å¤ªè¿‡å†—é•¿ï¼Œè¿™é‡Œä¸å†è´´å‡ºï¼Œæ„Ÿå…´è¶£çš„å°ä¼™ä¼´è¯·è‡ªè¡ŒæŸ¥çœ‹ã€‚åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œä¸»è¦å¯¹å‘½ä»¤è¡Œä¸­å‡ ä¸ªå…·ä½“å‚æ•°è¿›è¡Œäº†è§£æžï¼š -mï¼šåˆ—å‡ºæ‰€æœ‰çš„é…ç½®é¡¹ -pï¼šåˆ—å‡ºæ‰€æœ‰çš„é…ç½®é¡¹ä»¥åŠé»˜è®¤å€¼ -cï¼šæŒ‡å®šä¸€ä¸ª properties æ–‡ä»¶ï¼Œè¯»å–å…¶ä¸­çš„å†…å®¹è¦†ç›–é»˜è®¤é…ç½®å¹¶æƒ…åŠ¨ è‡ªå®šä¹‰é…ç½®æ‰€ä»¥ï¼Œå¾ˆå¤šæ—¶å€™çš„åšæ³•æ˜¯é€šè¿‡ sh mqbroker -p &gt; mqbroker.properties æ¥èŽ·å¾—ä¸€ä»½é»˜è®¤é…ç½®æ–‡ä»¶ï¼ˆç½‘ä¸Šçš„æ–¹æ¡ˆå¯èƒ½ä¸å¤ªå‡†ç¡®ï¼Œå…·ä½“è¾“å‡ºæ˜¯æºå¸¦ Rocket çš„æ—¥å¿—ä¿¡æ¯çš„ï¼Œéœ€è¦ sed æˆ–è€… awk ä¹‹ç±»åŠ å·¥å¤„ç†ä¸€ä¸‹ï¼‰ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œé…ç½®è‡ªå®šä¹‰ï¼Œç„¶åŽé€šåŽé€šè¿‡ sh mqbroker -c mqbroker.properties æ¥è¿›è¡Œå®šåˆ¶åŒ–çš„å¯åŠ¨ã€‚ é»˜è®¤é…ç½®æ–¹æ¡ˆåŒæ—¶åœ¨ conf ç›®å½•ä¸‹ï¼Œå®˜æ–¹ä¹Ÿç»™å‡ºäº†å‡ ç§å…¸åž‹çš„é…ç½®æ–¹æ¡ˆä¾›å‚è€ƒï¼š äºŒä¸»äºŒä»Žå¼‚æ­¥å¤åˆ¶ï¼š2m-2s-async æ–‡ä»¶å¤¹ã€‚è¿™æ˜¯æœ€å…¸åž‹çš„ç”Ÿäº§é…ç½®ï¼ŒåŒ master èŽ·å¾—é«˜å¯ç”¨æ€§ï¼ŒåŒæ—¶ä¸»ä»Žé—´çš„æ•°æ®åŒæ­¥ç”±å¼‚æ­¥å®Œæˆã€‚ äºŒä¸»äºŒä»ŽåŒæ­¥å¤åˆ¶ï¼š2m-2s-sync æ–‡ä»¶å¤¹ã€‚é™¤äº†åŒ master çš„é…ç½®ï¼Œä¸»ä»Žé—´çš„æ•°æ®æ˜¯åŒæ­¥çš„ï¼Œä¹Ÿå°±æ˜¯è¯´åªæœ‰åœ¨å‘ salve æˆåŠŸåŒæ­¥æ•°æ®æ‰ä¼šå‘å®¢æˆ·æ®µè¿”å›žæˆåŠŸã€‚è¿™ä¿è¯äº†åœ¨ master å®•æœºæ—¶å€™æ¶ˆæ¯ä»ç„¶å¯ä»¥è¢«å®žæ—¶æ¶ˆè´¹ï¼Œä½†æ˜¯æ€§èƒ½æ”¶åˆ°ä¸€å®šå½±å“ã€‚ äºŒä¸»æ— ä»Žï¼š2m-nosalve æ–‡ä»¶å¤¹ã€‚åŒä¸»æ¨¡å¼ä»…ä»…ä¿è¯äº† RocketMQ çš„é«˜å¯ç”¨æ€§ï¼Œç„¶è€Œåœ¨ä¸€å° master å®•æœºåŽï¼Œå®¢æˆ·ç«¯æ— æ³•æ¶ˆè´¹é‚£æ‰¹åœ¨å®•æœº master ä¸ŠæŒä¹…åŒ–çš„æ¶ˆæ¯ï¼Œç›´åˆ°å®•æœº master æ¢å¤æ­£å¸¸ã€‚å½“ç„¶è¿™ä¸ªæ–¹æ¡ˆèŠ‚çœäº†ç¡¬ä»¶èµ„æºã€‚ ä¸‰ç§é»˜è®¤é…ç½®æ–¹æ¡ˆéƒ½æ˜¯é‡‡ç”¨äº†å¼‚æ­¥åˆ·ç›˜ï¼Œå°½ç®¡åœ¨åˆ·ç›˜é—´éš™å®•æœºä¼šä¸¢å¤±å°‘é‡æ•°æ®ï¼Œä½†æ˜¯æ•ˆçŽ‡æå‡å¯è§‚ã€‚ å‚è€ƒé…ç½®ç±»Broker çš„å…·ä½“é…ç½®åˆ†ä¸ºäº†å…·ä½“çš„å››ä¸ªæ–¹é¢ï¼š Broker å®žä¾‹é…ç½®ï¼šå‚è€ƒæºç  org.apache.rocketmq.common.BrokerConfig Netty æœåŠ¡ç«¯é…ç½®ï¼šå‚è€ƒæºç  org.apache.rocketmq.remoting.netty.NettyServerConfig Netty å®¢æˆ·ç«¯é…ç½®ï¼šå‚è€ƒæºç  org.apache.rocketmq.remoting.netty.NettyClientConfig Message æŒä¹…åŒ–é…ç½®ï¼šå‚è€ƒæºç  org.apache.rocketmq.store.config.MessageStoreConfig å…³äºŽ RocketMQ çš„å¯åŠ¨å’Œé…ç½®ï¼Œå°±å…ˆå‘Šä¸€æ®µè½ã€‚]]></content>
      <categories>
        <category>RocketMQ</category>
      </categories>
      <tags>
        <tag>MQ</tag>
        <tag>RocketMQ</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å®žçŽ° MyBatis æ’ä»¶]]></title>
    <url>%2F2018%2F07%2F%E5%AE%9E%E7%8E%B0-MyBatis-%E6%8F%92%E4%BB%B6%2F</url>
    <content type="text"><![CDATA[MyBatis ä½œä¸ºä¸€ä¸ªç›®å‰å¾ˆå¸¸ç”¨çš„æŒä¹…åŒ–æ¡†æž¶ï¼Œæœ‰ç€ä¸°å¯Œçš„æ‹“å±•ã€‚è¿™äº›æ‹“å±•åŠŸèƒ½å¸¸å¸¸ä»¥æ’ä»¶çš„å½¢å¼åµŒå…¥åˆ° MyBatis çš„è¿ä½œæµç¨‹ä¹‹ä¸­ï¼Œè€Œå¦‚ä½•åˆ¶ä½œå®žçŽ°ä¸€ä¸ªæ’ä»¶ï¼ŸMyBatis å·²ç»ä¸ºå¤§å®¶è®¾è®¡å¥½äº†ï¼Œä¸€ä¸ª Interceptor æŽ¥å£ï¼Œå®žçŽ°å®ƒå°±å¤Ÿäº†ã€‚ Interceptor æŽ¥å£çš„æ‹¦æˆªç›®æ ‡ï¼Œæ˜¯ MyBatis è¿ä½œæµç¨‹ä¸­çš„å‡ ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š Executorï¼šè¿™æ˜¯ MyBatis æ‰§è¡Œå™¨ï¼ŒæŽ§åˆ¶ç€æ‰€æœ‰å’Œæ•°æ®åº“äº¤äº’çš„æ“ä½œï¼Œä¹Ÿå½±å“ç€ä¸€çº§ç¼“å­˜ã€‚ ParameterHandlerï¼šå‚æ•°å¤„ç†å™¨ï¼Œåœ¨æ˜ å°„å‚æ•°æ—¶å€™ç”Ÿæ•ˆã€‚ ResultSetHandlerï¼šç»“æžœé›†å¤„ç†å™¨ï¼Œåœ¨å¤„ç†ç»“æžœé›†çš„æ—¶å€™ä¼šç”¨åˆ°ã€‚ StatementHandlerï¼šExecutor ä¸‹å±‚çš„å¤„ç†å™¨ï¼ŒåŒæ ·æŽ§åˆ¶ç€ SQL è¡Œä¸ºï¼Œä¹ŸæŽ§åˆ¶ç€äºŒçº§ç¼“å­˜çš„ç”Ÿæ•ˆã€‚ è¿™å‡ ä¸ªç»„ä»¶å°±ç®€ç§°å¤„ç†å™¨å¯¹è±¡å§ï¼Œæ„Ÿå…´è¶£çš„è¯ï¼Œå¯ä»¥è·Ÿè¿›èµ„æ–™ï¼Œè¿™é‡Œç»§ç»­æ¥è®²æ’ä»¶å¦‚ä½•æ‹¦æˆªå®ƒä»¬ä»¥åŠå¦‚ä½•å®žçŽ°ä¸€ä¸ªæ’ä»¶ã€‚ Interceptor æŽ¥å£Interceptor æŽ¥å£æ˜¯æ’ä»¶çš„æ ¸å¿ƒï¼Œçœ‹ä¸€ä¸‹å®ƒçš„æŽ¥å£ï¼š12345678public interface Interceptor &#123; // æ‹¦æˆªåŽçš„é€»è¾‘ Object intercept(Invocation invocation) throws Throwable; // å°†å¤„ç†å™¨å¯¹è±¡åŒ…è£…æˆä»£ç†ç±» Object plugin(Object target); // åˆå§‹åŒ–å±žæ€§èµ‹å€¼ void setProperties(Properties properties);&#125; intercept()ï¼šæ‹¦æˆª MyBatis çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œéœ€è¦åœ¨å…¶ä¸­åŠ å…¥å®šåˆ¶çš„é€»è¾‘ã€‚ plugin()ï¼šå¯ä»¥ç†è§£ä¸ºæ’ä»¶çš„æž„é€ è¿‡ç¨‹ï¼Œé€šå¸¸æŠŠ MyBatis çš„å‡ ä¸ª handler åŒ…è£…æˆä»£ç†ç”¨ã€‚ setProperties()ï¼šç”¨äºŽæ’ä»¶åˆå§‹åŒ–æ—¶å€™çš„å±žæ€§èµ‹å€¼ã€‚å¦‚æžœä½ æœ‰å…¶ä»–çš„èµ‹å€¼æ–¹æ¡ˆï¼Œä¹Ÿå¯ä»¥ä¸é‡‡ç”¨å®ƒã€‚ æˆ‘ä»¬ä»Žç¬¬ä¸€ä¸ªæ–¹æ³•å¼€å§‹è®²èµ·ã€‚ Object intercept(Invocation invocation)å…¥å‚ Invocation æ˜¯ä¸€ä¸ª MyBatis å°è£…çš„å¯¹è±¡ï¼ŒåŒ…å«äº†è¿è¡Œæ—¶çš„ä¿¡æ¯ï¼š å±žæ€§Method methodï¼šå³åå°„åŒ…ä¸­çš„ Methodï¼Œåœ¨è¿™é‡Œå®ƒæ˜¯å½“å‰è¿è¡Œçš„æ–¹æ³•ã€‚ å±žæ€§Object[] argsï¼šæ–¹æ³•çš„å‚æ•°åˆ—è¡¨ å±žæ€§Object targetï¼šè¿™é‡Œå…¶å®žæ˜¯ä½ é€‰æ‹©æ‹¦æˆªçš„å¤„ç†å™¨å¯¹è±¡ï¼ˆå…³äºŽå¦‚ä½•é€‰æ‹©æ‹¦æˆªå…·ä½“çš„å¤„ç†å™¨å¯¹è±¡ï¼Œç¨åŽå†è¿°ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒå¯ä»¥æ˜¯ Executor / StatementHandler â€¦ï¼Œéœ€è¦ä½¿ç”¨æ—¶å¯ä»¥ç›´æŽ¥å¼ºè½¬ã€‚ æ–¹æ³• proceed()ï¼šè®©å¤„ç†å™¨ç»§ç»­æµç¨‹ï¼Œæˆ–è€…è°ƒç”¨ä¸‹ä¸€ä¸ªæ’ä»¶ï¼Œä½ å¯ä»¥ç”¨ Filter.doFilter() æ¥ç±»æ¯”å®ƒã€‚ MyBatis æ’ä»¶æ˜¯é€šè¿‡åŠ¨æ€ä»£ç†å®žçŽ°çš„ï¼Œå¯¹å¤„ç†å™¨å¯¹è±¡è¿›è¡Œä»£ç†ï¼Œç”±ä»£ç†å¯¹è±¡åœ¨æ–¹æ³• invoke() å‰å®Œæˆæ’ä»¶ä¸­ interceptor() æ–¹æ³•ï¼ˆå³æ’ä»¶é€»è¾‘ï¼‰ã€‚åŒæ—¶å¤šä¸ªæ’ä»¶åˆæ˜¯å¤šå±‚çš„ä»£ç†ï¼Œæ¯ä¸ªæ’ä»¶éƒ½éœ€è¦åœ¨å…·ä½“æ–¹æ³•è°ƒç”¨å‰å®Œæˆè‡ªå·±çš„é€»è¾‘ï¼Œæ‰€ä»¥åœ¨å®žçŽ° Interceptor æŽ¥å£çš„ intercept æ–¹æ³•æœ€åŽï¼Œä¸€å®šè¦è®°å¾—æ‰§è¡Œ Invocation.proceed()ï¼Œä»¥å®Œæˆæ’ä»¶çš„è°ƒç”¨é“¾ï¼š1234567@Overridepublic Object intercept(Invocation invocation) throws Throwable &#123; // å¯ä»¥é€šè¿‡ invocation èŽ·å¾—å¤„ç†å™¨å¯¹è±¡ï¼Œè¿›è€Œå¯ä»¥å˜æ›´å‚æ•°ï¼ŒåŸ‹ç‚¹ï¼Œæ”¶é›†ä¿¡æ¯ç­‰ // do something // æœ€åŽéœ€è¦è®°å¾—å®Œæˆè°ƒç”¨é“¾ï¼Œå¦åˆ™æµç¨‹å°†ä¸­æ®µ return invocation.proceed();&#125; Object Plugin(Object)è¯¥æ–¹æ³•åœ¨å¤„ç†å™¨å¯¹è±¡åˆå§‹åŒ–çš„æ—¶å€™ï¼Œç”± InterceptorChain.pluginAll() è°ƒç”¨ï¼Œå°†å¤„ç†å™¨å¯¹è±¡åŒ…è£…æˆä»£ç†ç±»ã€‚å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªåˆå§‹åŒ–æ–¹æ³•ã€‚ ä»¥ StatementHandler ä¸¾ä¾‹ï¼š1234567891011121314public StatementHandler newStatementHandler(Executor executor, MappedStatement mappedStatement, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql) &#123; StatementHandler statementHandler = new RoutingStatementHandler(executor, mappedStatement, parameterObject, rowBounds, resultHandler, boundSql); // åˆå§‹æ—¶è§¦å‘ä»£ç†åŒ…è£… statementHandler = (StatementHandler) interceptorChain.pluginAll(statementHandler); return statementHandler;&#125;public Object pluginAll(Object target) &#123; // è¿­ä»£å®Œæˆæ‰€æœ‰æ’ä»¶ä»£ç†ï¼Œæœ€ç»ˆè¿”å›žä¸€ä¸ªåŒ…å«æ‰€æœ‰æ’ä»¶é€»è¾‘çš„å¤„ç†å™¨å¯¹è±¡ä»£ç† for (Interceptor interceptor : interceptors) &#123; target = interceptor.plugin(target); &#125; return target;&#125; è¯¥æ–¹æ³•çš„æœ¬è´¨ç›®çš„æ˜¯ä½¿å¾—æ–°çš„ä»£ç†ç±»åœ¨æ‹¦æˆªçš„ç›®æ ‡æ–¹æ³•ä»¥åŠä¹‹å‰çš„æ’ä»¶é€»è¾‘ä¹‹å‰æ·»åŠ ä¸Šæ–°æ’ä»¶çš„ intercept() æ–¹æ³•ä¸­çš„å†…å®¹ã€‚æ‰€ä»¥è¯¥æ–¹æ³• Object ç±»åž‹çš„å…¥å‚ä¸Žå‡ºå‚è‡ªç„¶ä¹Ÿå°±æ˜¯å¤„ç†å™¨æŽ¥å£å¯¹è±¡äº†ã€‚åœ¨æ²¡æœ‰ç‰¹æ®Šéœ€æ±‚çš„æƒ…å†µä¸‹ï¼ŒæŽ¨èä½¿ç”¨å®˜æ–¹å·¥å…·ç±» Plugin.wrap() æ–¹æ³•æ¥å®Œæˆï¼š1234@Overridepublic Object plugin(Object target) &#123; return Plugin.wrap(target, this);&#125; åŽŸå› å˜›â€¦å…ˆæ¥çœ‹ä¸€ä¸‹ Plugin.wrap()ï¼š123456789101112131415161718192021222324252627282930public static Object wrap(Object target, Interceptor interceptor) &#123; // æ’ä»¶ä¸Šéƒ½é€šè¿‡ @Interceptors æŒ‡å®šäº†è¦æ‹¦æˆªçš„å¤„ç†å™¨ï¼Œä»¥åŠè¦æ‹¦æˆªçš„æ–¹æ³•å’Œå‚æ•°ï¼Œæ”¶é›†èµ·æ¥ // èŽ·å¾—è¿™ä¸ªæ’ä»¶æƒ³æ‹¦æˆªçš„ç±»-æ–¹æ³• Map&lt;Class&lt;?&gt;, Set&lt;Method&gt;&gt; signatureMap = getSignatureMap(interceptor); // è¿™ä¸ª type å¿…ç„¶æ˜¯ 4 å¤§æ‰§è¡Œå™¨/å¤„ç†å™¨ æŽ¥å£å®žçŽ°ä¹‹ä¸€ Class&lt;?&gt; type = target.getClass(); // èŽ·å¾—åŽŸæ¥çš„æ‰€å®žçŽ°çš„æŽ¥å£ï¼ŒåŠ¨æ€ä»£ç†çš„å¿…è¦æ­¥éª¤ Class&lt;?&gt;[] interfaces = getAllInterfaces(type, signatureMap); // å¦‚æžœè¯¥æ’ä»¶æ²¡æœ‰æ‹¦æˆªè¿™ä¸ªå¤„ç†å™¨ï¼Œåœ¨ä¸Šä¸€ä¸ªæ–¹æ³•ä¼šè¿”å›žç©ºæ•°ç»„ï¼Œè¿™é‡Œå°±ä¸åŒ…è£…äº† if (interfaces.length &gt; 0) &#123; return Proxy.newProxyInstance( type.getClassLoader(), interfaces, new Plugin(target, interceptor, signatureMap)); &#125; return target;&#125;@Overridepublic Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; try &#123; Set&lt;Method&gt; methods = signatureMap.get(method.getDeclaringClass()); if (methods != null &amp;&amp; methods.contains(method)) &#123; return interceptor.intercept(new Invocation(target, method, args)); &#125; return method.invoke(target, args); &#125; catch (Exception e) &#123; throw ExceptionUtil.unwrapThrowable(e); &#125;&#125; å¥½å¤„åœ¨äºŽï¼Œä¸åœ¨éœ€è¦å¼€å‘è€…æ‰‹åŠ¨æž„å»ºä¸€ä¸ªåŠ¨æ€ä»£ç†ï¼ˆPlugin æœ¬èº«å°±æ˜¯ä¸€ä¸ª InvocationHandler å®žçŽ°ç±»ï¼‰ï¼Œå¹¶ä¸”åœ¨åŒ…è£…æˆä»£ç†çš„æ—¶å€™ï¼Œå°†å››ä¸ªå¤„ç†å™¨ä¸­ä¸éœ€è¦æ‹¦æˆªçš„ç±»æŽ’é™¤äº†ï¼Œè¿™ä½¿å¾—è¿è¡Œä¸­å‡å°‘ä¸€å±‚ä¸å¿…è¦çš„ä»£ç†ï¼Œè¿›è€Œæå‡æ•ˆçŽ‡ã€‚ @Intercepts æ³¨è§£æ’ä»¶çš„æ‹¦æˆªæµç¨‹éƒ½å·²ç»æ˜Žäº†ï¼Œå›žè¿‡æ¥æ¢³ç†ä¸€ä¸‹å¦‚ä½•æ‹¦æˆªè‡ªå·±æƒ³è¦çš„æŒ‡å®šçš„å¤„ç†å™¨å’ŒæŒ‡å®šçš„æ–¹æ³•å‘¢ï¼Ÿ åœ¨å®žçŽ°äº† Interceptor æŽ¥å£ä¹‹åŽï¼Œéœ€è¦é…åˆ @Intercpts æ³¨è§£ä¸€èµ·ä½¿ç”¨ã€‚è¿™ä¸ªæ³¨è§£ä¸­éœ€è¦å®‰ç½®ä¸€ä¸ª Signature å¯¹è±¡ï¼Œåœ¨å…¶ä¸­æŒ‡å®šä½ éœ€è¦æŒ‡å®šï¼š typeï¼šé€‰æ‹© 4 ä¸ªå¤„ç†å™¨ç±»ä¹‹ä¸€ã€‚ methodï¼šé€‰æ‹©äº†å¤„ç†å™¨ä¹‹åŽï¼Œä½ éœ€è¦é€‰æ‹©æ‹¦æˆªé‚£äº›æ–¹æ³•ã€‚ argsï¼šé€‰æ‹©æ‹¦æˆªçš„æ–¹æ³•çš„å‚æ•°åˆ—è¡¨ã€‚å› ä¸ºå¦‚ Executor ä¸­ query æ–¹æ³•æ˜¯æœ‰é‡è½½çš„ã€‚ é€šè¿‡ä»¥ä¸Šä¸‰è€…ï¼Œæ’ä»¶ä¾¿ç¡®å®šäº†æ‹¦æˆªå“ªä¸ªå¤„ç†å™¨çš„å“ªä¸ªæ–¹æ³•ã€‚MyBatis çš„æ’ä»¶å®žçŽ°æ˜¯ä¸æ˜¯å¾ˆç®€å•å‘¢ï¼Ÿ éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒExector å’Œ StatementHandler åœ¨ä¸€äº›åŠŸèƒ½ä¸Šç±»ä¼¼ï¼Œä½†æ˜¯ä¼šå½±å“ä¸åŒçº§åˆ«çš„ç¼“å­˜ï¼Œéœ€è¦æ³¨æ„ã€‚åŒæ—¶ç”±äºŽ sqlSession ä¸­è¿™ 4 ä¸ªå¤„ç†å™¨å¯¹è±¡çš„åŠŸèƒ½ç€å®žå¼ºå¤§ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡æ‹¦æˆªæ”¹å˜æ•´ä¸ª SQL çš„è¡Œä¸ºï¼Œæ‰€ä»¥å¦‚æžœéœ€è¦æ·±å…¥å®šåˆ¶æ’ä»¶è¡Œä¸ºçš„æ—¶å€™ï¼Œæœ€å¥½éœ€è¦å¯¹ MyBatis æ ¸å¿ƒæœºåˆ¶ç”±ä¸€å®šçš„äº†è§£ã€‚ å®˜æ–¹ä»‹ç»http://www.mybatis.org/mybatis-3/zh/configuration.html#plugins]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>MyBatis</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Docker æŒ‚è½½ä¸Žæ•°æ®å­˜å‚¨]]></title>
    <url>%2F2018%2F07%2FDocker%2F</url>
    <content type="text"><![CDATA[Docker é•œåƒæ˜¯å±‚å±‚åˆ†ç¦»çš„ï¼Œåˆ†ä¸ºåªè¯»çš„åº•å±‚å’Œå¯è¯»å†™çš„å½“å‰å±‚ã€‚å®¹å™¨åœ¨è¿è¡Œæ—¶å€™å¦‚æžœæœ‰æ–‡ä»¶æ”¹åŠ¨ï¼Œä¼šè‡ªåŠ¨ä»Žå«æœ‰è¯¥æ–‡ä»¶çš„åº•å±‚æ‹·è´å¹¶æ›´æ–°åœ¨å½“å‰å±‚ã€‚å¦‚æžœå®¹å™¨åœ¨ commit ä¹‹å‰è¢«é”€æ¯ï¼Œé‚£ä¹ˆæœ‰è¿™ä¸ªé•œåƒé‡æ–°ç”Ÿæˆçš„å®¹å™¨æ˜¯ä¸åŒ…å«æ”¹åŠ¨çš„å†…å®¹çš„ã€‚ éœ€æ±‚æ¥æºæ‰€ä»¥æ•°æ®é—®é¢˜æ˜¯ä½¿ç”¨ Docker å¿…ç„¶ä¼šå…³æ³¨åˆ°çš„ï¼Œé™¤äº†å¦‚ä½•æŒä¹…åŒ–ä»¥å¤–ï¼Œå¦‚ä½•ä»Žå®¿ä¸»æœºè®¿é—®åˆ°å®¹å™¨å†…çš„æ•°æ®ï¼Ÿæˆ–è€…å°†å®¹å™¨å†…çš„æ•°æ®åŒæ­¥åˆ°å®¿ä¸»æœºï¼Ÿåˆæˆ–æ˜¯å¤šä¸ªå®¹å™¨é—´æ€Žä¹ˆå…±äº«æ•°æ®ï¼Ÿè¿™éƒ½æ˜¯è¦å¤„ç†çš„ã€‚ è¿˜å¥½ Docker æä¾›äº†ä¸€å¥—å®Œå–„è€Œç®€å•çš„æ•°æ®æŒ‚è½½æœºåˆ¶ Volumeã€‚ å‘½åå·è¦æŽ§åˆ¶å®¹å™¨çš„æ•°æ®å†…å®¹ï¼Œé¦–å…ˆä»Žæ–‡ä»¶çš„æŒ‚è½½å¼€å§‹ã€‚docker volume æä¾›äº†ä¸€å¥—ç®¡ç†å·ï¼ˆvolumeï¼‰çš„ APIï¼š12345678910Usage: docker volume COMMANDManage volumesCommands: create Create a volume inspect Display detailed information on one or more volumes ls List volumes prune Remove all unused local volumes rm Remove one or more volumes å…ˆåˆ›å»ºä¸€ä¸ª named volumeï¼šdocker volume create volä½¿ç”¨ docker volume ls å¯ä»¥çœ‹åˆ°å½“å‰å­˜åœ¨çš„æ‰€æœ‰çš„ volumeã€‚ä½¿ç”¨ docker volume rm åˆ é™¤æŒ‡å®šçš„ volumeã€‚ä½¿ç”¨ docker volume inspect vol å¯ä»¥çœ‹åˆ°å®ƒçš„è¯¦æƒ…ï¼ŒåŒ…æ‹¬åˆ›å»ºæ—¶é—´å’Œå®¿ä¸»æœºä¸Šçš„çœŸæ­£æŒ‚è½½ä½ç½®ç­‰ï¼š [ { &quot;CreatedAt&quot;: &quot;2018-07-09T14:53:05Z&quot;, &quot;Driver&quot;: &quot;local&quot;, &quot;Labels&quot;: {}, &quot;Mountpoint&quot;: &quot;/var/lib/docker/volumes/vol/_data&quot;, &quot;Name&quot;: &quot;vol&quot;, &quot;Options&quot;: {}, &quot;Scope&quot;: &quot;local&quot; } ] å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–°å»ºçš„ vol ä¿å­˜åœ¨ /var/lib/docker/volumes/vol/_data ä¸‹ï¼Œå…¶ä¸­ /var/lib/docker/volumes ç›®å½•ä¿å­˜äº†æ‰€æœ‰çš„ Docker volumeã€‚ è¿è¡Œæ—¶æŒ‚è½½ä½¿ç”¨å‘½åå·æœ‰äº† volume ä¹‹åŽï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥ä½¿ç”¨åˆšæ‰åˆ›å»ºçš„ vol æ¥æŒ‚è½½å®¹å™¨ä¸­çš„æŸä¸ªç›®å½•ï¼š1docker run -d -v vol:/data --name temp-redis redis å¦‚æ­¤ä¸€æ¥ï¼Œåœ¨ temp-redis å®¹å™¨ä¸­ /data ä¸‹çš„æ”¹åŠ¨ï¼Œéƒ½ä¼šåŒæ­¥åæ˜ åœ¨å®¿ä¸»æœºçš„ /var/lib/docker/volumes/vol/_data ä¸‹ï¼›è€Œå®¿ä¸»æœºçš„æ”¹åŠ¨äº¦ç„¶ã€‚ ä½¿ç”¨ç»å¯¹è·¯å¾„ä½¿ç”¨å‘½åçš„ volume é€šå¸¸æ˜¯ä¸ºäº†æ•°æ®å…±äº«ï¼Œå¾ˆå¤šæ—¶å€™æˆ‘ä»¬åªæ˜¯æƒ³æŒ‡å®šä¸€ä¸ªæŒ‚è½½çš„ç›®å½•ä¾¿äºŽè®°å¿†å’Œç®¡ç†ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥ä½¿ç”¨ç»å¯¹è·¯å¾„ï¼Œå¦‚ï¼š1docker run -d -v /data/docker_volume/temp_redis/data:/data --name temp-redis redis è‡ªåŠ¨æŒ‚è½½æœ‰æ—¶å€™ä½ ç”šè‡³ä¸æƒ³å…³å¿ƒä»»ä½• volume çš„å½¢å¼ï¼Œä½ åªæ˜¯æƒ³æŠŠæŸä¸ªç›®å½•æŒä¹…åŒ–è€Œå·²ï¼Œå¯ä»¥è¿™ä¹ˆåšï¼š1docker run -d -v /data --name temp-redis redis Docker ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªåŒ¿åçš„ volumeã€‚æƒ³è¦çŸ¥é“å…·ä½“çš„å®¿ä¸»æœºç›®å½•å¯ä»¥ä½¿ç”¨ï¼šdocker inspect æ¥æŸ¥çœ‹ã€‚è¿™ç§æƒ…å†µé€šå¸¸åœ¨æž„å»ºçº¯æ•°æ®å®¹å™¨æ—¶ä½¿ç”¨ã€‚ æ³¨æ„ç‚¹åœ¨ volume åˆ›å»ºæ—¶å’Œåˆ›å»ºä¹‹åŽä»ç„¶éœ€è¦å…³æ³¨ä»–ä»¬ï¼Œä¸‹é¢æ˜¯ä¸€äº›å…¸åž‹çš„é—®é¢˜ã€‚ volume è‡ªåŠ¨åˆ›å»ºäº‹å®žä¸Šåœ¨ -v vol:/data æ—¶å€™ï¼Œvol volume ç”šè‡³ä¸éœ€è¦æå‰ä½¿ç”¨ docker volume create vol åˆ›å»ºï¼Œä½¿ç”¨ docker run -v vol:/data å‘½ä»¤æ—¶ä¾¿ä¼šè‡ªåŠ¨åˆ›å»ºã€‚åŒæ—¶åœ°ï¼Œä¹Ÿæ„å‘³ç€ -v é€‰é¡¹ä¸æ”¯æŒç›¸å¯¹è·¯å¾„çš„ä½¿ç”¨ã€‚ volume çš„åˆ é™¤åœ¨ä¸€ä¸ª volume è¢«åˆ›å»ºä¹‹åŽï¼Œæƒ³åˆ é™¤å¯æ²¡é‚£ä¹ˆå®¹æ˜“ï¼Œå³ä½¿ä½¿ç”¨äº† docker rm CONTAINER åˆ é™¤äº†å®¹å™¨ï¼Œvolume ä¾ç„¶ä¿ç•™ç€ã€‚é™¤éžï¼š ä½¿ç”¨ docker run --rm å¯åŠ¨çš„å®¹å™¨åœæ­¢æ—¶ã€‚å®ƒé™¤äº†ä¼šåˆ é™¤å®¹å™¨æœ¬èº«è¿˜ä¼šåˆ é™¤æŒ‚è½½çš„åŒ¿å volumeã€‚ ä½¿ç”¨ docker rm -v v å‚æ•°å¯ä»¥åˆ é™¤å®¹å™¨å’Œåˆ›å»ºå®¹å™¨æ—¶å…³è”çš„åŒ¿å volumeã€‚ é‚£ä¹ˆæˆ‘ä»¬åœ¨ä½¿ç”¨äº† named volume æˆ–è€…åˆ é™¤å®¹å™¨æ—¶å¿˜è®°äº† -vï¼Œé‚£ä¹ˆé‚£äº›åœ¨ /var/lib/docker/volumes ä¸‹çš„ä¸€äº›æ–‡ä»¶å°±æˆäº†åƒµå°¸æ–‡ä»¶ã€‚æ€Žä¹ˆåˆ é™¤å‘¢ï¼Ÿ ä½¿ç”¨ docker volume rm VOLUME æ¥åˆ é™¤ã€‚ ä½¿ç”¨ docker volume prune åˆ é™¤æ‰€æœ‰ä¸å†è¢«ä½¿ç”¨çš„ volumeã€‚ volume çš„åªè¯»æŽ§åˆ¶ä¸€äº›åœºåˆä¸‹ï¼Œæˆ‘ä»¬æä¾›åªæ˜¯éœ€è¦å®¹å™¨å†…çš„ç¨‹åºåŽ»è¯»å–ä¸€äº›å†…å®¹è€Œéžä¿®æ”¹ã€‚æˆ‘ä»¬å¯ä»¥ä¸¥æ ¼çš„æŽ§åˆ¶ volumeï¼Œå¢žåŠ åªè¯»é€‰é¡¹ roï¼š1234docker run -d \ --name=nginxtest \ -v nginx-vol:/usr/share/nginx/html:ro \ nginx:latest é€šè¿‡ Dockerfile æŒ‚è½½å¯ä»¥é€šè¿‡ Dockerfile åœ¨æž„å»ºé•œåƒçš„æ—¶å€™ä¾¿æŒ‡å®šéœ€è¦çš„ volumeï¼Œè¿™å¯¹äºŽå¾ˆå¤šåº”ç”¨éƒ½æ˜¯å¿…è¦çš„ï¼Œå°¤å…¶æ˜¯ä¸€äº›æ•°æ®ç±»åº”ç”¨ã€‚Dockerfile ä¸­ä½¿ç”¨ VOLUME è¡¨æ˜ŽæŒ‚è½½ç›®å½•ï¼Œå¦‚ï¼š1VOLUME ["/data1", "/data2"] ä»»ä½•é€šè¿‡è¯¥é•œåƒæž„å»ºçš„å®¹å™¨éƒ½ä¼šå°† /data1ï¼Œ/data2 ä¸¤ä¸ªç›®å½•è¿›è¡ŒæŒ‚è½½ã€‚ä½†æ˜¯ Dockerfile å½¢å¼çš„å¼±åŠ¿æ˜¯æ— æ³•è¿›è¡Œ named volume æˆ–è€…ç»å¯¹è·¯å¾„çš„æŒ‚è½½ã€‚ æ•°æ®å…±äº«ä¸Žå­˜å‚¨å…±äº« volumeæ—¢ç„¶æ•°æ®å¯ä»¥åœ¨å®¿ä¸»æœºå’Œå®¹å™¨é—´åŒæ­¥ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿å¤šä¸ªå®¹å™¨é—´åŒæ­¥å—ï¼Ÿå½“ç„¶å¯ä»¥ï¼ â€“volumes-from1234# é¦–å…ˆåˆ›å»ºä¸€ä¸ªå®¹å™¨ï¼Œå¹¶æŒ‚è½½ /datadocker run -d -v /data --name ng1 nginx# åˆ›å»ºç¬¬äºŒä¸ªå®¹å™¨ï¼Œå…±äº«å‰è€…çš„ volumedocker run -d --volumes-from ng1 --name gn2 nginx named volume1234# é¦–å…ˆåˆ›å»ºä¸€ä¸ªå®¹å™¨ï¼Œå¹¶åˆ›å»ºå‘½åå· share æ¥æŒ‚è½½ /datadocker run -d -v share:/data --name ng1 nginx# åˆ›å»ºç¬¬äºŒä¸ªå®¹å™¨ï¼Œä½¿ç”¨åŒæ ·çš„ /datadocker run -d -v share:/data --name ng2 nginx ä¸¤ç§æ–¹å¼éƒ½èƒ½è¾¾åˆ°æ•°æ®å…±äº«çš„ç›®çš„ï¼Œä½†æ˜¯ç”±äºŽé€šè¿‡å‘½åå·çš„æ–¹å¼å¯¹å¤šä¸ªå®¹å™¨çš„ä¾èµ–è¿›è¡Œäº†è§£è€¦ï¼Œæ‰€ä»¥æŽ¨èç¬¬äºŒç§ã€‚ æ•°æ®å®¹å™¨è¿™ä¸ªè¯é¢˜äº‹å®žä¸Šå’Œæ•°æ®å…±äº«ç´§å¯†ç›¸å…³ï¼Œç”±äºŽåœ¨ Docker1.9 ä¹‹å‰ï¼Œå¤§å®¶å¹¿æ³›ä½¿ç”¨ä½¿ç”¨ --volumes-from çš„å½¢å¼æ¥å…±äº«å·ï¼Œå¯¼è‡´å¿…é¡»è¦ä¸€ä¸ªåº•å±‚çš„æ²¡æœ‰ä¾èµ–çš„å®¹å™¨æ¥ä¿å­˜æ•°æ®ã€‚ é€šå¸¸ä½¿ç”¨å’Œåº”ç”¨å®¹å™¨ä¸€æ ·çš„é•œåƒæ¥æž„å»ºæ•°æ®å®¹å™¨ æ•°æ®å®¹å™¨ä¸éœ€è¦ä¹Ÿä¸åº”è¯¥å¯åŠ¨ï¼Œä»…ä»…æ˜¯åˆ©ç”¨ volume æœºåˆ¶æ¥ä¿æŒæ•°æ®è€Œå·² ç„¶è€ŒçŽ°åœ¨æœ‰äº†å‘½åå·ï¼Œå®Œå…¨ä¸éœ€è¦æ•°æ®å®¹å™¨çš„å­˜åœ¨äº†ï¼Œä½¿ç”¨ named volume å¯ä»¥æ›´ç›´æŽ¥æ›´æ–¹ä¾¿çš„ç®¡ç†å…±äº«æ•°æ®ã€‚]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Dockerfile ä¸­ä¸‰ä¸ªè¿è¡ŒæŒ‡ä»¤çš„å·®å¼‚]]></title>
    <url>%2F2018%2F07%2FDockerfile-%E4%B8%AD%E4%B8%89%E4%B8%AA%E8%BF%90%E8%A1%8C%E6%8C%87%E4%BB%A4%E7%9A%84%E5%B7%AE%E5%BC%82%2F</url>
    <content type="text"><![CDATA[åœ¨æè¿° Dockerfile çš„æ—¶å€™ï¼Œå¯¹äºŽ RUNï¼ŒCMDï¼ŒENTRYPOINT ä¸‰ä¸ªå‘½ä»¤ï¼Œç”¨æ³•ååˆ†ç›¸ä¼¼ï¼ŒåŠŸèƒ½ä¹Ÿå·®ä¸å¤šï¼Œå®¹æ˜“è®©äººæ··ç”¨ã€‚å…¶å®žä¸€èˆ¬æ¥è¯´ï¼Œä¸‰ä¸ªå‘½ä»¤éƒ½èƒ½å®Œæˆéœ€è¦çš„æ“ä½œï¼Œè€Œå·®å¼‚ç‚¹å¸¸å¸¸è¢«ä¸€äº›ä½¿ç”¨è€…å¿½ç•¥ã€‚è¿™é‡Œç®€å•è¯´ä¸€ä¸‹ï¼Œä¸‰ä¸ªå‘½ä»¤çš„ä¸åŒä¹‹å¤„ã€‚ å‘½ä»¤æ ¼å¼é¦–å…ˆçœ‹ä¸€ä¸‹ Dockerfile ä¸­å¦‚ä½•æ‰§è¡Œå‘½ä»¤ã€‚åœ¨ Dockerfile ä¸­ï¼Œå‘½ä»¤ï¼ˆinstructionï¼‰ä¸€èˆ¬æœ‰ä¸¤ç§å†™æ³•ï¼Œåˆ†åˆ«æ˜¯ï¼š Shell æ ¼å¼ï¼šINSTRUCTION &lt;command&gt; &lt;option&gt; &lt;param&gt; Exec æ ¼å¼ï¼šINSTRUCTION [&quot;command&quot;, &quot;option&quot;, &quot;param&quot;] ä¸¤ä¸ªæ ¼å¼åŸºæœ¬æ²¡æœ‰å·®å¼‚ï¼Œé™¤äº†å¯è¯»æ€§ä¹‹å¤–ï¼Œå¯¹äºŽ Shell æ ¼å¼çš„å‘½ä»¤ï¼ŒDocker ä¼šè‡ªåŠ¨ä½¿ç”¨ /bin/bash -c æ¥è¿›è¡Œè§£æžï¼Œå¯ä»¥æ˜¯è§£æžå‘½ä»¤ä¸­çš„å˜é‡æ¯”å¦‚ $JAVA_HOMEã€‚è€Œå¦‚æžœä½¿ç”¨ Exec æ ¼å¼æ‰§è¡Œæ—¶éœ€è¦è§£æžçŽ¯å¢ƒå˜é‡ï¼Œéœ€è¦è¿›è¡Œä¿®æ”¹ï¼Œæ¯”å¦‚ï¼šCMD [&quot;/bin/bash&quot;, &quot;-c&quot;, &quot;echo&quot;, &quot;java home is $JAVA_HOME&quot;]ã€‚å¯¹äºŽ RUNï¼ŒCMDï¼ŒENTRYPOINT ä¸‰è€…åŒæ ·éµå®ˆæ­¤è§„åˆ™ã€‚ RUN å‘½ä»¤RUN å‘½ä»¤åœ¨ Dockerfile ä¸­å¯ä»¥å¤šæ¬¡ä½¿ç”¨ï¼Œæ‰€ä»¥é€šå¸¸è¢«ç”¨æ¥åœ¨æž„å»ºå®¹å™¨æ—¶æ‰§è¡Œä¸€äº›å¿…é¡»çš„å‰ç½®å‘½ä»¤ï¼Œæ¯”å¦‚å®‰è£…è½¯ä»¶ç­‰ã€‚å®ƒçš„å‡ºçŽ°é¢‘çŽ‡è¿œé«˜äºŽå…¶ä»–ä¸¤ä¸ªæ‰§è¡Œå‘½ä»¤ã€‚æ ¼å¼ï¼š RUN &lt;command&gt; &lt;option&gt; &lt;param&gt; RUN [&quot;command&quot;, &quot;option&quot;, &quot;param&quot;] å¸¦æ¥ä¸€ä¸ª Shell é£Žæ ¼çš„å®‰è£… Git çš„ä¾‹å­ï¼š1RUN apt-get update &amp;&amp; apt-get install -y git è¿™é‡Œä½¿ç”¨ &amp;&amp; å¯ä»¥ä½¿å¾—åœ¨åŒä¸€å±‚é•œåƒå±‚ä¸Šæ›´æ–° apt å¹¶ä¸‹è½½ gitã€‚ CMD å‘½ä»¤CMD å‘½ä»¤çš„æ ¼å¼æœ‰ä¸‰ç§ï¼Œå‰ä¸¤è€…éƒ½æ˜¯ç”¨æ¥å®šä¹‰å®¹å™¨çš„é»˜è®¤è¡Œä¸ºï¼ŒåŽè€…ç”¨æ¥ç»™ ENTRYPOINT å‘½ä»¤æä¾›é¢å¤–çš„å¯æ›¿æ¢å‚æ•°ã€‚ CMD &lt;command&gt; &lt;option&gt; &lt;param&gt; CMD [&quot;command&quot;, &quot;option&quot;, &quot;param&quot;] CMD [&quot;param&quot;...] å…ˆè¯´å‰ä¸¤è€…ç”¨ä½œæ‰§è¡Œé»˜è®¤å‘½ä»¤çš„æƒ…å†µï¼Œä»¥ä¸€ä¸ªå®˜æ–¹ Nginx çš„ Dockerfile ä¸ºä¾‹ï¼š12# å‰ç½®æ­¥éª¤å¿½ç•¥CMD ["nginx", "-g", "daemon off;"] è¯¥å‘½ä»¤ä½¿å¾—ä»¥è¯¥ Nginx é•œåƒæž„å»ºçš„å®¹å™¨ï¼Œåœ¨å¯åŠ¨æ—¶å€™é»˜è®¤åœ°è‡ªåŠ¨è¿è¡Œ Nginxã€‚ä½†æ˜¯æ—¢ç„¶æ˜¯å®šä¹‰é»˜è®¤è¡Œä¸ºï¼Œé‚£ä¹ˆå®ƒæ˜¯å¯ä»¥åœ¨è¿è¡Œå®¹å™¨çš„æ—¶å€™è¢«æ›´æ”¹çš„ï¼Œæ¯”å¦‚åƒä¸‹é¢è¿™æ ·ï¼š1sudo docker run -p 80:80 nginx echo hello-world é‚£ä¹ˆè¿™ä¸ªæ—¶å€™å®¹å™¨å¹¶ä¸ä¼šå¯åŠ¨ä¸€ä¸ª Nginx æœåŠ¡ï¼Œè€Œæ˜¯æ‰“å°äº† hello-worldã€‚å¹¶ä¸”è¿™ä¸ªå®¹å™¨ä¼šéšç€æ‰“å°å‘½ä»¤çš„ç»“æŸè€Œåœæ­¢ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ—¢ç„¶ CMD å®šä¹‰é»˜è®¤è¡Œä¸ºï¼Œé‚£ä¹ˆå®ƒåœ¨ Dockerfile ä¸­åªèƒ½å­˜åœ¨ä¸€ä¸ªï¼ˆå¦‚æžœå®šä¹‰äº†å¤šä¸ª CMDï¼Œé‚£ä¸ªæœ€åŽä¸€ä¸ªæœ‰æ•ˆï¼‰ é‚£ä¹ˆå¦‚ä½•ä½¿ç”¨ CMD ä¸º ENTRYPOINT æä¾›é¢å¤–å‚æ•°å‘¢ï¼Ÿå…ˆçœ‹ä¸€ä¸‹ ENTRYPOINT çš„ç”¨æ³•ã€‚ ENTRYPOINT å‘½ä»¤ENTRYPOINT é€šå¸¸ç”¨æ¥å®šä¹‰å®¹å™¨å¯åŠ¨æ—¶å€™çš„è¡Œä¸ºï¼Œæœ‰ç‚¹ç±»ä¼¼äºŽ CMDï¼Œä½†æ˜¯å®ƒä¸ä¼šè¢«å¯åŠ¨å‘½ä»¤ä¸­çš„å‚æ•°è¦†ç›–ã€‚ä¸Šä¸€èŠ‚ä¸­ Nginx çš„ä¾‹å­ï¼Œå¦‚æžœå°† CMD æ”¹æˆ ENTRYPOINTï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„ hello-world æ–¹æ¡ˆä¾¿è¡Œä¸é€šäº†ã€‚ ENTRYPOINT åŒæ ·æ”¯æŒä¸¤ç§æ ¼å¼çš„å†™æ³•ï¼Œå¹¶ä¸”æ˜¯å­˜åœ¨å·®å¼‚çš„ï¼ˆåŽæ–‡æè¿°ï¼‰ï¼š ENTRYPOINT &lt;command&gt; &lt;option&gt; &lt;param&gt; ENTRYPOINT [&quot;command&quot;, &quot;option&quot;, &quot;param&quot;] ä½¿ç”¨ Exec é£Žæ ¼çš„å†™æ³•æ”¯æŒä½¿ç”¨ CMD æ‹“å±•å¯å˜å‚æ•°å’ŒåŠ¨æ€æ›¿æ¢å‚æ•°ï¼Œè€Œä½¿ç”¨ Shell é£Žæ ¼æ—¶ä¸æ”¯æŒã€‚å‡å¦‚æˆ‘ä»¬åœ¨ Dockerfile ä¸­ï¼š12# å‰ç½®æ­¥éª¤å¿½ç•¥ENTRYPOINT redis-cli -h 127.0.0.1 é‚£ä¹ˆè¿™ä¸ªç”±æ­¤æž„å»ºçš„å®¹å™¨åœ¨è¿è¡Œæ—¶åªèƒ½å°† redi è¿žæŽ¥åˆ°å®¹å™¨æœ¬èº«çš„ redis-server ä¸Šã€‚ä¿®æ”¹è¿™ä¸ª Dockerfileï¼š123# å‰ç½®æ­¥éª¤å¿½ç•¥ENTRYPOINT ["redis-cli"]CMD ["-h", "127.0.0.1"] è¿™æ—¶å€™ï¼Œå¦‚æžœæŒ‰é»˜è®¤çš„å¯åŠ¨æ–¹å¼ï¼Œå®¹å™¨çš„ redis-cli ä¼šè‡ªåŠ¨è¿žæŽ¥ 127.0.0.1ï¼Œå³ä»¥ä¸‹å‘½ä»¤æ­¤æ—¶æ˜¯ç­‰ä»·çš„ï¼š12docker run my-redis-imagedocker run my-redis-image -h 127.0.0.1 ä½†æ˜¯ç”±äºŽ Dockfile ä¸­ä½¿ç”¨äº† Exec æ ¼å¼çš„ ENTRYPOINTï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥ä¿®æ”¹å®ƒçš„ç›®æ ‡åœ°å€äº†ï¼Œç”šè‡³å¯ä»¥å¢žåŠ é¢å¤–çš„å‚æ•°ï¼š1docker run my-redis-image -h server.address -a redis_password å…¶ä¸­ -h server.address æ›¿æ¢äº† CMD [&quot;-h&quot;, &quot;127.0.0.1&quot;]ï¼Œè€Œ -a redis_password åˆ™æ˜¯ç”±äºŽä½¿ç”¨äº† Exec æ ¼å¼å¯ä»¥å¢žåŠ å‚æ•°ã€‚ å…³äºŽ RUNï¼ŒCMDï¼ŒENTRYPOINT çš„å·®å¼‚å·²ç»æè¿°å®Œäº†ï¼Œæœ‰æ²¡æœ‰éƒ½ç‰¢è®°äºŽå¿ƒå‘¢~]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æ–‡å­—å¤„ç†-sed]]></title>
    <url>%2F2018%2F07%2F%E6%96%87%E5%AD%97%E5%A4%84%E7%90%86-sed%2F</url>
    <content type="text"><![CDATA[sed æ˜¯éžå¸¸å¸¸ç”¨çš„æµå¼å¤„ç†ç¼–è¾‘å·¥å…·ï¼Œé…åˆæ­£åˆ™è¡¨è¾¾å¼å¯ä»¥è¿›è¡Œååˆ†æ•ˆçŽ‡çš„æ–‡å­—å¤„ç†ã€‚å®ƒé€šè¿‡é€è¡Œåœ°å°†æ–‡å­—è¯»å–ï¼Œæš‚å­˜è¿›æ¨¡å¼ç©ºé—´ï¼Œé€šè¿‡æŒ‡å®šçš„å‘½ä»¤è¿›è¡Œå¤„ç†åŽï¼Œè¾“å‡ºè‡³æ ‡å‡†è¾“å‡ºï¼Œç›´åˆ°æ–‡ä»¶æˆ–è€…è¯´è¾“å…¥çš„ç»“æŸã€‚åŽŸç†ååˆ†ç®€å•ï¼Œæ¥å­¦ä¹ ä¸€ä¸‹å§ã€‚ å‘½ä»¤æ ¼å¼sed [é€‰é¡¹åŠå‚æ•°]â€¦ â€˜æ“ä½œå‘½ä»¤â€™ æ–‡ä»¶â€¦ å¸¸ç”¨é€‰é¡¹ -n é™é»˜æ¨¡å¼ å–æ¶ˆ sed é»˜è®¤çš„è¾“å‡º -e å¤šé‡ç¼–è¾‘ å¯ä»¥å¤šæ¬¡ä½¿ç”¨ï¼Œæºå¸¦ sed å‘½ä»¤ä½œä¸ºè¯¥é€‰é¡¹çš„å‚æ•°ï¼Œå¯¹äºŽç¼“å†²åŒºçš„æ¯ä¸€è¡ŒæŒ‰å‘½ä»¤é¡ºåºè¿›è¡Œå¤„ç† -f ä½¿ç”¨ sed æ“ä½œçš„è„šæœ¬å¤„ç†ï¼Œè·Ÿä¸Šè„šæœ¬æ–‡ä»¶ååšå‚æ•°ã€‚sed è„šæœ¬å¯ä»¥ä¿å­˜å¤šæ¡ sed å‘½ä»¤ï¼Œä¸€è¡Œä¸€æ¡ï¼Œä¾æ¬¡æ‰§è¡Œã€‚ -r ä½¿ç”¨æ‹“å±•æ­£åˆ™ï¼Œç±»ä¼¼ grep -e æˆ–è€… egrep çš„å¢žå¼ºï¼Œè®©äººå°‘äº›ä¸€ç‚¹è½¬ä¹‰ç¬¦ -i åŽŸåœ°ä¿®æ”¹ï¼Œè¯¥é€‰é¡¹ä¼šä½¿å¾— sed å‘½ä»¤ç›´æŽ¥ä¿®æ”¹åŽŸæ–‡ä»¶ï¼Œå¯ä»¥ç´§è·Ÿä¸€ä¸ªåŽç¼€å¦‚ -i.bkï¼ŒåŒæ—¶ç”Ÿæˆå¤‡ä»½ å‘½ä»¤ç»„æˆsed å‘½ä»¤çš„ç»„æˆé€šå¸¸æ˜¯ â€˜è¡Œé€‰æ‹©å…·ä½“æ“ä½œâ€™ã€‚sed åœ¨è¯»å…¥è¡Œå†…å®¹ä¹‹åŽï¼Œå¦‚æžœåŒ¹é…å®šå€è¦æ±‚å°±ä¼šè¿›è¡Œå‘½ä»¤æ“ä½œã€‚æˆ‘ä»¬æ¥ä¸¤éƒ¨åˆ†åˆ†å¼€ä¸€çœ‹~ è¡Œé€‰æ‹© num é€‰æ‹©ç¬¬ num è¡Œã€‚ start,end é€‰æ‹©ç¬¬ start è¡Œè‡³ç¬¬ end è¡Œã€‚ start~step ä»Ž start è¡Œå¼€å§‹ï¼Œä»¥ step ä¸ºæ­¥é•¿é€‰æ‹©è¡Œã€‚ /pattern/ é€‰æ‹©å«æœ‰è¯¥æ­£åˆ™çš„å†…å®¹çš„è¡Œã€‚ start,/pattern/ ä»Ž start è¡Œå¼€å§‹ç›´åˆ°é¦–æ¬¡æˆåŠŸåŒ¹é…è¡¨è¾¾å¼çš„ä¸€è¡Œå°†è¢«é€‰å®šï¼Œæ³¨æ„ sed çš„å¤„ç†æœºåˆ¶ï¼Œå¦‚æžœè¡¨è¾¾å¼æœ€ç»ˆæ— æ³•æœ‰ä»»ä½•åŒ¹é…è¡Œï¼Œå°†ä¼šå¯¹ start è¡Œä¹‹åŽçš„æ‰€æœ‰è¡Œè¿›è¡Œé€‰å®šã€‚ /pattern/,end ä»Žé¦–æ¬¡æˆåŠŸåŒ¹é…è¡¨è¾¾å¼çš„ä¸€è¡Œè‡³ end è¡Œå°†è¢«é€‰å®šï¼Œå¦‚æžœåœ¨ç¬¬ end è¡Œä¹‹å‰å¦‚æžœæ²¡æœ‰æˆåŠŸåŒ¹é…å°†ä¼šä¸æœ‰è¡Œè¢«é€‰ä¸­ã€‚ ! ç½®äºŽè¡Œé€‰æ‹©æœ«å°¾ï¼Œè¿›è¡Œåé€‰ï¼Œå¦‚ 10,20! å°†æŽ’é™¤ 10 è‡³ 20 è¡Œã€‚ å…·ä½“æ“ä½œ p æ‰“å°ç¼“å†²å†…å®¹ï¼Œé€šå¸¸é…åˆ -n é€‰é¡¹æµ‹è¯•æŒ‡ä»¤æ­£ç¡®æ€§ã€‚ q æå‰é€€å‡º sedï¼Œå½“åˆ°è¾¾åŒ¹é…è¡Œæˆ–è€…æŒ‡å®šè¡Œå°±é€€å‡º sedã€‚ i\[content] è¡Œå‰è¿½åŠ å†…å®¹ï¼Œå¦‚åœ¨ç¬¬ 1 è¡Œè‡³ç¬¬ 5 è¡Œï¼Œæ¯è¡Œä¹‹åŽæ’å…¥â€˜===â€™ï¼š&#39;1,5i\===&#39;ã€‚ a\[content] è¡ŒåŽè¿½åŠ å†…å®¹ã€‚ c\[content] æ›¿æ¢å†…å®¹ï¼Œå¦‚æžœæ˜¯æ‰¹é‡é€‰æ‹©ï¼Œå¹¶ä¸æ˜¯å¯¹æ¯è¡Œå†…å®¹è¿›è¡Œæ›¿æ¢ï¼Œè€Œæ˜¯å¯¹æ•´ä½“æ›¿æ¢æˆç›¸åº”å†…å®¹ã€‚ d åˆ é™¤ã€‚ s/pattern/new_chars/[g] å¯¹é€‰å®šçš„è¡Œä¸­é¦–æ¬¡åŒ¹é…è¡¨è¾¾å¼çš„å†…å®¹æ›¿æ¢æˆç›®æ ‡å­—ç¬¦ä¸²ï¼Œå¦‚æžœæœ«å°¾ä½¿ç”¨â€˜gâ€™ï¼Œå¯ä»¥å¯¹è¡Œä¸­æ‰€æœ‰åŒ¹é…å†…å®¹æ›¿æ¢ã€‚ y/old-char-set/new-char-set å¯¹é€‰å®šè¡Œä¸­æ‰€æœ‰ old-char-set å†…çš„å­—ç¬¦æ›¿æ¢æˆç›¸åº”çš„æ–°çš„å­—ç¬¦ã€‚ n æå‰è¯»å–ä¸‹ä¸€è¾“å…¥è¡Œè‡³ç¼“å†²åŒºã€‚ r [file-name] è¡ŒåŽè¿½åŠ æŒ‡å®šæ–‡ä»¶å†…å®¹ã€‚ w [file-name] å°†é€‰å®šè¡Œè¾“å…¥è‡³æŒ‡å®šæ–‡ä»¶ã€‚ h å¤åˆ¶åŒ¹é…è¡Œè¿›å…¥æš‚å­˜ç©ºé—´ã€‚ G é…åˆ h å‘½ä»¤ï¼Œå–å‡ºæš‚å­˜ç©ºé—´å†…çš„è¡Œï¼Œæ’å…¥è‡³æ¨¡å¼ç©ºé—´çš„æœ«å°¾ã€‚ x é…åˆ h å‘½ä»¤ï¼Œäº¤æ¢å½“å‰åŒ¹é…è¡Œçš„æš‚å­˜ç©ºé—´å†…çš„è¡Œã€‚ å‘½ä»¤å åŠ éœ€è¦å¤šæ¬¡ä½¿ç”¨ sed æ“ä½œçš„æ—¶å€™ï¼Œå¯ä»¥æœ‰è¿™ä¹ˆäº›åŠžæ³•ï¼š é€šè¿‡ {å‘½ä»¤1;å‘½ä»¤2...} å¯ä»¥ä½¿ç”¨â€˜{}â€™å°†å¤šä¸ªå‘½ä»¤æ•´åˆä¸€å—å„¿ï¼Œä¸­é—´ä½¿ç”¨â€˜;â€™åˆ†å‰²ï¼Œç±»ä¼¼ä»£ç å—çš„è¡¨è¾¾ã€‚å…¶ä¸­å¦‚æžœå¦‚æžœå¤šä¸ªå‘½ä»¤çš„è¡Œå®šä½æ¡ä»¶ä¸€è‡´ï¼Œå¯ä»¥å°†è¯¥éƒ¨åˆ†æå‡ºï¼Œå¦‚ï¼š&#39;{10p;10p}&#39; ç­‰äºŽ &#39;10{p;p}&#39;ã€‚ é€šè¿‡ -e é€‰é¡¹å¤šæ¬¡è¾“å…¥ sed å‘½ä»¤ã€‚ å°†å¤šä¸ª sed å‘½ä»¤é€è¡Œå†™å…¥æ–‡ä»¶ï¼Œä½¿ç”¨ -f é€‰é¡¹æ‰§è¡Œ sedã€‚ é¢å¤–æŠ€å·§sed å‘½ä»¤å…¶å®žå’Œæ­£åˆ™è¡¨è¾¾å¼é€šå¸¸é…åˆä½¿ç”¨ï¼Œæ‰€ä»¥è¿™ä¸€äº›å°æŠ€å·§å…¶å®žå’Œæ­£åˆ™æœ‰å¾ˆå¯†åˆ‡çš„å…³ç³»ã€‚æ¯”å¦‚å¯¹äºŽä¸€ä¸ªç®€å•çš„æ›¿æ¢æ“ä½œï¼Œå¦‚ s/abc/xyz/ æ˜¯ååˆ†ç®€å•çš„ï¼Œä½†æ˜¯ sed æ”¯æŒæ›´å¤æ‚çš„æ“ä½œï¼Œå¯ä»¥ç”¨ä¸€äº›ç‰¹æ®Šæ„ä¹‰çš„æ“ä½œç¬¦å·: &amp; è¡¨ç¤ºæ­£åˆ™åŒ¹é…æˆåŠŸçš„åŽŸå­—ç¬¦ä¸²å†…å®¹ï¼Œå¦‚æƒ³è¦æ›¿æ¢æ‰€æœ‰æ•°å­—ä¸ºå®ƒçš„ç™¾å€ï¼Œå¯ä»¥ä½¿ç”¨ â€˜s/[[:digit:]]\+/&amp;00/gâ€™ \num èŽ·å–ç¼“å­˜çš„åŒ¹é…ä¸­ç¼“å­˜çš„å­—ç¬¦ä¸²ï¼Œnum æŒ‡å®šä½ç½®ï¼ˆè¿™å–å†³äºŽè¡¨è¾¾å¼ä¸­ä½¿ç”¨äº†å¤šå°‘æ¬¡å°æ‹¬å·â€˜()â€™ï¼‰ã€‚ å¦‚åŽ»é™¤æ•°å­—å¹¶å­—æ¯å¤§å†™ï¼Œâ€™s/([[:digit:]]\+\)\|\([[:alpha:]]\+\)/\U\2/gpâ€™ èŽ·å–åŒ…å«ä¸€æ®µ ip çš„æ–‡æœ¬ä¸­ ip çš„å‰ä¸¤æ®µåœ°å€ â€˜s/\([0-9]\+\):\([0-9]\+\):[0-9]\+:[0-9]+/\1 \2/pâ€™ \u å°†åŽæ–¹çš„è¡¨è¾¾å¼ç»“æžœè¿›è¡Œé¦–å­—æ¯å¤§å†™å¤„ç† \U å°†åŽæ–¹çš„è¡¨è¾¾å¼ç»“æžœè¿›è¡Œå¤§å†™å¤„ç† \l å°†åŽæ–¹çš„è¡¨è¾¾å¼ç»“æžœè¿›è¡Œé¦–å­—æ¯å°å†™å¤„ç† \L å°†åŽæ–¹çš„è¡¨è¾¾å¼ç»“æžœè¿›è¡Œå°å†™å¤„ç†]]></content>
      <categories>
        <category>shell</category>
      </categories>
      <tags>
        <tag>Regex</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[AQS æµ…æž]]></title>
    <url>%2F2018%2F07%2FAQS-%E6%B5%85%E6%9E%90%2F</url>
    <content type="text"><![CDATA[java.util.concurrent åŒ…ä¸­æä¾›äº†è®¸å¤šæ˜“ç”¨è€Œæœ‰æ•ˆçš„å·¥å…·ç±»ï¼Œè¯¸å¦‚ ReentrantLockï¼ŒCountDownLatchï¼ŒSemaphore ç­‰ç­‰ï¼Œç»™æ—¥å¸¸çš„å¹¶å‘ç¼–ç¨‹å¸¦æ¥äº†è®¸å¤šä¾¿åˆ©ã€‚ä»–ä»¬éƒ½ä½¿ç”¨äº†åŒæ ·çš„æ¡†æž¶æ¥å®ŒæˆåŸºæœ¬çš„åŒæ­¥è¿‡ç¨‹ï¼šAbstractQueuedSynchronizer ï¼ˆAQSï¼‰æ¥å®žçŽ°åŸºæœ¬åŠŸèƒ½ï¼Œæ¯”å¦‚èŽ·å–èµ„æºå’Œé‡Šæ”¾çš„æ­¥éª¤ã€‚ ç®€å•äº†è§£æˆ³å¼€ AQS ä¸€è§ˆå…¶ç»“æž„ï¼Œå…¶å®žå®ƒæœ¬èº«ç»´æŠ¤äº†ä¸¤ä¸ªæ¦‚å¿µï¼š stateï¼šï¼ˆvolatile intï¼‰è¯¥å±žæ€§ç»´æŠ¤äº†èµ„æºçš„çŠ¶æ€ï¼Œæˆ–è€…æ˜¯æ•°é‡ã€‚ CLH queueï¼šä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„çº¿ç¨‹ç­‰å¾…é˜Ÿåˆ—ã€‚è¿™å¹¶ä¸æ˜¯ä¸€ä¸ªå…·ä½“å¯¹è±¡ï¼Œè€Œæ˜¯é€šè¿‡å†…éƒ¨ç±» Node æ¥ç»´æŠ¤çš„ã€‚ AQS å¯¹äºŽ state æ”¯æŒä¸¤ç§æ¨¡å¼çš„èµ„æºå…±äº«å½¢å¼ï¼š Exclusive-æŽ’ä»–å¼ï¼šè¿›ç¨‹ç‹¬å å½¢å¼ï¼Œå¦‚ ReentrantLockï¼ŒMutex çš„åº”ç”¨ã€‚ Share-å…±äº«å¼ï¼šæ”¯æŒå¤šçº¿ç¨‹è®¿é—®ï¼Œå…¸åž‹çš„åº”ç”¨å¼ CountDownLatch / Semaphoreã€‚ å­ç±»å®žçŽ° AQS æ—¶å€™åªéœ€è¦å®žçŽ°å…³äºŽ state çš„èŽ·å–ï¼ˆacquireï¼‰å’Œé‡Šæ”¾ï¼ˆreleaseï¼‰æ–¹æ¡ˆå³å¯ï¼ŒåŒ…æ‹¬é˜Ÿåˆ—çš„ç»´æŠ¤ï¼Œçº¿ç¨‹çš„å”¤é†’ç­‰å·¥ä½œï¼Œå¤§éƒ¨åˆ†éƒ½åœ¨ AQS ç»´æŠ¤äº†ã€‚ä¸¾ä¸ªæ —å­ï¼Œåœ¨ä½¿ç”¨ CountDownLatch çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šåˆå§‹åŒ–ä¸€ä¸ªè®¡æ•°å€¼ n ç”¨äºŽå¯¹åº” n ä¸ªå­çº¿ç¨‹ï¼Œè¿™ä¸ª n åŒæ—¶ä¹Ÿå¯¹åº”äº† state å€¼ï¼Œæ¯ä¸€æ¬¡ countDown() çš„æ—¶å€™ï¼Œä¼šä½¿å¾— state CAS åœ°å‡ 1ã€‚åœ¨ state å½’é›¶çš„æ—¶å€™ä¼šä½¿ç”¨ unpark()ï¼Œä¸»çº¿ç¨‹ ä»Ž await() å‡½æ•°è¿”å›žã€‚ å·¥ä½œæµç¨‹AQS çš„ API åŒä¸€èˆ¬çš„åŒæ­¥å·¥å…· API ä¸€æ ·ï¼Œé™¤äº†å¯¹äºŽèµ„æºçš„ acquire / release æ“ä½œï¼Œè¿˜æä¾›çš„äº† tryAcquire / tryRelease çš„éžé˜»å¡žæ“ä½œã€‚åŒæ—¶ acquireInterruptibly æ”¯æŒçº¿ç¨‹ä¸­æ–­ã€‚å¦‚æžœéœ€è¦ä½¿ç”¨å…±äº«å¼çš„æ“ä½œï¼Œéœ€è¦å®žçŽ°å¯¹åº”çš„ Share æ“ä½œæ–¹æ³•ã€‚ èµ„æºèŽ·å–é¦–å…ˆçœ‹ acquire æ–¹æ³•ï¼š1234public final void acquire(int arg) &#123; if (!tryAcquire(arg) &amp;&amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg)) selfInterrupt();&#125; tryAcquire(int)ï¼šå°è¯•èŽ·å–èµ„æº addWaiter(Node)ï¼šä½¿çº¿ç¨‹ï¼ˆNode å¯¹è±¡ç»´æŠ¤è¿™çº¿ç¨‹å¯¹è±¡ï¼‰è¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œå¯¹äºŽ acquire æ–¹æ³•ä½¿ç”¨ EXCLUSICE-æŽ’ä»–æ¨¡å¼ã€‚ acquireQueued(Node, int)ï¼šåœ¨è¿™ä¸€æ­¥éª¤ä¸­çº¿ç¨‹ä¼šç­‰å¾…ï¼Œè€Œåœ¨çº¿ç¨‹å”¤é†’åŽä¼šå°è¯•åœ¨è¯¥æ–¹æ³•å†…èŽ·å–èµ„æºã€‚ selfInterruptï¼šç”±äºŽçº¿ç¨‹åœ¨ç­‰å¾…è¿‡ç¨‹ä¸­æ— æ³•å“åº”ä¸­æ–­ï¼Œæ‰€ä»¥åœ¨èŽ·å–èµ„æºå¹¶é€€å‡ºé˜Ÿåˆ—åŽè¡¥å……ä¸€ä¸ªä¸­æ–­ã€‚ tryAcquire(int) æ–¹æ³•é»˜è®¤ä¼šæŠ›å‡ºæ“ä½œä¸æ”¯æŒçš„å¼‚å¸¸ï¼Œéœ€è¦å­ç±»çš„å…·ä½“å®žçŽ°ã€‚ 123protected boolean tryAcquire(int arg) &#123; throw new UnsupportedOperationException();&#125; addWaiter(Node, int) æ–¹æ³•ä¼šè‡ªæ—‹ä½¿ç”¨ CAS æ–¹å¼å°†ä¸€ä¸ª Node åŠ å…¥é˜Ÿå°¾ã€‚ 1234567891011121314151617181920212223242526272829private Node addWaiter(Node mode) &#123; Node node = new Node(Thread.currentThread(), mode); // Try the fast path of enq; backup to full enq on failure Node pred = tail; if (pred != null) &#123; node.prev = pred; if (compareAndSetTail(pred, node)) &#123; pred.next = node; return node; &#125; &#125; enq(node); return node;&#125;private Node enq(final Node node) &#123; for (;;) &#123; Node t = tail; if (t == null) &#123; // Must initialize if (compareAndSetHead(new Node())) tail = head; &#125; else &#123; node.prev = t; if (compareAndSetTail(t, node)) &#123; t.next = node; return t; &#125; &#125; &#125;&#125; ä»Žä¸Šé¢ä¸¤ä¸ªæ–¹æ³•å¯ä»¥çœ‹å‡ºä½äºŽé˜Ÿåˆ—å¤´éƒ¨çš„ Node å…¶å®žåªæ˜¯ä¸€ä¸ªæ ‡è®°ï¼Œåœ¨é˜Ÿåˆ—ç¬¬äºŒä½ç½®çš„æ—¶å€™ï¼Œçº¿ç¨‹å·²ç»å¯ä»¥èŽ·å–èµ„æºå¹¶è¿›è¡Œç›¸å…³ä»»åŠ¡äº†ã€‚ acquireQueued(Node, int) æ›´å…³é”®çš„ä¸€æ­¥ï¼Œåœ¨èŽ·å–èµ„æºå¤±è´¥ï¼Œ Node å·²ç»è¢«åŠ å…¥é˜Ÿå°¾ä¹‹åŽï¼Œçº¿ç¨‹éœ€è¦è¿›å…¥ç­‰å¾…çŠ¶æ€ç­‰å¾…è¢«å”¤é†’ã€‚ 123456789101112131415161718192021final boolean acquireQueued(final Node node, int arg) &#123; boolean failed = true; try &#123; boolean interrupted = false; for (;;) &#123; final Node p = node.predecessor(); if (p == head &amp;&amp; tryAcquire(arg)) &#123; setHead(node); p.next = null; // help GC failed = false; return interrupted; &#125; if (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt()) interrupted = true; &#125; &#125; finally &#123; if (failed) cancelAcquire(node); &#125;&#125; shouldParkAfterFailedAcquire(Node, Node) æ¯ä¸ªèŠ‚ç‚¹æ˜¯å¦éœ€è¦ç­‰å¾…éœ€è¦é˜»å¡žå–å†³äºŽå‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ã€‚ 1234567891011121314private static boolean shouldParkAfterFailedAcquire(Node pred, Node node) &#123; int ws = pred.waitStatus; if (ws == Node.SIGNAL) return true; if (ws &gt; 0) &#123; do &#123; node.prev = pred = pred.prev; &#125; while (pred.waitStatus &gt; 0); pred.next = node; &#125; else &#123; compareAndSetWaitStatus(pred, ws, Node.SIGNAL); &#125; return false;&#125; å‰é©±èŠ‚ç‚¹æœ€åŽä¼šé€šè¿‡è¯¥çŠ¶æ€å€¼æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦ unpark ä¸‹ä¸ªçº¿ç¨‹ã€‚åœ¨è¿™é‡Œï¼Œå¦‚æžœå‰é©±èŠ‚ç‚¹æ ‡è¯†ä¸º SIGNALï¼Œåˆ™è¿›å…¥ç­‰å¾…ï¼›æ ‡è¯†ä¸º CANCAL éœ€è¦è¿½æº¯æ›´å‰çš„èŠ‚ç‚¹çŠ¶æ€ï¼›å¦‚æžœä¸ºå…¶ä»–æ­£å¸¸å€¼ï¼Œåˆ™æ›´æ–°ä¸º SIGNALã€‚ parkAndCheckInterrupt() ä½¿çº¿ç¨‹è¿›å…¥ WATINGï¼Œç­‰å¾… unparkï¼ˆåœ¨ release ä¸­è§¦å‘ï¼Œé©¬ä¸Šå°±æ¥ï¼‰ æˆ–è€… interruptï¼Œè¢«å”¤é†’åŽå›žåˆ° acquireQueued è§¦å‘ä¸­æ–­æˆ–è€…ç»§ç»­æ£€æŸ¥æ˜¯å¦å¯ä»¥èŽ·å–èµ„æºã€‚ 1234private final boolean parkAndCheckInterrupt() &#123; LockSupport.park(this); return Thread.interrupted();&#125; é‡Šæ”¾èµ„æºå¹¶å”¤é†’åŽç½®çº¿ç¨‹è¿™æ˜¯ acquire æ–¹æ³•çš„åæ“ä½œï¼Œç”¨äºŽèµ„æºçš„é‡Šæ”¾ï¼Œå½“èµ„æºæˆåŠŸé‡Šæ”¾æ—¶ï¼Œå”¤é†’ä¸‹ä¸€ä¸ªçº¿ç¨‹ï¼ˆä½äºŽå¤´èŠ‚ç‚¹ä¹‹åŽï¼‰ã€‚ 123456789public final boolean release(int arg) &#123; if (tryRelease(arg)) &#123; Node h = head; if (h != null &amp;&amp; h.waitStatus != 0) unparkSuccessor(h); return true; &#125; return false;&#125; é€šè¿‡ tryRelease(int) æ–¹æ³•åˆ¤æ–­èµ„æºæ˜¯å¦é‡Šæ”¾ï¼Œè¿™ä¸ªæ–¹æ³•åŒæ ·éœ€è¦è¢«å®žçŽ°ï¼š 123protected boolean tryRelease(int arg) &#123; throw new UnsupportedOperationException();&#125; è€Œ unparkSuccessor(Node) æ–¹æ³•ç”¨æ¥çœŸæ­£å”¤é†’ node.next ä¸­çš„çº¿ç¨‹ï¼š 123456789101112131415private void unparkSuccessor(Node node) &#123; int ws = node.waitStatus; if (ws &lt; 0) compareAndSetWaitStatus(node, ws, 0); Node s = node.next; if (s == null || s.waitStatus &gt; 0) &#123; s = null; for (Node t = tail; t != null &amp;&amp; t != node; t = t.prev) if (t.waitStatus &lt;= 0) s = t; &#125; if (s != null) LockSupport.unpark(s.thread);&#125; çœ‹åˆ°è¿™å°±èƒ½äº†è§£æ•´ä¸ª AQS çš„è¿ä½œæµç¨‹äº†ã€‚åœ¨ parkAndCheckInterrupt ä¸­è¿›å…¥ WAITING çš„çº¿ç¨‹ï¼Œåœ¨è¿™é‡Œè¢«å”¤é†’ï¼Œå®ƒä¼šç»§ç»­è¿›å…¥ acquireQueued ä¸­çš„è‡ªæ—‹ï¼Œå¦‚æžœ tryAcquire é¡ºåˆ©èŽ·å¾—èµ„æºï¼Œåˆ™å°†æœ¬çº¿ç¨‹çš„èŠ‚ç‚¹è®¾ç½®ä¸º head å¹¶è¿”å›ž acquire æ–¹æ³•ã€‚so, go on. AQS æœ¬èº«å¹¶ä¸å¤æ‚ï¼Œä½¿ç”¨æ—¶åªéœ€è¦æ‰‹åŠ¨å®žçŽ° tryAcquire å’Œ tryRealeas æ–¹æ³•ã€‚ è€Œå¯¹äºŽ Share-å…±äº«å¼çš„ acquire / release æµç¨‹ï¼ŒåŒºåˆ«å¹¶ä¸å¤ªå¤§ï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥è‡ªè¡Œç¿»é˜…æºç ä¸€æŽ¢ç©¶ç«Ÿã€‚ å‚è€ƒ https://mp.weixin.qq.com/s/eyZyzk8ZzjwzZYN4a4H5YA]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>å¹¶å‘</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Ribbon æ‘˜è¦]]></title>
    <url>%2F2018%2F07%2FRibbon%2F</url>
    <content type="text"><![CDATA[ä¸»è¦æž„æˆRibbon æ˜¯ç”± netflix å¼€æºçš„ä¸€ä¸ªå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ç»„ä»¶ã€‚ä»Žå®¢æˆ·ç«¯çš„è§’åº¦å–ç»´æŠ¤æœåŠ¡é—´è¯·æ±‚çš„è´Ÿè½½å‡è¡¡ï¼Œå¹¶è¿›è¡Œä¸€å®šçš„å®¹é”™å¤„ç†ã€‚è‡ªç„¶çš„å®ƒçš„æ ¸å¿ƒæŽ¥å£å°±æ˜¯ï¼šcom.netflix.loadbalancer.ILoadBalancerã€‚ åœ¨é…ç½® Ribbon ä¹‹å‰ï¼Œäº†è§£ä¸€ä¸‹ Ribbon å®Œæˆè´Ÿè½½å‡è¡¡çš„å‡ ä¸ªé‡è¦ç»„æˆéƒ¨åˆ†ï¼š IRuleï¼šè´Ÿè½½å‡è¡¡çš„ç­–ç•¥ã€‚ IPingï¼šæ£€æµ‹æœåŠ¡å­˜æ´»çš„ç­–ç•¥ã€‚ ServerList&lt;T&gt;ï¼šæ‹‰å–æœåŠ¡å®žä¾‹åˆ—è¡¨çš„ç­–ç•¥ã€‚ ServerListUpdaterï¼šæ›´æ–°æœåŠ¡åˆ—è¡¨çš„è§¦å‘ç­–ç•¥ã€‚ ServerListFilter&lt;T&gt;ï¼šæœåŠ¡è¿‡æ»¤æ–¹æ¡ˆã€‚ å‚è€ƒä¸‹é¢çš„ç±»å…³ç³»å›¾ï¼Œå¯ä»¥æœ‰ä¸€ä¸ªæ›´å¥½çš„å°è±¡ï¼š IRuleè´Ÿè½½å‡è¡¡ç­–ç•¥æŽ¥å£ï¼Œå¯èƒ½æœ€å¸¸éœ€è¦é…ç½®çš„å°±æ˜¯å®ƒäº†ï¼Œé…ç½®ä¹Ÿæ²¡ä»€ä¹ˆç‰¹æ®Šçš„ï¼Œå°±ä»¥ Spring å¸¸ç”¨çš„æ–¹å¼å³å¯ã€‚é€šå¸¸æƒ…å†µä¸‹ Ribbon åŽŸç”Ÿçš„å‡ ä¸ªè´Ÿè½½å‡è¡¡ç­–ç•¥åº”è¯¥å¯ä»¥æ»¡è¶³ç”Ÿäº§è¦æ±‚ï¼ˆå½“ç„¶ä½ ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ï¼‰ï¼Œæ¥äº†è§£ä¸€ä¸‹ï¼š AbstractLoadBalancerRule é¡¶çº§çš„æŠ½è±¡ç±»ï¼Œç»™äºˆäº†èŽ·å¾— LoadBalancer çš„æ–¹æ³•ï¼Œå¯ä»¥è®©å­ç±»èŽ·å¾—è´Ÿè½½å‡è¡¡å™¨çš„ä¸€äº›ä¿¡æ¯ï¼Œå®šåˆ¶æ›´å…·ä½“çš„ç®—æ³•ã€‚ RandomRule é€šè¿‡ LoadBalancer èŽ·å–å¯ç”¨çš„æœåŠ¡å®žä¾‹ï¼Œå¹¶éšæœºæŒ‘é€‰ã€‚ï¼ˆä¸€ç›´æ— å¯å®žä¾‹æ—¶æœ‰æ— é™å¾ªçŽ¯ bugï¼‰ RoundRobinRule é€šè¿‡ LoadBalancer èŽ·å–å¯ç”¨çš„æœåŠ¡å®žä¾‹ï¼Œå¹¶è½®è¯¢é€‰æ‹©ã€‚ï¼ˆè¶…è¿‡ 10 æ¬¡å¤±è´¥æ—¶ï¼Œæ‰“å°æœºè­¦å‘Šå¹¶è¿”å›ž nullï¼‰ RetryRule é»˜è®¤æœ‰ä¸€ä¸ª RoundRobinRule çš„å­è§„åˆ™ï¼Œå’Œ 500 æ¯«ç§’çš„é˜ˆå€¼ã€‚ä½¿ç”¨å­è§„åˆ™é€‰æ‹©å®žä¾‹ï¼Œæ‰§è¡Œæ—¶é—´è‹¥è¶…è¿‡é˜ˆå€¼åˆ™è¿”å›ž nullã€‚ WeightedResponseTimeRule ç»§æ‰¿è‡ª RoundRobinRuleã€‚åœ¨æž„é€ æ—¶ä¼šå¯åŠ¨ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œé»˜è®¤æ¯ 30 ç§’æ‰§è¡Œä¸€æ¬¡ï¼Œæ¥è®¡ç®—æœåŠ¡å®žä¾‹çš„æƒé‡ã€‚åœ¨é»˜è®¤çš„ç®—æ³•ä¸‹ï¼Œå“åº”é€Ÿåº¦è¶Šå¿«çš„æœåŠ¡å®žä¾‹æƒé‡è¶Šå¤§ï¼Œè¶Šå®¹æ˜“è¢«é€‰æ‹©ã€‚ ClientConfigEnabledRoundRobinRule æœ¬èº«å®šä¹‰äº†ä¸€ä¸ª RoundRobinRule çš„å­è§„åˆ™ã€‚æœ¬ä¸”é»˜è®¤çš„ choose æ–¹æ³•ä¹Ÿæ˜¯æ‰§è¡Œ RoundRobinRule çš„å®žçŽ°ã€‚æœ¬èº«æ²¡æœ‰ç‰¹æ®Šç”¨å¤„ï¼Œè¿™ä¸ªé»˜è®¤ä¼šå®žçŽ°æ˜¯åœ¨å…¶å­ç±»çš„ç®—æ³•æ— æ³•å®žçŽ°æ—¶é‡‡ç”¨ï¼Œé€šå¸¸ä¼šé€‰æ‹©è¯¥ç±»ä½œçˆ¶ç±»ç»§æ‰¿ï¼Œå®žçŽ°è‡ªå®šä¹‰çš„è§„åˆ™ï¼Œä»¥ä¿è¯æ‹¥æœ‰ä¸€ä¸ªé»˜è®¤çš„è½®è¯¢è§„åˆ™ã€‚ BestAvaliableRule é€šè¿‡ LoadBalancerStats é€‰æ‹©å¹¶å‘è¯·æ±‚æœ€å°çš„å®žä¾‹ã€‚ PredicateBasedRule åˆ©ç”¨å­ç±»çš„ Predicate è¿‡æ»¤éƒ¨åˆ†æœåŠ¡å®žä¾‹åŽé€šè¿‡è½®è¯¢é€‰æ‹©ã€‚ AvailabilityFilteringRule è½®è¯¢é€‰æ‹©ä¸€ä¸ªæœåŠ¡å®žä¾‹ï¼Œåˆ¤æ–­æ˜¯å¦æ•…éšœï¼ˆæ–­è·¯å™¨æ–­å¼€ï¼‰ï¼Œå¹¶å‘è¯·æ±‚æ˜¯å¦å¤§äºŽé˜ˆå€¼ï¼ˆé»˜è®¤2^32-1ï¼Œå¯é€šè¿‡&lt;clientName&gt;.&lt;nameSpace&gt;.ActiveConnectionsLimit ä¿®æ”¹ï¼‰ã€‚å…è®¸åˆ™è¿”å›žï¼Œä¸å…è®¸åˆ™å†æ¬¡é€‰æ‹©ï¼Œå¤±è´¥ 10 æ¬¡åŽæ‰§è¡Œçˆ¶ç±»æ–¹æ¡ˆã€‚ ZoneAvoidanceRule ä½¿ç”¨ç»„åˆè¿‡æ»¤æ¡ä»¶æ‰§è¡Œè¿‡æ»¤ï¼Œæ¯æ¬¡è¿‡æ»¤åŽä¼šåˆ¤æ–­å®žä¾‹æ•°æ˜¯å¦å°äºŽæœ€å°å®žä¾‹æ•°ï¼ˆé»˜è®¤1ï¼‰ï¼Œæ˜¯å¦å¤§äºŽè¿‡æ»¤ç™¾åˆ†æ¯”ï¼ˆé»˜è®¤0ï¼‰ï¼Œä¸å†è¿‡æ»¤åŽä½¿ç”¨è½®è¯¢é€‰æ‹©ã€‚ å…·ä½“é…ç½®åœ¨é¡¹ç›®ä¸­æ˜¯å¯ä»¥é…ç½®å¤šä¸ª Ribbon å®¢æˆ·ç«¯çš„ï¼Œé€šå¸¸æ¥è¯´æ¯ä¸ªå®¢æˆ·ç«¯ç”¨æ¥è®¿é—®ä¸åŒçš„æœåŠ¡ã€‚æ¯”å¦‚ä¸ºè®¿é—® A æœåŠ¡çš„ Ribbon å®¢æˆ·ç«¯é…ç½®ä¸º A-Clientï¼ŒB æœåŠ¡ä¸º B-Clientã€‚ é€šè¿‡ä»£ç é…ç½®é¦–å…ˆæ¥ä»‹ç»é€šè¿‡æ³¨è§£é…ç½®çš„æ–¹æ³•ï¼Œåƒç®€å•çš„ Sring Bean é…ç½®ä¸€æ ·ï¼Œä¸è¿‡ä¸éœ€è¦ä½¿ç”¨ @Configuration æ³¨è§£äº†ã€‚åœ¨é…ç½®ç±»ä¸Šå¯ç”¨ @RibbonClientï¼Œç»™å®šå®¢æˆ·ç«¯çš„åç§°å’Œé…ç½®ç±»ï¼Œä½¿ç”¨ @Bean æ¥é…ç½®å…·ä½“çš„ç»„ä»¶å¦‚ IRule ç­‰ã€‚ 123456789101112131415@RibbonClient(name = "A-Client",configuration = ARibbonConfig.class)public class ARibbonConfig &#123; // æœåŠ¡å®žä¾‹çš„åœ°å€ String listOfServers = "http://127.0.0.1:8081,http://127.0.0.1:8082"; @Bean public ServerList&lt;Server&gt; ribbonServerList() &#123; List&lt;Server&gt; list = Lists.newArrayList(); if (!Strings.isNullOrEmpty(listOfServers)) &#123; for (String s: listOfServers.split(",")) &#123; list.add(new Server(s.trim())); &#125; &#125; return new StaticServerList&lt;Server&gt;(list); &#125;&#125; å®˜æ–¹æ–‡æ¡£ä¸Šæç¤ºäº†ä¸€ä¸ªå‘ï¼Œä¸èƒ½æŠŠåŠ äº†é…ç½®æ³¨è§£çš„å…·ä½“çš„é…ç½®ç±»æ”¾åœ¨ @ComponentScan è·¯å¾„ä¸‹ï¼Œå¦åˆ™å…ˆæ‰«æåˆ°çš„ä¸€ä¸ªå…·ä½“çš„å®¢æˆ·ç«¯é…ç½®ä¼šæˆä¸º Ribbon çš„å…¨å±€é…ç½®ã€‚ è¿™æ€Žä¹ˆèƒ½å¿ï¼Ÿå½“ç„¶å¾—æœ‰æ›´ä¼˜é›…çš„è§£å†³æ–¹å¼ï¼šå…¨å±€é…ç½®çš„æ–¹æ¡ˆã€‚ä½¿ç”¨ @RibbonClients æ³¨è§£ï¼Œä¸€æ¬¡å¯ä»¥æè¿°å¤šä¸ªå®¢æˆ·ç«¯é…ç½®ç±»çš„ä½ç½®ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥æŒ‡å®šé»˜è®¤é…ç½®ç±»ï¼Œå¦‚ï¼š 12345678910@SpringCloudApplication@RibbonClients(value = &#123; @RibbonClient(name = "A-Client",configuration = ARibbonConfig.class), @RibbonClient(name = "B-Client",configuration = BRibbonConfig.class)&#125;, defaultConfiguration = DefaultConfig.class)public class DemoServiceApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(DemoServiceApplication.class, args); &#125;&#125; è¿™æ ·é…ç½®å¯ä»¥ä¸éœ€è¦å†åœ¨é…ç½®ç±»ä¸ŠåŠ ä¸Šæ³¨è§£äº†ï¼Œä¹Ÿå¯ä»¥ä¸éœ€è¦å°†é…ç½®ç±»ç§»å‡ºåŒ…æ‰«æè·¯å¾„ã€‚ é€šè¿‡é…ç½®æ–‡ä»¶æŒ‡å®šä½†æ˜¯ä»¥ä¸Šè¿™æ ·çš„ä»£ç é…ç½®è¿˜æ˜¯ç¨æ˜¾å¤æ‚ï¼Œåœ¨ç›®å‰çš„ SpringCloud ä¸­ Ribbon çš„é…ç½®å¯ä»¥ç›´æŽ¥ SpringBoot çš„é…ç½®æ–‡ä»¶ä¸­å†™å…¥ï¼Œä½¿ç”¨å¦‚ä¸‹çš„æ–¹å¼æŒ‡å®šè¦é…ç½®çš„å‚æ•°ï¼š &lt;nameSpace&gt;.&lt;key&gt;=&lt;value&gt; é»˜è®¤çš„å‘½åç©ºé—´æ˜¯ ribbonï¼Œä¾‹å¦‚å®šä¹‰è¿žæŽ¥è¶…æ—¶æ—¶é—´å¯ä»¥ï¼š ribbon.connectTimeout=120 è€Œå½“éœ€è¦ä¸ºå…·ä½“çš„å®¢æˆ·ç«¯é…ç½®æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ï¼š &lt;client&gt;.&lt;nameSpace&gt;.&lt;key&gt;=&lt;value&gt; æ¯”å¦‚ï¼š user-service.ribbon.listOfServers=localhost:8001,localhost:8002 å…³äºŽ ribbon æ‰€æœ‰çš„å‚æ•°åç§°ï¼Œå¯ä»¥å‚çœ‹ com.netfix.client.config.CommonClientConfigKey&lt;T&gt;ã€‚ ä¸Ž Eureka æ•´åˆåŽçš„é…ç½®åœ¨ä½¿ç”¨ Eureka çš„æ—¶å€™ï¼Œä¼šæ”¹å˜ Ribbon ä¸€äº›ç»„ä»¶çš„é»˜è®¤å®žçŽ°ï¼Œå¦‚ï¼š ServerList -&gt; DiscoveryEnabledNIWSServerListï¼šç”± Eureka æ¥ç»´æŠ¤æœåŠ¡åˆ—è¡¨ IPing -&gt; NIWSDiscoveryPingï¼šç”± Eureka æµ‹è¯•æœåŠ¡å­˜æ´»ï¼ˆåŽŸé…çš„ DummyPing å¹¶ä¸ä¼š pingï¼Œè€Œæ˜¯å§‹ç»ˆè¿”å›ž trueï¼‰ è€Œä¸”é’ˆå¯¹ä¸åŒæœåŠ¡ä¸éœ€è¦æ˜¾ç¤ºåœ°é…ç½®ä¸ä¸€æ ·çš„å®¢æˆ·ç«¯åç§°äº†ï¼Œåªéœ€è¦ä½¿ç”¨ &lt;serviceName&gt;.&lt;nameSpace&gt;.&lt;key&gt;=&lt;value&gt; å¦‚ user-serviceï¼š user-service.ribbon.ReadTimeout=120 åŒæ—¶ç”±äºŽ SpringCloud Ribbon é»˜è®¤å®žçŽ°åŒºåŸŸäº²å’Œç­–ç•¥ï¼Œzone çš„é…ç½®ä¹Ÿååˆ†ç®€å•ï¼Œåªéœ€è¦åŠ å…¥å…ƒæ•°æ®é›†ä¸­å³å¯ï¼Œå¦‚ï¼š eureka.instance.metadataMap.zone=huzhou å¦‚æžœä¸éœ€è¦ Eureka è¾…åŠ© Ribbon çš„è‡ªåŠ¨é…ç½®ï¼ˆè¿™ä¸å¤ªå¯èƒ½å§ï¼‰ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ï¼š ribbon.eureka.enable=false è¿™æ—¶å€™ï¼Œè®°å¾—è‡ªå·±å¾—æ‰‹åŠ¨é…ç½® listOfServers ç­‰å‚æ•°äº†ã€‚]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>SpringCloud</tag>
        <tag>Ribbon</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æ­£åˆ™ç¬”è®°]]></title>
    <url>%2F2018%2F06%2F%E6%AD%A3%E5%88%99%E7%AC%94%E8%AE%B0%2F</url>
    <content type="text"><![CDATA[æ—¥å¸¸å¼€å‘ä¸­ï¼Œç»å¸¸éœ€è¦è¿›è¡Œä¸€äº›æ–‡æœ¬å¤„ç†ï¼Œè¿™é€šå¸¸æ˜¯ååˆ†ç¹çè€Œæ— è¶£çš„ã€‚å­¦ä¼šå¹¶åˆ©ç”¨æ­£åˆ™è¡¨è¾¾å¼å¯ä»¥å¿«é€Ÿè§£å†³è¿™ç±»æ–‡æœ¬å¤„ç†é—®é¢˜ï¼Œæ— è®ºæ˜¯åœ¨ Javaï¼ŒPython ç­‰ä»£ç ä¸­æŠ‘æˆ–æ˜¯ shell çŽ¯å¢ƒä¸‹ã€‚æ­£åˆ™ä¸­å­˜åœ¨å¾ˆå¤šç»†å°çš„çŸ¥è¯†ç‚¹ï¼Œååˆ†å®¹æ˜“é—å¿˜ï¼Œç€æ‰‹è®°å½•ï¼ŒçŸ¥è¯†æ•´ç†è¿˜æ˜¯æœ‰æ‰€å¿…è¦ã€‚ æœ¬æ–‡ä»¥æ‹“å±•æ­£åˆ™è¿›è¡Œæè¿°ï¼Œéƒ¨åˆ†ç‰¹æ®Šå­—ç¬¦å’Œå®šå€æ–¹å¼åœ¨æ ‡å‡†æ­£åˆ™ä¸‹æ— æ•ˆã€‚å¦‚éœ€åœ¨ shell çŽ¯å¢ƒä¸‹ä½¿ç”¨ï¼Œéœ€è¦é¢å¤–ä½¿ç”¨â€˜\â€™ç¬¦å·ï¼Œæˆ–å¼€å¯æ‹“å±•æ­£åˆ™çš„æ”¯æŒï¼Œå¦‚ grep -eï¼Œsed -r ç­‰ã€‚ è§„åˆ™æ­£åˆ™è¡¨è¾¾å¼çš„è§„åˆ™å¯ä»¥ç®€å•ç†è§£ä¸ºï¼šåœ¨ç»™å®šçš„èŒƒå›´å†…ï¼Œç»™å®šçš„å­—ç¬¦é‡å¤ç»™å®šçš„æ¬¡æ•°ã€‚ æŒ‡å®šéœ€è¦åŒ¹é…çš„å­—ç¬¦ç»å¤§éƒ¨åˆ†çš„å­—ç¬¦ï¼ŒåŒ…æ‹¬æ•°å­—å­—æ¯æ±‰å­—ç­‰ï¼Œéƒ½å¯ä»¥ç›´æŽ¥è¾“å…¥æ¥æè¿°ã€‚ è½¬ä¹‰åŽç‰¹æ®Šå­—ç¬¦ä»¥ä¸‹å‡ ä¸ªå­—ç¬¦ç”±è½¬ä¹‰ç¬¦â€˜\â€™å’ŒæŸä¸ªå­—ç¬¦ç»„æˆï¼Œå¯ä»¥è¡¨è¿°æˆæ–°å­—ç¬¦ï¼Œä»–ä»¬æœ‰ç€ç‰¹æ®Šçš„å«ä¹‰ã€‚ \n è¿™æ˜¯ä¸€ä¸ªæ¢è¡Œç¬¦ã€‚ \t åˆ¶è¡¨ç¬¦ï¼ŒTab é”®çš„ç¼©è¿›ã€‚ \v åž‚ç›´åˆ¶è¡¨ç¬¦ã€‚ \f åˆ†é¡µç¬¦ï¼Œäº§ç”Ÿä¸€ä¸ªæ–°é¡µã€‚ \r è¿™æ˜¯å›žè½¦ç¬¦ \s è¿™ä¸ªè¡¨è¾¾å¯ä»¥è¡¨è¿°æ‰€æœ‰çš„ç©ºç™½å­—ç¬¦ï¼Œå³ä»¥ä¸Šäº”ç§å­—ç¬¦æˆ–è€…ç©ºæ ¼ã€‚ \cx å½“ x å–å€¼è‹±æ–‡å­—ç¬¦æ—¶ï¼Œè¿™ä¸ªæ•´ä½“å°±æœ‰äº†ç‰¹æ®Šæ„ä¹‰ï¼Œä¼šæ˜ å°„æˆä¸€ä¸ªæŽ§åˆ¶å­—ç¬¦ï¼Œå¦‚ \cM ç­‰ä»·äºŽ \r å³å›žè½¦ç¬¦å·ã€‚ \ux å¯ä»¥åŒ¹é… Unicode å­—ç¬¦ï¼Œå¦‚ \u00CDã€‚ \nx åœ¨ x å€¼åˆæ³•çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥åŒ¹é…å…«è¿›åˆ¶ä¸“ä¸€å€¼ï¼ˆåœ¨æ²¡æœ‰é¡ºåˆ©å–å¾—ç¼“å­˜å¼•ç”¨æ—¶ï¼‰ \b è¡¨ç¤ºå­—ç¬¦è¾¹ç•Œï¼Œå¯ä»¥ç†è§£ä¸ºæ‰“æ–­å•è¯æˆ–ç€æ±‰å­—è¿žç»­çš„ç©ºæ ¼/ç¬¦å·ä¹‹ç±»ï¼ˆå…¶å®žå®ƒå¹¶ä¸èƒ½åŒ¹é…åˆ°æŸä¸ªå­—ç¬¦ï¼Œä»…ä»…æ˜¯åŒ¹é…åˆ°äº†è¾¹ç•Œï¼‰ \d è¡¨ç¤ºæ•°å­—ï¼ŒåŒ [0-9]ã€‚ \w è¡¨ç¤ºä»»æ„å­—ç±»å­—ç¬¦ï¼Œå³æ•°å­—å­—æ¯å’Œä¸‹åˆ’çº¿ï¼Œé€šå¸¸è¿˜æ”¯æŒæ±‰å­—ã€‚ \&lt; åŒ¹é…å•è¯é¦–ï¼Œæ¯”å¦‚ \&lt;wo å¯ä»¥åŒ¹é… woodï¼Œword ç­‰ã€‚ \&gt; åŒç†åŒ¹é…å•è¯å°¾éƒ¨ã€‚ åŽŸç”Ÿç‰¹æ®Šå­—ç¬¦ä»¥ä¸‹çš„å­—ç¬¦å¹¶ä¸éœ€è¦è½¬ç§»ç¬¦â€˜\â€™ï¼Œå¤©ç„¶çš„æ‹¥æœ‰ç‰¹æ®Šå«ä¹‰ï¼ˆä»¥æ‹“å±•æ­£åˆ™ä¸ºå‡†ï¼‰ã€‚ $ å°¾éƒ¨ï¼Œè¡¨ç¤ºå­—ç¬¦ä¸²ç»“å°¾ä½ç½®ã€‚ ^ å¤´éƒ¨ï¼Œå­—ç¬¦ä¸²çš„å¼€å¤´ä½ç½®ï¼Œä½†åœ¨ [ ] å†…ä½¿ç”¨æ—¶è¡¨ç¤ºå–å [ ] å·¦å³ä¸­æ‹¬å·ï¼Œç”¨æ¥è¡¨è¾¾åŒ¹é…å•ä¸ªå­—ç¬¦æ—¶å€™çš„å¯é€‰èŒƒå›´ { } å·¦å³èŠ±æ‹¬å·ï¼Œç”¨æ¥è¡¨è¿°å‰ä¸€è¡¨è¾¾å¼çš„å¯é‡å¤åŒºé—´ ( ) å·¦å³å°æ‹¬å·ï¼Œç±»ä¼¼æ•°å­¦ä¸­çš„æ¦‚å¿µï¼Œå¯ä»¥æè¿°ä¸€ä¸ªè¡¨è¾¾å¼å¹¶æé«˜è®¡ç®—ä¼˜å…ˆçº§ï¼ŒåŒæ—¶ä¼šç¼“å­˜åŒ¹é…ç»“æžœã€‚ Â· ç‚¹å·ï¼Œå¯ä»¥ç”¨äº†åŒ¹é…ä»»æ„çš„ä¸€ä¸ªå­—ç¬¦ï¼Œé™¤äº† \n å§ã€‚ * æ˜Ÿå·ï¼Œå¯ä»¥åŒ¹é…å‰é¢è¡¨è¾¾å¼ä»»æ„æ¬¡æ•°ã€‚ + åŠ å·ï¼ŒåŒ¹é…å‰é¢è¡¨è¾¾å¼ä¸€è‡³ä»»æ„æ¬¡æ•°. ? é—®å·ï¼ŒåŒ¹é…å‰é¢è¡¨è¾¾å¼ 0 ~ 1 æ¬¡ã€‚ \ è½¬ç§»ç¬¦æœ¬èº«ï¼Œç”¨æ¥è½¬ç§»å…¶ä»–å­—ç¬¦ï¼Œéœ€è¦åŒ¹é…å®ƒæœ¬èº«çš„æ—¶å€™è‡ªç„¶éœ€è¦ \\ çš„å½¢å¼ã€‚ | æˆ–è¿ç®—ç¬¦å·ï¼Œä»»æ„åŒ¹é…å‰åŽè¡¨è¾¾å¼ä¹‹ä¸€ã€‚ [:digit:] æ‰€æœ‰æ•°å­— [:lower:] æ‰€æœ‰å°å†™å­—æ¯ [:upper:] æ‰€æœ‰å¤§å†™å­—æ¯ [:alpha:] æ‰€æœ‰å­—æ¯ [:alnum:] æ‰€æœ‰å­—æ¯åŠæ•°å­— [:space:] æ‰€æœ‰ç©ºç™½ç¬¦ [:punct:] æ‰€æœ‰æ ‡ç‚¹ç¬¦å· æŒ‡å®šåŒ¹é…å­—ç¬¦çš„å€™é€‰èŒƒå›´åŒ¹é…ä¸€ä¸ªå•å­—ç¬¦å¾ˆç®€å•ï¼Œä½†æ˜¯é€šå¸¸æˆ‘ä»¬éœ€è¦åŒ¹é…å‡ ä¸ªå­—ç¬¦ä¸­çš„ä»»æ„ä¸€ä¸ªï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ä¸€ä¸ªå€™é€‰èŒƒå›´çš„æè¿°ã€‚é™¤äº†ä½¿ç”¨ \w è¡¨ç¤ºå­—ç±»å­—ç¬¦ï¼Œ\s æ¥è¡¨ç¤ºç©ºç™½ç¬¦ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨ [ ] æ–¹æ‹¬å·æ¥æè¿°èŒƒå›´ï¼Œæ¥çœ‹å‡ ä¸ªä¾‹å­ï¼š [abc] å®ƒå¯ä»¥æ˜¯åŒ¹é… aï¼Œä¹Ÿå¯ä»¥æ˜¯ bï¼Œä¹Ÿå¯ä»¥æ˜¯ cã€‚ 5[48]k å®ƒå¯ä»¥æ˜¯ 54kï¼Œä¹Ÿå¯ä»¥æ˜¯ 58kã€‚ [0-9]\w å®ƒå¯ä»¥ä½¿æ˜¯ 0aï¼Œ3bï¼Œ33 ç­‰ç­‰ã€‚ è¿™æ ·ä¸€çœ‹æ˜¯ä¸æ˜¯å¾ˆå®¹æ˜“ï¼Ÿæ¥çœ‹ä¸€äº›è¿›é˜¶æŠ€å·§ï¼š å–åã€‚è¡¨è¿°èŒƒå›´çš„ç¬¦å·å¯ä»¥é€šè¿‡å¤§å†™æ¥è¡¨ç¤ºå–åï¼Œ\S è¡¨ç¤ºéžç©ºç™½å­—ç¬¦ï¼Œ\B è¡¨ç¤ºéžå­—ç¬¦è¾¹ç•Œï¼Œ\W è¡¨ç¤ºéžå­—ç±»å­—ç¬¦ã€‚å¯¹äºŽä½¿ç”¨ [ ] çš„åœºåˆï¼Œä½¿ç”¨ [^ ] æ¥å®Œæˆå–åã€‚ [ ] æ–¹æ‹¬å·ä¸­é—´ä¸å†èƒ½ä½¿ç”¨ä¸Šè¿°ç‰¹æ®Šçš„å­—ç¬¦ï¼Œæ¯”å¦‚ [x*]ï¼Œ* ä¸å†åŒ¹é…ä»»æ„æ¬¡ xï¼Œè¿™ä¸ªè¡¨è¾¾å¼åªèƒ½åŒ¹é… * æˆ– xï¼›åŒç†æ¯”å¦‚ï¼š[\s] è¡¨ç¤º \ æˆ–è€… sã€‚ [ ] ä¸­å¯ä»¥ä½¿ç”¨ä¸€äº›ç‰¹å®šçš„èŒƒå›´ï¼Œæ¯”å¦‚ 0-9ï¼Œa-zï¼ŒA-Zã€‚æ¯”å¦‚å¼å­ [0-9A-Z] ä¹Ÿæ˜¯åˆç†çš„ï¼Œä¼šåŒ¹é…æ•°å­—æˆ–è€…å¤§å†™å­—æ¯ï¼Œå¦‚éœ€è¦åŒ¹é…â€˜-â€™ï¼Œå°½é‡å†™åœ¨æœ€åŽã€‚ æŒ‡å®šè¡¨è¾¾å¼çš„é‡å¤æ¬¡æ•°åœ¨éœ€è¦é‡å¤ä¸€ä¸ªç‰¹å®šçš„æ­£åˆ™è¡¨è¾¾å¼çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨é™å®šç¬¦æè¿°é‡å¤æ¬¡æ•°æ¥ç®€åŒ–å®ƒã€‚ {n} åŒ¹é… n æ¬¡ï¼Œå¦‚ C{3} å³ CCCã€‚ {n,} åŒ¹é…å¤§äºŽç­‰äºŽ n æ¬¡ã€‚å¦‚ C{1,} ç­‰åŒäºŽ C+ {n,m} åŒ¹é…å¤§äºŽç­‰äºŽ n æ¬¡ï¼Œå°äºŽç­‰äºŽ m æ¬¡ï¼Œé—­åŒºé—´ã€‚ * ç­‰åŒäºŽ {0,} + ç­‰åŒäºŽ {1,} ? ç­‰åŒäºŽ {0,1} åˆ©ç”¨æ­£åˆ™åŒ¹é…çš„ç¼“å­˜ \num ä½¿ç”¨ ( ) ä¹‹åŽä¼šè¿›è¡ŒåŒ¹é…å€¼çš„ç¼“å­˜ï¼Œå¯ä»¥ç´§è·Ÿç€ \num æŒ‡å®šåŒ¹é…çš„å­é¡¹ï¼Œæ¯”å¦‚ (.)\1 å¯ä»¥åŒ¹é…ä»»æ„ä¸¤ä¸ªç›¸åŒçš„å­—ç¬¦ã€‚æˆ–è€…åœ¨ sedï¼Œvim ç­‰å·¥å…·ä½¿ç”¨æ›¿æ¢æ“ä½œæ—¶ï¼Œå¯ä»¥åœ¨æ–°å­—ç¬¦ä¸²ä¸Šä½¿ç”¨ \num ä»¥æœŸè¾¾åˆ°ç²¾ç¡®çš„åŒ¹é…ä½†æ˜¯å±€éƒ¨æ›¿æ¢çš„æ•ˆæžœã€‚ (?:pattern) ä½¿ç”¨è¯¥ç¬¦å·ä¼šå–æ¶ˆåŒ¹é…å€¼çš„ç¼“å­˜ (?=pattern) æ­£å‘è‚¯å®šé¢„æŸ¥ï¼Œä½¿ç”¨è¯¥ç¬¦å·ä¼šå–æ¶ˆåŒ¹é…å€¼çš„ç¼“å­˜ï¼ŒåŒæ—¶é¢„æŸ¥ä¹Ÿæ˜¯ä¸æ¶ˆè€—å­—ç¬¦çš„ã€‚ (?!pattern) åå‘é¢„æŸ¥ï¼Œç›¸åäºŽå‰è€…]]></content>
      <categories>
        <category>shell</category>
      </categories>
      <tags>
        <tag>Regex</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[è™šæ‹Ÿæœºä¸­çš„é”è†¨èƒ€]]></title>
    <url>%2F2018%2F06%2F%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%AD%E7%9A%84%E9%94%81%E8%86%A8%E8%83%80%2F</url>
    <content type="text"><![CDATA[å°½ç®¡å½“ä¸‹å‡ ä¹Žæ‰€æœ‰çš„æœåŠ¡å™¨çŽ¯å¢ƒéƒ½ä»¥é›†ç¾¤ä¸ºä¸»ï¼Œåœ¨è€ƒè™‘å¹¶å‘é—®é¢˜çš„æ—¶å€™é€šå¸¸ä¼šä½¿ç”¨åˆ†å¸ƒå¼æŠ€æœ¯,å¦‚ redis ç­‰ä¸­é—´ä»¶æ¥ç»´æŠ¤å…¨å±€çš„èµ„æºå’Œé”ã€‚ä½†æ˜¯å¯¹äºŽä¸€äº›å®žä¾‹å±‚é¢ä¸Šçš„èµ„æºï¼Œä¾æ—§éœ€è¦ä½¿ç”¨ä¼ ç»Ÿçš„é”æ¥ç»´æŠ¤ã€‚æ‰€ä»¥æˆ‘è§‰å¾—ï¼Œç†è§£ JVM å¯¹é”çš„å¤„ç†è¿˜æ˜¯æœ‰ä»·å€¼çš„ã€‚ JVMä¸Šé’ˆå¯¹é”çš„å¤„ç†ï¼ˆè¿™é‡Œåªæè¿°å†…éƒ¨é”ï¼Œå³ synchronized çš„å¤„ç†æƒ…å†µï¼‰ï¼Œé™¤äº†æœ‰è‡ªæ—‹é”ï¼Œé”ç²—åŒ–ï¼Œé”æ¶ˆé™¤ç­‰ç®€å•çš„è‡ªåŠ¨ä¼˜åŒ–æœºåˆ¶ï¼ˆä¸æŽ¢è®¨å•¦ï¼‰ï¼Œè¿˜å¯ä»¥ä»Žé”çš„ç»´æŠ¤çš„è§’åº¦åŽ»çœ‹ï¼Œå¯ä»¥åˆ†ä¸ºåå‘é”ï¼Œè½»é‡çº§é”ï¼Œé‡é‡çº§é”ã€‚ä¸‰è€…çš„å¼€é”€æ˜¯é€’å¢žçš„ï¼Œæ¼”å˜é¡ºåºä¹Ÿæ˜¯é€’å¢žçš„ï¼Œè€Œä¸”ä¸å¯é€†ã€‚å¦‚è½»åž‹çš„é”å¯ä»¥è†¨èƒ€å‡çº§è‡³é‡åž‹é”ï¼Œä½†æ˜¯ä¸å¯ä»¥ä»Žé‡åž‹çš„é”é™çº§ã€‚ ä¹‹æ‰€ä»¥æœ‰ä¸åŒç¨‹åº¦çš„é”çš„å¤„ç†æ–¹å¼ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸€ä¸ªåœºæ™¯ï¼šå¦‚æžœåœ¨é€»è¾‘ä¸ŠæŸä¸€æ—¶é—´åŸºæœ¬åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œä¼šè®¿é—®ç”±æŸä¸ªé”å¯¹è±¡æŽ§åˆ¶çš„åŒæ­¥å—ï¼Œå¾ˆå¤šæ—¶å€™ä¸å­˜åœ¨èµ„æºå¾ç”¨çš„é—®é¢˜ã€‚é‚£ä¹ˆåœ¨è¿™ä¸ªæ—¶å€™ï¼Œå¾ˆå¤šæ—¶å€™ä¸Šé”è§£é”çš„å¼€é”€å°±æ˜¾å¾—ç¹çè€Œä½Žæ•ˆäº†ã€‚ä»¥é‡é‡çº§é”ï¼ˆä¹Ÿæ˜¯ synchronized çš„æœ€ç»ˆå½¢æ€ï¼‰ä¸ºä¾‹ï¼Œå–é”è¿‡ç¨‹éœ€è¦æ“ä½œç³»ç»Ÿçš„ä»‹å…¥ï¼Œä½¿çº¿ç¨‹ä»Žç”¨æˆ·æ€è¿›å…¥æ ¸å¿ƒæ€ï¼Œå¼€é”€è¿˜æ˜¯æŒºå¤§çš„ã€‚æ‰€ä»¥ä¸€å¼€å§‹ JVM ä¼šå¯¹é”åšåå‘é”å¤„ç†ï¼Œåœ¨ä¸€äº›æ¡ä»¶ä¸‹å‡è‡³è½»é‡çº§é”ä¹ƒè‡³é‡é‡çº§é”ã€‚ å‰ç½®æ¦‚å¿µåœ¨é˜è¿°é”è†¨èƒ€ä¹‹å‰ï¼Œå…ˆæ’å…¥å‡ ä¸ªå†…å®¹ç‚¹ï¼Œå¯¹è±¡å¤´å’Œè‡ªæ—‹é”ã€‚ å¯¹è±¡å¤´åœ¨ HotSpot è™šæ‹Ÿæœºä¸­ï¼Œå¯¹è±¡åœ¨å†…å­˜ä¸­å­˜å‚¨çš„å¸ƒå±€å¯ä»¥åˆ†ä¸ºä¸‰å—åŒºåŸŸï¼šå¯¹è±¡å¤´ï¼ˆHeaderï¼‰ã€å®žä¾‹æ•°æ®ï¼ˆInstance Dataï¼‰å’Œå¯¹é½å¡«å……ï¼ˆPaddingï¼‰ã€‚ å®žä¾‹æ•°æ®å†…å®¹å’Œå¯¹é½å¡«å……ä¸åœ¨èµ˜è¿°ï¼Œè¯´è¯´å¯¹è±¡å¤´ï¼Œè¿™å°±ç±»ä¼¼ä¸€ä¸ªå¯¹è±¡çš„å…ƒä¿¡æ¯ï¼Œå…¶ä¸­ä¹Ÿåˆ†ä¸ºä¸‰éƒ¨åˆ†ç»„æˆï¼šæ ‡è®°å­—æ®µ Mark Wordï¼Œç±»åž‹æŒ‡é’ˆ Class Pointerï¼Œæ•°ç»„é•¿åº¦ Array Lengthï¼ˆå¦‚æžœè¯¥å¯¹è±¡æ˜¯æ•°ç»„ï¼Œåˆ™è®°å½•äº†æ•°ç»„é•¿åº¦ï¼‰ï¼Œä¸‰ç»„æ•°æ®åˆ†åˆ«ç”¨ä¸€ä¸ªå­—é•¿æ¥å­˜å‚¨ï¼ˆ32ä½æœºä¸Šä¸º32bitï¼Œ64ä½æœºä½64bitï¼‰ã€‚ ç±»åž‹æŒ‡é’ˆï¼šåœ¨è™šæ‹ŸæœºåŠ è½½ç±»çš„æ—¶å€™ï¼Œé™¤äº†ä¼šåœ¨å…ƒç©ºé—´/æ–¹æ³•åŒºå­˜å‚¨ç±»ä¿¡æ¯ï¼Œä¹Ÿä¼šåœ¨å †åŒºç”Ÿæˆä¸€ä¸ª Class å¯¹è±¡ã€‚ç±»åž‹æŒ‡é’ˆï¼Œä¾¿æ˜¯ä¸ºä¸€ä¸ªå®žä¾‹å¯¹è±¡æŒ‡å‘ Class å¯¹è±¡çš„æŒ‡é’ˆã€‚ æ ‡è®°å­—æ®µï¼šåœ¨è¿™ä¸€ä¸ªå­—çš„åŒºåŸŸå†…ï¼Œæè¿°äº†å¾ˆå¤šä¿¡æ¯ã€‚é€šå¸¸ä¸€ä¸ªå¯¹è±¡ä¼šæœ‰å…¶å“ˆå¸Œç ï¼Œå¹´ä»£æ ‡è®°ï¼ˆç»åŽ† GC æ¬¡æ•°ï¼‰ï¼Œé”æ ‡è¯†ç­‰ã€‚ä½†æ˜¯å¦‚æžœè¯¥å¯¹è±¡å……å½“äº†ä¸€ä¸ªä¸Šé”å¯¹è±¡ï¼Œæƒ…å†µä¼šæœ‰æ‰€ä¸åŒï¼Œä¸‹æ–‡è¯¦è¿°ã€‚ è‡ªæ—‹é”é€šå¸¸æ¥è¯´ï¼Œå–é”æ—¶å€™å¦‚æžœæœªèƒ½èŽ·å¾—é”ï¼Œçº¿ç¨‹ä¼šè¿›å…¥é˜»å¡žçŠ¶æ€ï¼ˆBlockingï¼‰ï¼ŒåŒæ—¶ä¼šè®©çº¿ç¨‹è¿›å…¥ç­‰å¾…é˜Ÿåˆ—/åŒæ­¥å—çš„å…¥å£é›†ä¸­ï¼Œå¹¶å¯¼è‡´ä¸€ä¸ªä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå‡ºè®© CPU èµ„æºã€‚æˆ‘ä»¬å¯ä»¥å®žçŽ°ä¸€ä¸ªå¿™è½®è¯¢çš„æœºåˆ¶æ¥å°è¯•èŽ·å¾—é”ã€‚æ¯”å¦‚ä½¿ç”¨ä¸€ä¸ªçŠ¶æ€å¯¹è±¡æ¥ä»£æ›¿é”ï¼Œä½¿ç”¨ä¸€ä¸ªå¾ªçŽ¯æ¥åˆ¤æ–­çŠ¶æ€æ˜¯å¦æœªå¯ç”¨ï¼Œå¦‚ä¸‹æ˜¯ä»£ç å±‚é¢çš„å®žçŽ°ã€‚1234567volatile boolean flag = false;while(true) &#123; if(flag) &#123; // do something break; &#125;&#125; è¿™å¯ä»¥é¿å…åœ¨é¦–æ¬¡å–å¾—é”å¤±è´¥çš„æ—¶å€™ç›´æŽ¥çº¿ç¨‹åˆ‡å‡ºï¼Œåœ¨åŒæ­¥é€»è¾‘å¤„ç†é‡è¾ƒå°‘çš„æ—¶å€™å¯ä»¥å¸¦æ¥æ˜Žæ˜¾çš„æ•ˆçŽ‡æå‡ï¼Œä½†æ˜¯å¦‚æžœå¦‚æžœè¯´â€œåŒæ­¥å—â€çš„å¤„ç†æ—¶é—´å¾ˆé•¿ï¼Œæˆ–è€…åœ¨â€œåŒæ­¥å—â€å†…çš„çº¿ç¨‹å‘ç”Ÿå¼‚å¸¸æœªèƒ½æ›´æ”¹çŠ¶æ€é‡ï¼Œå°†ä¸¥é‡æŸå¤±æ€§èƒ½ä¹ƒè‡³å‘ç”Ÿæ›´ä¸¥é‡çš„æ­»é”ã€‚ æ‰€ä»¥è‡ªæ—‹é”é€‚åˆåŒæ­¥é€»è¾‘çš„å¤„ç†æ—¶é—´å¾ˆçŸ­çš„åœºåˆï¼ˆå‡ ä¸ªå¾ªçŽ¯å†…èƒ½æ‹¿åˆ°é”ï¼‰ é”è†¨èƒ€è¿‡ç¨‹ä¸­çš„ä¸‰ä¸ªé˜¶æ®µçŽ°åœ¨å·²ç»äº†è§£äº†å¯¹è±¡åœ¨å †ä¸­çš„å­˜å‚¨å½¢å¼ï¼Œä»¥åŠä¾é è‡ªæ—‹å¯ä»¥åœ¨çŸ­æ—¶é—´å†…å‡å°‘åŠ é”å¼€é”€ã€‚ç»§ç»­æ·±å…¥ JVM ä¸­ä¸åŒå¹¶å‘ç¨‹åº¦ä¸‹é”çš„ä¸åŒçš„æœºåˆ¶ã€‚ åå‘é”åå‘é”æ˜¯åœ¨ JDK 1.5ï¼Ÿ1.6 ä¹‹åŽå¯¹é”è¿›è¡Œçš„ä¼˜åŒ–ã€‚å…ˆæ¥çœ‹ä¸€ä¸ªå›¾ï¼š å‰æ–‡æåˆ°è¿‡ï¼Œå¦‚æžœä¸€ä¸ªçº¿ç¨‹ç»å¸¸èŽ·å¾—é”ï¼Œä¸”èµ„æºäº‰ç”¨ä¸ä¸¥é‡ï¼Œé‚£ä¹ˆå¯ä»¥å°½é‡å‡å°‘å–é”çš„å¼€é”€ã€‚JDK æ˜¯è¿™ä¹ˆåšçš„ï¼šåœ¨ä¸€ä¸ªçº¿ç¨‹èŽ·å¾—é”çš„æ—¶å€™ï¼Œä¼šåœ¨æ ˆå¸§è®°å½•ä¸­ä»¥åŠé”å¯¹è±¡çš„æ ‡è®°å­—æ®µä¸­å†™å…¥çº¿ç¨‹ idï¼Œåœ¨è¯¥çº¿ç¨‹è¿›å…¥/ç¦»å¼€åŒæ­¥å—çš„æ—¶å€™ä¸éœ€è¦é¢å¤–çš„é”å¼€é”€ï¼Œè¿™é‡Œç”šè‡³ä¸éœ€è¦ CAS æ“ä½œï¼Œå› ä¸ºåªéœ€è¦æ¯”è¾ƒæ ‡è®°å­—æ®µä¸­çš„çº¿ç¨‹ id ä¸Žè‡ªèº«æ˜¯å¦ä¸€è‡´ã€‚å¦‚æžœåœ¨å°è¯•èŽ·å¾—é”çš„æ—¶å€™å‘çŽ°æ ‡è®°å­—æ®µä¸­çš„çº¿ç¨‹ id ä¸Žè‡ªèº«ä¸ä¸€è‡´ï¼Œä¼šå°è¯•åˆ©ç”¨ CAS æ“ä½œæ¥äº‰æŠ¢è¿™ä¸ªåå‘é”ã€‚ è¡¥å……ï¼šåå‘é”æ˜¯é»˜è®¤å¯ç”¨çš„ï¼Œä½†æ˜¯å®ƒåœ¨åº”ç”¨ç¨‹åºå¯åŠ¨å‡ ç§’é’Ÿä¹‹åŽæ‰æ¿€æ´»ï¼Œå¦‚æœ‰å¿…è¦å¯ä»¥ä½¿ç”¨ JVM å‚æ•°æ¥å…³é—­å»¶è¿Ÿ -XX:BiasedLockingStartupDelay=0ã€‚å¦‚æžœä½ ç¡®å®šè‡ªå·±åº”ç”¨ç¨‹åºé‡Œæ‰€æœ‰çš„é”é€šå¸¸æƒ…å†µä¸‹å¤„äºŽç«žäº‰çŠ¶æ€ï¼Œç”šè‡³å¯ä»¥é€šè¿‡ JVM å‚æ•°å…³é—­åå‘é” -XX:-UseBiasedLocking=falseï¼Œé‚£ä¹ˆæ‰€æœ‰çš„å†…éƒ¨é”éƒ½ä¼šç›´æŽ¥è¿›å…¥è½»é‡çº§é”çŠ¶æ€ã€‚ è½»é‡çº§é”çº¿ç¨‹åœ¨æ‰§è¡ŒåŒæ­¥å—ä¹‹å‰ï¼ŒJVM ä¼šå…ˆåœ¨å½“å‰çº¿ç¨‹çš„æ ˆæ¡¢ä¸­åˆ›å»ºç”¨äºŽå­˜å‚¨é”è®°å½•çš„ç©ºé—´ï¼Œå¹¶å°†å¯¹è±¡å¤´ä¸­çš„æ ‡è®°å­—æ®µå¤åˆ¶åˆ°é”è®°å½•ä¸­ã€‚ç„¶åŽçº¿ç¨‹å°è¯•ä½¿ç”¨ CAS å°†å¯¹è±¡å¤´ä¸­çš„æ ‡è®°å­—æ®µæ›¿æ¢ä¸ºæŒ‡å‘é”è®°å½•çš„æŒ‡é’ˆã€‚å¦‚æžœæˆåŠŸï¼Œå½“å‰çº¿ç¨‹èŽ·å¾—é”ï¼›å¦‚æžœå¤±è´¥ï¼Œåˆ™è¿›è¡Œè‡ªæ—‹æ¥èŽ·å–é”ï¼Œå½“è‡ªæ—‹èŽ·å–é”ä»ç„¶å¤±è´¥æ—¶ï¼Œè¡¨ç¤ºç«žäº‰ä¸¥é‡ï¼ˆä¸¤æ¡æˆ–ä¸¤æ¡ä»¥ä¸Šçš„çº¿ç¨‹ç«žäº‰åŒä¸€ä¸ªé”ï¼‰ï¼Œåˆ™è½»é‡çº§é”ä¼šè†¨èƒ€æˆé‡é‡çº§é”ã€‚ é‡é‡çº§é”é‡é‡çº§é”å…¶å®žæ‰æ˜¯é€šå¸¸æ¶‰åŠçš„é”æ¦‚å¿µï¼Œè¿™æ—¶å€™å®ƒå·²ç»æ˜¯ä¸€ä¸ªå½»åº•çš„æ‚²è§‚é”äº†ã€‚åœ¨ JVM ä¸­åˆå«å¯¹è±¡ç›‘è§†å™¨ï¼Œå®ƒè‡³å°‘åŒ…å«ä¸€ä¸ªç«žäº‰é”çš„é˜Ÿåˆ—ï¼Œå’Œä¸€ä¸ªä¿¡å·é˜»å¡žé˜Ÿåˆ—ï¼ˆwaité˜Ÿåˆ—ï¼‰ï¼Œå‰è€…è´Ÿè´£åšäº’æ–¥ï¼ŒåŽä¸€ä¸ªç”¨äºŽåšçº¿ç¨‹åŒæ­¥ã€‚ å‚è€ƒ ã€ŠJavaå¤šçº¿ç¨‹ç¼–ç¨‹å®žæˆ˜æŒ‡å—ã€‹ é»„æ–‡æµ· ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ å‘¨å¿—æ˜Ž https://www.cnblogs.com/wade-luffy/p/5969418.html https://blog.csdn.net/wolegequdidiao/article/details/45116141]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>å¹¶å‘</tag>
        <tag>JVM</tag>
      </tags>
  </entry>
</search>
